<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrate LocalStorage to Database</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover { background: #0056b3; }
        #log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Migrate LocalStorage to Database</h1>
    <p>This will transfer all data from localStorage to the database. Click the button below to start migration.</p>
    
    <button onclick="migrateData()">Start Migration</button>
    
    <div id="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `status ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function migrateData() {
            log('Starting migration...', 'info');
            
            try {
                // Migrate business info
                const businessInfo = {
                    name: 'Birria Fusion',
                    phone: localStorage.getItem('businessPhone') || '',
                    email: localStorage.getItem('businessEmail') || '',
                    address: localStorage.getItem('businessAddress') || '',
                    website: localStorage.getItem('businessWebsite') || '',
                    facebook: localStorage.getItem('businessFacebook') || '',
                    instagram: localStorage.getItem('businessInstagram') || '',
                    default_margin: parseFloat(localStorage.getItem('defaultMargin') || '30')
                };
                
                if (businessInfo.phone || businessInfo.email) {
                    await fetch('/api/business-info', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(businessInfo)
                    });
                    log('✓ Business info migrated', 'success');
                }

                // Migrate settings (categories, units, statuses, roles)
                const settings = {
                    menuCategories: localStorage.getItem('menuCategories'),
                    supplierCategories: localStorage.getItem('supplierCategories'),
                    measurementUnits: localStorage.getItem('measurementUnits'),
                    eventStatuses: localStorage.getItem('eventStatuses'),
                    fileCategories: localStorage.getItem('fileCategories'),
                    employeeRoles: localStorage.getItem('employeeRoles'),
                    theme: localStorage.getItem('theme')
                };
                
                for (const [key, value] of Object.entries(settings)) {
                    if (value) {
                        await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key, value })
                        });
                    }
                }
                log('✓ Settings migrated', 'success');

                // Migrate recipes
                const menuItems = await fetch('/api/menu').then(r => r.json());
                for (const item of menuItems) {
                    const recipeKey = `recipe-${item.id}`;
                    const ingredients = localStorage.getItem(recipeKey);
                    if (ingredients) {
                        await fetch('/api/recipes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                menu_id: item.id,
                                ingredients: JSON.parse(ingredients)
                            })
                        });
                    }
                }
                log('✓ Recipes migrated', 'success');

                // Migrate licenses
                const licenses = JSON.parse(localStorage.getItem('licenses') || '[]');
                for (const license of licenses) {
                    await fetch('/api/licenses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(license)
                    });
                }
                if (licenses.length > 0) {
                    log(`✓ ${licenses.length} licenses migrated`, 'success');
                }

                // Migrate maintenance tasks
                const tasks = JSON.parse(localStorage.getItem('maintenanceTasks') || '[]');
                for (const task of tasks) {
                    await fetch('/api/maintenance-tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(task)
                    });
                }
                if (tasks.length > 0) {
                    log(`✓ ${tasks.length} maintenance tasks migrated`, 'success');
                }

                // Migrate files metadata
                const files = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
                for (const file of files) {
                    await fetch('/api/files', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(file)
                    });
                }
                if (files.length > 0) {
                    log(`✓ ${files.length} files migrated`, 'success');
                }

                log('✓ Migration completed successfully!', 'success');
                log('You can now close this page and return to the main application.', 'info');
                
            } catch (error) {
                log(`✗ Migration error: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
