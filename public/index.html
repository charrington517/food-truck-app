<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birria Fusion - Food Truck Manager</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --orange: #ff6b35;
            --orange-dark: #e55a2b;
            --charcoal: #2c2c2c;
            --white: #ffffff;
            --gray: #666666;
            --gray-light: #f8f8f8;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --border: #e0e0e0;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

        [data-theme="dark"] {
            --white: #1a1a1a;
            --gray-light: #2c2c2c;
            --charcoal: #ffffff;
            --gray: #cccccc;
            --border: #404040;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--white);
            color: var(--charcoal);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--orange) 0%, var(--orange-dark) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            gap: 10px;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            white-space: nowrap;
            flex: 1;
        }

        .hamburger-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            backdrop-filter: blur(10px);
        }

        .hamburger-btn:hover {
            background: var(--orange-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--border);
            padding: 15px 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 12px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--gray);
            font-size: 12px;
            font-weight: 600;
            background: none;
            border: none;
            min-width: 60px;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--orange);
            background: rgba(255, 107, 53, 0.1);
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .section {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        #settings .section {
            padding: 10px;
            margin-bottom: 5px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--charcoal);
            border-bottom: 2px solid var(--orange);
            padding-bottom: 10px;
        }

        .form {
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .btn {
            background: var(--orange);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            background: var(--orange-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-secondary {
            background: var(--charcoal);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.2s ease;
            color: var(--charcoal);
        }
        
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        
        .file-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: var(--orange);
        }
        
        .file-thumbnail {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            border-radius: 6px;
            object-fit: cover;
        }
        
        .file-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            background: var(--orange);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
        }
        
        .file-name {
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 4px;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .file-meta {
            font-size: 0.7em;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .file-actions {
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        
        .file-actions .btn {
            padding: 4px 8px;
            font-size: 0.7em;
            width: auto;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: var(--orange);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--charcoal);
        }

        .card-meta {
            color: var(--gray);
            font-size: 13px;
            margin-bottom: 6px;
        }

        .card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .card-actions .btn {
            padding: 6px 12px;
            font-size: 13px;
            width: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: var(--charcoal);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 800;
            color: var(--orange);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }

        .extra-menu {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .extra-menu.show {
            display: flex;
        }

        .extra-menu button {
            background: none;
            border: none;
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            color: var(--charcoal);
            font-size: 14px;
            white-space: nowrap;
        }

        .extra-menu button:hover {
            background: var(--orange);
            color: white;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--orange);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .settings-content {
            display: none;
            margin-top: 5px;
        }

        .settings-content .form {
            margin: 0;
        }

        .settings-content .form-group {
            margin-bottom: 5px;
        }

        .settings-content .form-row {
            margin-bottom: 5px;
        }

        .settings-content.show {
            display: block;
        }

        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #ff6b35 !important;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            z-index: 999;
            transition: all 0.2s ease;
        }

        .fab:hover {
            background: #e55a2b !important;
            transform: scale(1.1);
        }
        
        #fabBtn {
            background: #ff6b35 !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--charcoal);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--orange) 0%, var(--orange-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            background: var(--white);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
        }

        .login-form input:focus {
            border-color: var(--orange);
            outline: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media print {
            .nav, .fab, .btn, button, .modal, .page-header button {
                display: none !important;
            }
            body {
                background: white;
                color: black;
            }
            .container {
                padding: 20px;
                max-width: 100%;
            }
            .card {
                page-break-inside: avoid;
                border: 1px solid #000;
                margin-bottom: 20px;
            }
            .print-only {
                display: block !important;
            }
        }
        .print-only {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <img src="/uploads/1763192867406_birria-fusion-logo.png" alt="Logo" class="login-logo">
            <h1 style="color: var(--orange); margin-bottom: 30px;">Birria Fusion</h1>
            <div class="login-form">
                <div id="loginSection">
                    <input type="text" id="loginUsername" placeholder="Username" style="margin-bottom: 15px;">
                    <input type="password" id="loginPassword" placeholder="Password" style="margin-bottom: 20px;">
                    <button class="btn" onclick="attemptLogin()" style="width: 100%; margin-bottom: 15px;">Login</button>
                    <button class="btn" onclick="showEmployeeRegistration()" style="width: 100%; background: var(--success); margin-bottom: 15px;">New Employee? Register Here</button>
                </div>
                <div id="registerSection" style="display: none;">
                    <input type="text" id="regName" placeholder="Your Full Name" style="margin-bottom: 10px;">
                    <select id="regRole" style="margin-bottom: 10px;">
                        <option value="">Select your role...</option>
                        <option value="Cook">Cook</option>
                        <option value="Cashier">Cashier</option>
                        <option value="Prep Cook">Prep Cook</option>
                        <option value="Server">Server</option>
                        <option value="Driver">Driver</option>
                        <option value="Cleaner">Cleaner</option>
                    </select>
                    <input type="text" id="regUsername" placeholder="Create Username" style="margin-bottom: 10px;">
                    <input type="password" id="regPassword" placeholder="Create Password" style="margin-bottom: 10px;">
                    <input type="email" id="regEmail" placeholder="Email (optional)" style="margin-bottom: 10px;">
                    <input type="tel" id="regPhone" placeholder="Phone (optional)" style="margin-bottom: 15px;">
                    <button class="btn" onclick="registerEmployee()" style="width: 100%; margin-bottom: 10px;">Register</button>
                    <button class="btn" onclick="showLogin()" style="width: 100%; background: var(--gray);">Back to Login</button>
                </div>
                <div id="loginError" style="color: var(--danger); font-size: 14px; text-align: center; margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <div class="header-content">
                <img src="/uploads/1763192867406_birria-fusion-logo.png" alt="Logo" class="logo">
                <h1>Birria Fusion</h1>
                <div style="display: flex; gap: 3px; flex-shrink: 0;">
                    <button class="hamburger-btn" onclick="openCalendar()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M3 10h18M8 2v4M16 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button class="hamburger-btn" onclick="openSearch()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button class="hamburger-btn" onclick="showPage('settings')">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="section">
                <h2 class="section-title">Business Overview</h2>
                <div class="stats" id="dashboardStats"></div>
            </div>

            <div class="section">
                <h2 class="section-title">Upcoming Schedule</h2>
                <div class="grid" id="upcomingSchedule"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Top Items by Food Cost</h2>
                <div class="grid" id="topItems"></div>
            </div>
        </div>

        <!-- Menu Page -->
        <div id="menu" class="page">


            <div class="section">
                <h2 class="section-title">Menu Items</h2>
                <div class="grid" id="menuItems"></div>
            </div>
        </div>

        <!-- Ingredients Page -->
        <div id="ingredients" class="page">


            <div class="section">
                <h2 class="section-title">Ingredients</h2>
                <div class="grid" id="ingredientsList"></div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventory" class="page">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">Current Inventory</h2>
                    <button class="btn" onclick="openBarcodeScanner()" style="padding: 8px 16px; font-size: 0.9em; width: auto; background: var(--success);">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 5px;">
                            <path d="M2 6h2v12H2V6zm4 0h1v12H6V6zm2 0h2v12H8V6zm3 0h1v12h-1V6zm2 0h3v12h-3V6zm4 0h1v12h-1V6zm2 0h2v12h-2V6z"/>
                        </svg>
                        Scan Barcode
                    </button>
                </div>
                <div class="grid" id="inventoryList"></div>
            </div>
        </div>

        <!-- Suppliers Page -->
        <div id="suppliers" class="page">


            <div class="section">
                <h2 class="section-title">Suppliers</h2>
                <div class="grid" id="suppliersList"></div>
            </div>
        </div>

        <!-- Employee Page -->
        <div id="employee" class="page">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2em;">Employee Time Clock</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--gray-light); padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">Punch In/Out</h4>
                        <select id="employeeSelect" style="width: 100%; margin-bottom: 10px;">
                            <option value="">Select employee...</option>
                        </select>
                        <button class="btn" onclick="toggleEmployeeStatus()" id="clockBtn" style="width: 100%; padding: 10px;">Punch In</button>
                        <div id="currentStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
                    </div>
                </div>
                
                <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
                    <h4 onclick="toggleEmployeeList()" style="margin: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">Employee List <span id="emplist-icon">▼</span></h4>
                    <div id="employeeListContainer" style="display: none; margin-top: 15px;">
                        <button class="btn" onclick="toggleAddEmployeeInList()" style="width: 100%; margin-bottom: 15px; background: var(--orange); color: white;">+ Add Employee</button>
                        <div id="add-employee-form" style="display: none; background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative;">
                            <button onclick="toggleAddEmployeeInList()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); line-height: 1;">&times;</button>
                            <input type="text" id="newEmployeeName" placeholder="Employee Name" style="width: 100%; margin-bottom: 8px;">
                            <select id="newEmployeeRole" style="width: 100%; margin-bottom: 8px;">
                                <option value="">Select role...</option>
                            </select>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="newEmployeeUsername" placeholder="Username" style="width: 100%;">
                                <input type="password" id="newEmployeePassword" placeholder="Password" style="width: 100%;">
                            </div>
                            <input type="email" id="newEmployeeEmail" placeholder="Email" style="width: 100%; margin-bottom: 8px;">
                            <input type="tel" id="newEmployeePhone" placeholder="Phone" style="width: 100%; margin-bottom: 8px;">
                            <input type="text" id="newEmployeeAddress" placeholder="Address" style="width: 100%; margin-bottom: 8px;">
                            <textarea id="newEmployeeNotes" placeholder="Notes" rows="2" style="width: 100%; margin-bottom: 8px;"></textarea>
                            
                            <div style="background: var(--gray-light); padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                <h5 style="margin: 0 0 8px 0;">Access Permissions:</h5>
                                
                                <!-- Dashboard -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('dashboard')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Dashboard</strong>
                                        <span id="dashboard-perm-icon">▼</span>
                                    </div>
                                    <div id="dashboard-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Dashboard</div><div><input type="checkbox" id="perm-dashboard-read" checked disabled></div><div><input type="checkbox" id="perm-dashboard-write" checked disabled></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Menu -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('menu')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Menu</strong>
                                        <span id="menu-perm-icon">▼</span>
                                    </div>
                                    <div id="menu-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Recipes</div><div><input type="checkbox" id="perm-menu-view-read"></div><div><input type="checkbox" id="perm-menu-view-write" disabled></div>
                                            <div>Add Recipes</div><div><input type="checkbox" id="perm-menu-add-read" disabled></div><div><input type="checkbox" id="perm-menu-add-write"></div>
                                            <div>Edit Recipes</div><div><input type="checkbox" id="perm-menu-edit-read" disabled></div><div><input type="checkbox" id="perm-menu-edit-write"></div>
                                            <div>Delete Recipes</div><div><input type="checkbox" id="perm-menu-delete-read" disabled></div><div><input type="checkbox" id="perm-menu-delete-write"></div>
                                            <div>View Costs</div><div><input type="checkbox" id="perm-menu-costs-read"></div><div><input type="checkbox" id="perm-menu-costs-write" disabled></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ingredients -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('ingredients')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Ingredients</strong>
                                        <span id="ingredients-perm-icon">▼</span>
                                    </div>
                                    <div id="ingredients-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Ingredients</div><div><input type="checkbox" id="perm-ingredients-view-read"></div><div><input type="checkbox" id="perm-ingredients-view-write" disabled></div>
                                            <div>Add Ingredients</div><div><input type="checkbox" id="perm-ingredients-add-read" disabled></div><div><input type="checkbox" id="perm-ingredients-add-write"></div>
                                            <div>Edit Ingredients</div><div><input type="checkbox" id="perm-ingredients-edit-read" disabled></div><div><input type="checkbox" id="perm-ingredients-edit-write"></div>
                                            <div>Delete Ingredients</div><div><input type="checkbox" id="perm-ingredients-delete-read" disabled></div><div><input type="checkbox" id="perm-ingredients-delete-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Inventory -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('inventory')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Inventory</strong>
                                        <span id="inventory-perm-icon">▼</span>
                                    </div>
                                    <div id="inventory-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Inventory</div><div><input type="checkbox" id="perm-inventory-view-read"></div><div><input type="checkbox" id="perm-inventory-view-write" disabled></div>
                                            <div>Add Items</div><div><input type="checkbox" id="perm-inventory-add-read" disabled></div><div><input type="checkbox" id="perm-inventory-add-write"></div>
                                            <div>Edit Stock Levels</div><div><input type="checkbox" id="perm-inventory-edit-read" disabled></div><div><input type="checkbox" id="perm-inventory-edit-write"></div>
                                            <div>Delete Items</div><div><input type="checkbox" id="perm-inventory-delete-read" disabled></div><div><input type="checkbox" id="perm-inventory-delete-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Suppliers -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('suppliers')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Suppliers</strong>
                                        <span id="suppliers-perm-icon">▼</span>
                                    </div>
                                    <div id="suppliers-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Suppliers</div><div><input type="checkbox" id="perm-suppliers-view-read"></div><div><input type="checkbox" id="perm-suppliers-view-write" disabled></div>
                                            <div>Add Suppliers</div><div><input type="checkbox" id="perm-suppliers-add-read" disabled></div><div><input type="checkbox" id="perm-suppliers-add-write"></div>
                                            <div>Edit Suppliers</div><div><input type="checkbox" id="perm-suppliers-edit-read" disabled></div><div><input type="checkbox" id="perm-suppliers-edit-write"></div>
                                            <div>Delete Suppliers</div><div><input type="checkbox" id="perm-suppliers-delete-read" disabled></div><div><input type="checkbox" id="perm-suppliers-delete-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Employee -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('employee')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Employee</strong>
                                        <span id="employee-perm-icon">▼</span>
                                    </div>
                                    <div id="employee-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>Time Clock</div><div><input type="checkbox" id="perm-timeclock-read" checked disabled></div><div><input type="checkbox" id="perm-timeclock-write" checked disabled></div>
                                            <div>Add Employees</div><div><input type="checkbox" id="perm-emp-add-read" disabled></div><div><input type="checkbox" id="perm-emp-add-write"></div>
                                            <div>View All Employees</div><div><input type="checkbox" id="perm-emp-view-read"></div><div><input type="checkbox" id="perm-emp-view-write" disabled></div>
                                            <div>Time Punch History</div><div><input type="checkbox" id="perm-punch-history-read"></div><div><input type="checkbox" id="perm-punch-history-write" disabled></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tools -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('tools')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Tools</strong>
                                        <span id="tools-perm-icon">▼</span>
                                    </div>
                                    <div id="tools-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Files</div><div><input type="checkbox" id="perm-tools-files-read"></div><div><input type="checkbox" id="perm-tools-files-write" disabled></div>
                                            <div>Upload Files</div><div><input type="checkbox" id="perm-tools-upload-read" disabled></div><div><input type="checkbox" id="perm-tools-upload-write"></div>
                                            <div>Cost Calculator</div><div><input type="checkbox" id="perm-tools-calc-read"></div><div><input type="checkbox" id="perm-tools-calc-write" disabled></div>
                                            <div>QR Generator</div><div><input type="checkbox" id="perm-tools-qr-read"></div><div><input type="checkbox" id="perm-tools-qr-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Catering -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('catering')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Catering</strong>
                                        <span id="catering-perm-icon">▼</span>
                                    </div>
                                    <div id="catering-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Orders</div><div><input type="checkbox" id="perm-catering-view-read"></div><div><input type="checkbox" id="perm-catering-view-write" disabled></div>
                                            <div>Add Orders</div><div><input type="checkbox" id="perm-catering-add-read" disabled></div><div><input type="checkbox" id="perm-catering-add-write"></div>
                                            <div>Edit Orders</div><div><input type="checkbox" id="perm-catering-edit-read" disabled></div><div><input type="checkbox" id="perm-catering-edit-write"></div>
                                            <div>Delete Orders</div><div><input type="checkbox" id="perm-catering-delete-read" disabled></div><div><input type="checkbox" id="perm-catering-delete-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Events -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('events')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Events</strong>
                                        <span id="events-perm-icon">▼</span>
                                    </div>
                                    <div id="events-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Events</div><div><input type="checkbox" id="perm-events-view-read"></div><div><input type="checkbox" id="perm-events-view-write" disabled></div>
                                            <div>Add Events</div><div><input type="checkbox" id="perm-events-add-read" disabled></div><div><input type="checkbox" id="perm-events-add-write"></div>
                                            <div>Edit Events</div><div><input type="checkbox" id="perm-events-edit-read" disabled></div><div><input type="checkbox" id="perm-events-edit-write"></div>
                                            <div>Delete Events</div><div><input type="checkbox" id="perm-events-delete-read" disabled></div><div><input type="checkbox" id="perm-events-delete-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Marketing -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('marketing')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Marketing</strong>
                                        <span id="marketing-perm-icon">▼</span>
                                    </div>
                                    <div id="marketing-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Reviews</div><div><input type="checkbox" id="perm-marketing-view-read"></div><div><input type="checkbox" id="perm-marketing-view-write" disabled></div>
                                            <div>Add Reviews</div><div><input type="checkbox" id="perm-marketing-add-read" disabled></div><div><input type="checkbox" id="perm-marketing-add-write"></div>
                                            <div>Respond to Reviews</div><div><input type="checkbox" id="perm-marketing-respond-read" disabled></div><div><input type="checkbox" id="perm-marketing-respond-write"></div>
                                            <div>Delete Reviews</div><div><input type="checkbox" id="perm-marketing-delete-read" disabled></div><div><input type="checkbox" id="perm-marketing-delete-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Analytics -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('analytics')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Analytics</strong>
                                        <span id="analytics-perm-icon">▼</span>
                                    </div>
                                    <div id="analytics-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>View Expenses</div><div><input type="checkbox" id="perm-analytics-expenses-read"></div><div><input type="checkbox" id="perm-analytics-expenses-write" disabled></div>
                                            <div>Add Expenses</div><div><input type="checkbox" id="perm-analytics-add-read" disabled></div><div><input type="checkbox" id="perm-analytics-add-write"></div>
                                            <div>Food Cost Analysis</div><div><input type="checkbox" id="perm-analytics-costs-read"></div><div><input type="checkbox" id="perm-analytics-costs-write" disabled></div>
                                            <div>Delete Expenses</div><div><input type="checkbox" id="perm-analytics-delete-read" disabled></div><div><input type="checkbox" id="perm-analytics-delete-write"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Settings -->
                                <div style="margin-bottom: 10px;">
                                    <div onclick="togglePermSection('settings')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 8px; border-radius: 4px;">
                                        <strong>Settings</strong>
                                        <span id="settings-perm-icon">▼</span>
                                    </div>
                                    <div id="settings-permissions" style="display: none; margin-top: 5px; padding: 5px;">
                                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 5px; font-size: 0.8em;">
                                            <div>Theme Settings</div><div><input type="checkbox" id="perm-theme-read"></div><div><input type="checkbox" id="perm-theme-write"></div>
                                            <div>Business Info</div><div><input type="checkbox" id="perm-business-read"></div><div><input type="checkbox" id="perm-business-write"></div>
                                            <div>Menu Categories</div><div><input type="checkbox" id="perm-categories-read"></div><div><input type="checkbox" id="perm-categories-write"></div>
                                            <div>Employee Roles</div><div><input type="checkbox" id="perm-roles-read"></div><div><input type="checkbox" id="perm-roles-write"></div>
                                            <div>Role Permissions</div><div><input type="checkbox" id="perm-permissions-read"></div><div><input type="checkbox" id="perm-permissions-write"></div>
                                            <div>Data Management</div><div><input type="checkbox" id="perm-data-read"></div><div><input type="checkbox" id="perm-data-write"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn" onclick="addEmployee()" style="width: 100%; padding: 8px;">Add Employee</button>
                        </div>
                        <div id="employeeList"></div>
                    </div>
                </div>
                
                <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px;">Current Status</h4>
                    <div id="employeeStatusList"></div>
                </div>
                <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 onclick="toggleTimePunches()" style="margin: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">Time Punch History <span id="punch-icon">▼</span></h4>
                    <div id="timePunchHistoryContainer" style="display: none; margin-top: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <select id="punchFilter" onchange="loadTimePunchHistory()" style="width: 100%; padding: 8px;">
                                <option value="all">All Employees</option>
                            </select>
                            <input type="date" id="punchDateFilter" onchange="loadTimePunchHistory()" style="width: 100%; padding: 8px;">
                        </div>
                        <button class="btn" onclick="printSchedule()" style="width: 100%; margin-bottom: 10px; background: #666; color: white;">Print</button>
                        <div id="timePunchHistory"></div>
                    </div>
                </div>
                
                <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 onclick="toggleAvailability()" style="margin: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">Employee Availability <span id="availability-icon">▼</span></h4>
                    <div id="availabilityContainer" style="display: none; margin-top: 15px;">
                        <select id="availabilityEmployee" onchange="loadEmployeeAvailability()" style="width: 100%; padding: 8px; margin-bottom: 15px;">
                            <option value="">Select employee...</option>
                        </select>
                        <div id="availabilityGrid"></div>
                    </div>
                </div>
                
                <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 onclick="toggleWeeklySchedule()" style="margin: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">Weekly Schedule <span id="schedule-icon">▼</span></h4>
                    <div id="weeklyScheduleContainer" style="display: none; margin-top: 15px;">
                        <div style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center;">
                            <button class="btn" onclick="previousWeek()" style="padding: 8px 12px; width: auto;">◀</button>
                            <input type="date" id="scheduleWeekStart" onchange="loadWeeklySchedule()" style="flex: 1; padding: 8px;">
                            <button class="btn" onclick="nextWeek()" style="padding: 8px 12px; width: auto;">▶</button>
                        </div>
                        <button class="btn" onclick="addShift()" style="width: 100%; margin-bottom: 10px; background: var(--orange); color: white;">+ Add Shift</button>
                        <button class="btn" onclick="printWeeklySchedule()" style="width: 100%; margin-bottom: 15px; background: #666; color: white;">Print</button>
                        <div id="weeklySchedule"></div>
                        <div id="overtimeAlerts" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Page -->
        <div id="tools" class="page">
            <div class="section">
                <h2 class="section-title">Archives</h2>
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.1em; margin-bottom: 10px;">Archived Events</h3>
                    <div class="grid" id="archivedEventsList"></div>
                </div>
                <div>
                    <h3 style="font-size: 1.1em; margin-bottom: 10px;">Archived Catering Orders</h3>
                    <div class="grid" id="archivedCateringList"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2em;">License Renewals</h3>
                    <button class="btn" onclick="addLicense()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Add License</button>
                </div>
                <div class="files-grid" id="licenseList"></div>
            </div>
            
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2em;">Maintenance Schedule</h3>
                    <button class="btn" onclick="addMaintenanceTask()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Add Task</button>
                </div>
                <div class="files-grid" id="maintenanceList"></div>
            </div>
            
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2em;">Cost Calculator</h3>
                </div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="background: var(--gray-light); border-radius: 8px;">
                        <h4 onclick="toggleCostSection('recipe')" style="margin: 0; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">Recipe Cost Calculator <span id="recipe-icon">▼</span></h4>
                        <div id="recipe-content" style="display: none; padding: 0 15px 15px 15px;">
                            <select id="recipeSelect" onchange="loadRecipeForCalculation()" style="width: 100%; margin-bottom: 10px;">
                                <option value="">Select a recipe...</option>
                            </select>
                            <div id="recipeCalculation"></div>
                        </div>
                    </div>
                    <div style="background: var(--gray-light); border-radius: 8px;">
                        <h4 onclick="toggleCostSection('portion')" style="margin: 0; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">Portion Cost Calculator <span id="portion-icon">▼</span></h4>
                        <div id="portion-content" style="display: none; padding: 0 15px 15px 15px;">
                            <input type="number" id="baseCost" placeholder="Base Recipe Cost ($)" step="0.01" style="width: 100%; margin-bottom: 8px;">
                            <input type="number" id="basePortions" placeholder="Base Portions" min="1" style="width: 100%; margin-bottom: 8px;">
                            <input type="number" id="newPortions" placeholder="New Portion Size" min="1" style="width: 100%; margin-bottom: 8px;">
                            <button class="btn" onclick="calculatePortionCost()" style="width: 100%; padding: 8px;">Calculate</button>
                            <div id="portionResult" style="margin-top: 10px; font-weight: bold;"></div>
                        </div>
                    </div>
                    <div style="background: var(--gray-light); border-radius: 8px;">
                        <h4 onclick="toggleCostSection('breakeven')" style="margin: 0; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">Event Break-Even Analysis <span id="breakeven-icon">▼</span></h4>
                        <div id="breakeven-content" style="display: none; padding: 0 15px 15px 15px;">
                            <input type="number" id="eventCosts" placeholder="Total Event Costs ($)" step="0.01" style="width: 100%; margin-bottom: 8px;">
                            <input type="number" id="avgItemPrice" placeholder="Average Item Price ($)" step="0.01" style="width: 100%; margin-bottom: 8px;">
                            <input type="number" id="avgItemCost" placeholder="Average Item Cost ($)" step="0.01" style="width: 100%; margin-bottom: 8px;">
                            <button class="btn" onclick="calculateBreakEven()" style="width: 100%; padding: 8px;">Calculate</button>
                            <div id="breakEvenResult" style="margin-top: 10px; font-weight: bold;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2em;">QR Code Generator</h3>
                </div>
                <div class="form" style="max-width: 500px;">
                    <div class="form-group">
                        <select id="qrType" onchange="updateQRPlaceholder()">
                            <option value="url">Website/Menu Link</option>
                            <option value="text">Text Message</option>
                            <option value="phone">Phone Number</option>
                            <option value="email">Email Address</option>
                            <option value="wifi">WiFi Network</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" id="qrContent" placeholder="Enter URL or text">
                    </div>
                    <div id="wifiFields" style="display: none;">
                        <div class="form-row">
                            <input type="text" id="wifiSSID" placeholder="Network Name (SSID)">
                            <input type="password" id="wifiPassword" placeholder="Password">
                        </div>
                    </div>
                    <button class="btn" onclick="generateQR()" style="width: auto; padding: 12px 24px;">Generate QR Code</button>
                </div>
                <div id="qrResult" style="text-align: center; margin-top: 20px;"></div>
            </div>
            
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2em;">Files</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="uploadFileCategory" style="padding: 8px; font-size: 0.9em;">
                            <option value="General">General</option>
                            <option value="Event Contracts">Event Contracts</option>
                            <option value="Catering Contracts">Catering Contracts</option>
                            <option value="Permits">Permits</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Images">Images</option>
                            <option value="Receipts">Receipts</option>
                            <option value="Other">Other</option>
                        </select>
                        <button class="btn" onclick="document.getElementById('fileUpload').click()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn" onclick="filterFiles('All')" id="filter-All" style="padding: 4px 8px; font-size: 0.8em; width: auto; margin-right: 5px; background: var(--orange);">All</button>
                    <button class="btn" onclick="filterFiles('General')" id="filter-General" style="padding: 4px 8px; font-size: 0.8em; width: auto; margin-right: 5px; background: var(--gray);">General</button>
                    <button class="btn" onclick="filterFiles('Event Contracts')" id="filter-Event Contracts" style="padding: 4px 8px; font-size: 0.8em; width: auto; margin-right: 5px; background: var(--gray);">Events</button>
                    <button class="btn" onclick="filterFiles('Catering Contracts')" id="filter-Catering Contracts" style="padding: 4px 8px; font-size: 0.8em; width: auto; margin-right: 5px; background: var(--gray);">Catering</button>
                    <button class="btn" onclick="filterFiles('Permits')" id="filter-Permits" style="padding: 4px 8px; font-size: 0.8em; width: auto; margin-right: 5px; background: var(--gray);">Permits</button>
                </div>
                <input type="file" id="fileUpload" style="display: none;" multiple accept="image/*,.pdf,.doc,.docx" onchange="uploadFileFromSection()">
                <div class="files-grid" id="filesList"></div>
            </div>
        </div>

        <!-- Catering Page -->
        <div id="catering" class="page">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">Catering Orders</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="printCatering()" style="padding: 8px 16px; font-size: 0.9em; width: auto; background: #666; color: white;">Print</button>
                        <button class="btn" onclick="addCateringOrder()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Add Order</button>
                    </div>
                </div>
                <div class="stats" id="cateringStats"></div>
                <div class="grid" id="cateringList"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Equipment & Rentals</h2>
                <div class="grid" id="toolsList"></div>
            </div>
        </div>

        <!-- Events Page -->
        <div id="events" class="page">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">Event Calendar</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="printEvents()" style="padding: 8px 16px; font-size: 0.9em; width: auto; background: #666; color: white;">Print</button>
                        <button class="btn" onclick="addEvent()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Add Event</button>
                    </div>
                </div>
                <div class="stats" id="eventStats"></div>
                <div class="grid" id="eventList"></div>
            </div>
        </div>

        <!-- Marketing Page -->
        <div id="marketing" class="page">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">⭐ Review Management</h2>
                    <button class="btn" onclick="addReview()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Add Review</button>
                </div>
                <div class="stats" id="reviewStats"></div>
                <div class="grid" id="reviewList"></div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">💰 Expense Tracking</h2>
                    <button class="btn" onclick="addExpense()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Add Expense</button>
                </div>
                <div class="stats" id="expenseStats"></div>
                <div class="grid" id="expenseList"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Food Cost Analysis</h2>
                <div class="stats" id="analyticsStats"></div>
            </div>
            <div class="section">
                <h2 class="section-title">Detailed Analysis</h2>
                <div class="grid" id="foodCostAnalysis"></div>
            </div>
        </div>

        <!-- Contacts Page -->
        <div id="contacts" class="page">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">Contacts</h2>
                    <button class="btn" onclick="addContact()" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Add Contact</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <select id="contactCategoryFilter" onchange="loadContacts()" style="padding: 8px; border-radius: 6px;">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div class="grid" id="contactsList"></div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="section">
                <button class="btn btn-danger" onclick="logout()" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px; vertical-align: middle;">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4m7 14l5-5-5-5m5 5H9"/>
                    </svg>
                    Sign Out
                </button>
            </div>
            
            <div class="section">
                <h2 class="section-title" onclick="toggleSettingsSection('profile')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    User Profile
                    <span id="profile-icon">▼</span>
                </h2>
                <div id="profile-content" class="settings-content">
                    <div class="form">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Name</label>
                            <input type="text" id="profileName" placeholder="Your Name">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Username</label>
                            <input type="text" id="profileUsername" disabled style="background: var(--gray-light);">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Confirm New Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password">
                        </div>
                        <button class="btn" onclick="updateUserProfile()">Save Changes</button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title" onclick="toggleSettingsSection('theme')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    Theme Settings
                    <span id="theme-icon">▼</span>
                </h2>
                <div id="theme-content" class="settings-content">
                    <div class="form">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="font-size: 16px; font-weight: 500;">Dark Mode</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="darkMode" onchange="toggleTheme()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title" onclick="toggleSettingsSection('business')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    Business Information
                    <span id="business-icon">▼</span>
                </h2>
                <div id="business-content" class="settings-content">
                    <div class="form">
                        <div class="form-group">
                            <input type="text" id="truckName" placeholder="Food Truck Name" value="Birria Fusion">
                        </div>
                        <div class="form-group">
                            <input type="text" id="businessPhone" placeholder="Phone Number">
                        </div>
                        <div class="form-group">
                            <input type="email" id="businessEmail" placeholder="Email Address">
                        </div>
                        <div class="form-group">
                            <input type="text" id="businessAddress" placeholder="Business Address">
                        </div>
                        <div class="form-group">
                            <input type="text" id="businessWebsite" placeholder="Website URL">
                        </div>
                        <div class="form-group">
                            <input type="text" id="businessFacebook" placeholder="Facebook URL">
                        </div>
                        <div class="form-group">
                            <input type="text" id="businessInstagram" placeholder="Instagram Handle">
                        </div>
                        <div class="form-group">
                            <label for="defaultMargin" style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Default Margin Percentage</label>
                            <input type="number" id="defaultMargin" placeholder="Default Margin %" min="0" max="100" step="0.1" onchange="saveDefaultMargin()">
                        </div>
                        <button class="btn" onclick="saveBusinessInfo()" style="background: var(--orange); color: white;">Save Business Info</button>
                    </div>
                </div>
            </div>
            
                        <div class="section">
                <h2 class="section-title" onclick="toggleSettingsSection('allCategories')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    Edit Categories
                    <span id="allCategories-icon">▼</span>
                </h2>
                <div id="allCategories-content" class="settings-content">
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('menuCategories')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Menu Categories</span>
                            <span id="menuCategories-arrow">▶</span>
                        </div>
                        <div id="menuCategories-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newCategory" placeholder="Add new category (e.g., Appetizers, Mains)" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addMenuCategory()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('menuCategories', JSON.stringify(['Entree','Appetizer','Dessert','Sauce','Side','Beverage'])); loadMenuCategories(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="categoriesList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('inventoryCategories')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Inventory Categories</span>
                            <span id="inventoryCategories-arrow">▶</span>
                        </div>
                        <div id="inventoryCategories-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newInventoryCategory" placeholder="Add new inventory category" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addInventoryCategory()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('inventoryCategories', JSON.stringify(['Food','Cleaning Supplies','To Go Supplies','Equipment','Other'])); loadInventoryCategories(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="inventoryCategoriesList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('supplierCategories')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Supplier Categories</span>
                            <span id="supplierCategories-arrow">▶</span>
                        </div>
                        <div id="supplierCategories-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newSupplierCategory" placeholder="Add new supplier category (e.g., Produce, Equipment)" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addSupplierCategory()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('supplierCategories', JSON.stringify(['Food','Equipment','Supplies','Other'])); loadSupplierCategories(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="supplierCategoriesList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('eventStatuses')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Event Status Categories</span>
                            <span id="eventStatuses-arrow">▶</span>
                        </div>
                        <div id="eventStatuses-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newEventStatus" placeholder="Add new status (e.g., Waitlisted, Confirmed)" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addEventStatus()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('eventStatuses', JSON.stringify(['Interested','Applied','Accepted','Accepted & Paid','Rejected','Completed'])); loadEventStatuses(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="eventStatusesList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('fileCategories')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>File Categories</span>
                            <span id="fileCategories-arrow">▶</span>
                        </div>
                        <div id="fileCategories-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newFileCategory" placeholder="Add new category (e.g., Invoices, Photos)" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addFileCategory()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('fileCategories', JSON.stringify(['General','Event Contracts','Catering Contracts','Permits','Insurance','Marketing','Images','Receipts','Other'])); loadFileCategories(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="fileCategoriesList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('employeeRoles')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Employee Roles</span>
                            <span id="employeeRoles-arrow">▶</span>
                        </div>
                        <div id="employeeRoles-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newEmployeeRoleInput" placeholder="Add new role (e.g., Assistant Manager, Dishwasher)" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addEmployeeRole()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('employeeRoles', JSON.stringify(['Cook','Cashier','Manager','Prep Cook','Server','Driver','Cleaner'])); loadEmployeeRoles(); updateEmployeeRoleDropdown(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="employeeRolesList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('contactCategories')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Contact Categories</span>
                            <span id="contactCategories-arrow">▶</span>
                        </div>
                        <div id="contactCategories-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newContactCategory" placeholder="Add new category (e.g., Venue, Photographer)" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addContactCategory()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('contactCategories', JSON.stringify(['General','Catering Client','Event Organizer','Vendor'])); loadContactCategories(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="contactCategoriesList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; cursor: pointer;" onclick="toggleCategorySection('units')">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 500;">
                            <span>Measurement Units</span>
                            <span id="units-arrow">▶</span>
                        </div>
                        <div id="units-section" style="display: none; margin-top: 15px;" onclick="event.stopPropagation()">
                            <div class="form-row">
                                <input type="text" id="newUnit" placeholder="Add new unit (e.g., cups, tbsp)" onclick="event.stopPropagation()">
                                <button class="btn" onclick="event.stopPropagation(); addMeasurementUnit()" style="width: auto; padding: 12px 20px;">Add</button>
                                <button class="btn" onclick="event.stopPropagation(); localStorage.setItem('measurementUnits', JSON.stringify(['lb','oz','kg','g','cups','tbsp','tsp','liters','ml','pieces','pack'])); loadMeasurementUnits(); alert('Restored!');" style="width: auto; padding: 12px 20px; background: var(--gray);">Restore Defaults</button>
                            </div>
                            <div id="unitsList" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div class="section">
                <h2 class="section-title" onclick="toggleSettingsSection('backup')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    Backup & Restore
                    <span id="backup-icon">▼</span>
                </h2>
                <div id="backup-content" class="settings-content">
                    <div class="form">
                        <div class="form-group">
                            <button class="btn" onclick="downloadBackup()" style="background: var(--success); width: 100%;">Download Database Backup</button>
                        </div>
                        <div class="form-group">
                            <input type="file" id="restoreFile" accept=".db" style="display: none;" onchange="uploadBackup()">
                            <button class="btn" onclick="document.getElementById('restoreFile').click()" style="background: var(--warning); width: 100%;">Upload & Restore Backup</button>
                        </div>
                        <div style="font-size: 0.85em; color: var(--gray); margin-top: 10px;">
                            <strong>Note:</strong> Backup includes all events, catering, contacts, menu items, and settings. Restore will replace current data.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title" onclick="toggleSettingsSection('data')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    Data Management
                    <span id="data-icon">▼</span>
                </h2>
                <div id="data-content" class="settings-content">
                    <div class="form">
                        <div class="form-row">
                            <button class="btn" onclick="exportData()" style="background: var(--success);">Export Data</button>
                            <button class="btn btn-danger" onclick="clearData()">Clear All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="fab" onclick="openAddModal()" id="fabBtn" title="Add new item" style="background: #ff6b35 !important; color: white !important;">+</button>

        <!-- Add Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Item</h3>
                <button class="close-btn" onclick="closeAddModal()">&times;</button>
            </div>
            <div id="modalForm"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="editModalTitle">Edit Item</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="form">
                <div class="form-group">
                    <input type="text" id="editInput" placeholder="Enter name">
                </div>
                <div class="form-row">
                    <button class="btn" onclick="saveEdit()" style="background: var(--orange);">Save</button>
                    <button class="btn btn-danger" onclick="deleteItem()" style="background: var(--danger);">Delete</button>
                    <button class="btn btn-secondary" onclick="closeEditModal()" style="background: #666666 !important; color: white !important;">Cancel</button>
                </div>
            </div>
        </div>

        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal" id="notesModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="notesModalTitle">Notes</h3>
                <button class="close-btn" onclick="closeNotesModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <textarea id="newNoteText" placeholder="Add a note..." rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px;"></textarea>
                </div>
                <button class="btn" onclick="addNote()" style="background: var(--orange); color: white; margin-bottom: 20px;">Add Note</button>
                <div id="notesList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div class="modal" id="calendarModal">
        <div class="modal-content" style="max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">Calendar</h3>
                <button class="close-btn" onclick="closeCalendar()">&times;</button>
            </div>
            <div style="padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button class="btn" onclick="previousMonth()" style="width: auto; padding: 8px 12px; font-size: 14px;">◀</button>
                    <h3 id="calendarMonthYear" style="margin: 0; font-size: 18px;"></h3>
                    <button class="btn" onclick="nextMonth()" style="width: auto; padding: 8px 12px; font-size: 14px;">▶</button>
                </div>
                <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;"></div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal" id="barcodeScannerModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Barcode Scanner</h3>
                <button class="close-btn" onclick="closeBarcodeScanner()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div id="barcodeScannerReader" style="width: 100%; margin-bottom: 15px;"></div>
                <div id="barcodeScanResult" style="margin-top: 15px;"></div>
                <button class="btn" onclick="closeBarcodeScanner()" style="width: 100%; background: var(--gray); margin-top: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="searchModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Search</h3>
                <button class="close-btn" onclick="closeSearch()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <input type="text" id="globalSearch" placeholder="Search events, catering, contacts, menu, employees..." style="width: 100%; padding: 12px; margin-bottom: 15px; font-size: 16px;" oninput="performSearch()">
                <div style="display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="filterSearchResults('all')" id="search-all" style="padding: 6px 12px; font-size: 0.85em; width: auto; background: var(--orange);">All</button>
                    <button class="btn" onclick="filterSearchResults('events')" id="search-events" style="padding: 6px 12px; font-size: 0.85em; width: auto; background: var(--gray);">Events</button>
                    <button class="btn" onclick="filterSearchResults('catering')" id="search-catering" style="padding: 6px 12px; font-size: 0.85em; width: auto; background: var(--gray);">Catering</button>
                    <button class="btn" onclick="filterSearchResults('contacts')" id="search-contacts" style="padding: 6px 12px; font-size: 0.85em; width: auto; background: var(--gray);">Contacts</button>
                    <button class="btn" onclick="filterSearchResults('menu')" id="search-menu" style="padding: 6px 12px; font-size: 0.85em; width: auto; background: var(--gray);">Menu</button>
                    <button class="btn" onclick="filterSearchResults('employees')" id="search-employees" style="padding: 6px 12px; font-size: 0.85em; width: auto; background: var(--gray);">Employees</button>
                </div>
                <div id="recentSearches" style="margin-bottom: 15px;"></div>
                <div id="searchResults" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-items">
            <button class="nav-item active" onclick="showPage('dashboard')">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span>Dashboard</span>
            </button>
            <button class="nav-item" onclick="showPage('menu')">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 7h14l-1-1H4l-1 1zm0 2h14v8a1 1 0 01-1 1H4a1 1 0 01-1-1V9zm2-4h10a1 1 0 011 1H4a1 1 0 011-1z"/>
                </svg>
                <span>Menu</span>
            </button>
            <button class="nav-item" onclick="showPage('ingredients')">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 2L3 7v11a1 1 0 001 1h12a1 1 0 001-1V7l-7-5zM6 9.5a.5.5 0 01.5-.5h7a.5.5 0 010 1h-7a.5.5 0 01-.5-.5zm0 2a.5.5 0 01.5-.5h7a.5.5 0 010 1h-7a.5.5 0 01-.5-.5z"/>
                </svg>
                <span>Ingredients</span>
            </button>
            <button class="nav-item" onclick="showPage('inventory')">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4zM3 8a1 1 0 000 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a1 1 0 100-2H3zm8 6a1 1 0 11-2 0 1 1 0 012 0z"/>
                </svg>
                <span>Inventory</span>
            </button>
            <button class="nav-item" onclick="showPage('suppliers')">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z"/>
                </svg>
                <span>Suppliers</span>
            </button>
            <button class="nav-item" onclick="toggleExtraMenu()">
                <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                </svg>
                <span>More</span>
            </button>
        </div>
        
        <div class="extra-menu" id="extraMenu">
            <button onclick="showPage('tools')">Tools</button>
            <button onclick="showPage('analytics')">Analytics</button>
            <button onclick="showPage('marketing')">Marketing</button>
            <button onclick="showPage('contacts')">Contacts</button>
            <button onclick="showPage('employee')">Employee</button>
            <button onclick="showPage('catering')">Catering</button>
            <button onclick="showPage('events')">Events</button>
        </div>
    </nav>

    <script>
        let currentPage = 'dashboard';
        let currentUser = null;
        let sessionTimeout = null;
        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes
        
        // Session management
        function resetSessionTimeout() {
            if (sessionTimeout) clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                alert('Session expired. Please log in again.');
                logout();
            }, SESSION_DURATION);
        }
        
        function extendSession() {
            if (currentUser) {
                resetSessionTimeout();
            }
        }
        
        // Add activity listeners to extend session
        document.addEventListener('click', extendSession);
        document.addEventListener('keypress', extendSession);
        document.addEventListener('scroll', extendSession);

        // Calendar Functions
        let currentCalendarDate = new Date();
        let calendarData = { events: [], catering: [], maintenance: [] };
        let calendarClickedItem = null;
        
        window.openCalendar = function() {
            document.getElementById('calendarModal').classList.add('show');
            loadCalendarData();
        }
        
        window.closeCalendar = function() {
            document.getElementById('calendarModal').classList.remove('show');
        }
        
        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }
        
        async function loadCalendarData() {
            const [events, catering, maintenance] = await Promise.all([
                fetch('/api/events').then(r => r.json()),
                fetch('/api/catering').then(r => r.json()),
                fetch('/api/maintenance').then(r => r.json()).catch(() => [])
            ]);
            
            calendarData = { events, catering, maintenance };
            renderCalendar();
        }
        
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div style="font-weight: bold; text-align: center; padding: 6px; background: var(--orange); color: white; border-radius: 4px; font-size: 12px;">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay; i++) {
                html += `<div style="background: var(--gray-light); border-radius: 4px; min-height: 80px;"></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                const dayEvents = calendarData.events.filter(e => e.date === dateStr);
                const dayCatering = calendarData.catering.filter(c => c.date === dateStr);
                const dayMaintenance = calendarData.maintenance.filter(m => m.date === dateStr);
                
                html += `<div style="background: var(--white); border: 1px solid ${isToday ? 'var(--orange)' : 'var(--border)'}; border-radius: 4px; padding: 4px; min-height: 80px; position: relative; overflow-y: auto;">`;
                html += `<div style="font-weight: bold; margin-bottom: 4px; color: ${isToday ? 'var(--orange)' : 'var(--charcoal)'}; font-size: 14px;">${day}</div>`;
                
                dayEvents.forEach(e => {
                    html += `<div onclick="calendarClickedItem={type:'event',id:${e.id}}; window.closeCalendar(); window.showPage('events');" style="background: #007bff; color: white; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; font-size: 10px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${e.name}\n${e.location || ''}\n${e.date} ${e.time || ''}">📅 ${e.name}</div>`;
                });
                
                dayCatering.forEach(c => {
                    html += `<div onclick="calendarClickedItem={type:'catering',id:${c.id}}; window.closeCalendar(); window.showPage('catering');" style="background: #28a745; color: white; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; font-size: 10px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${c.client}\n${c.guests} guests\n${c.date}\n$${c.price || 0}">🍽️ ${c.client}</div>`;
                });
                
                dayMaintenance.forEach(m => {
                    html += `<div onclick="calendarClickedItem={type:'maintenance',id:${m.id}}; window.closeCalendar(); window.showPage('tools');" style="background: #ff6b35; color: white; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; font-size: 10px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${m.task}\n${m.date}">🔧 ${m.task}</div>`;
                });
                
                html += `</div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
        }
        


        function loadArchives() {
            fetch('/api/archived-events')
                .then(r => r.json())
                .then(events => {
                    document.getElementById('archivedEventsList').innerHTML = events.map(e => `
                        <div class="card">
                            <div class="card-title">${e.name}</div>
                            <div class="card-meta">${e.location || 'N/A'} • ${e.date}</div>
                            <div class="card-meta">Archived: ${new Date(e.archived_date).toLocaleDateString()}</div>
                            <div class="card-actions">
                                <button class="btn" onclick="restoreEvent(${e.id})" style="background: var(--success); color: white;">Restore</button>
                            </div>
                        </div>
                    `).join('');
                });
            
            fetch('/api/archived-catering')
                .then(r => r.json())
                .then(orders => {
                    document.getElementById('archivedCateringList').innerHTML = orders.map(c => `
                        <div class="card">
                            <div class="card-title">${c.client}</div>
                            <div class="card-meta">${c.guests} guests • ${c.date}</div>
                            <div class="card-meta">Archived: ${new Date(c.archived_date).toLocaleDateString()}</div>
                            <div class="card-actions">
                                <button class="btn" onclick="restoreCateringOrder(${c.id})" style="background: var(--success); color: white;">Restore</button>
                            </div>
                        </div>
                    `).join('');
                });
        }
        
        function restoreEvent(id) {
            if (confirm('Restore this event to active events?')) {
                fetch(`/api/archived-events/${id}/restore`, { method: 'POST' })
                    .then(() => loadArchives());
            }
        }
        
        function restoreCateringOrder(id) {
            if (confirm('Restore this order to active catering?')) {
                fetch(`/api/archived-catering/${id}/restore`, { method: 'POST' })
                    .then(() => loadArchives());
            }
        }

        function downloadBackup() {
            if (confirm('Download a backup of your entire database?')) {
                window.location.href = '/api/backup/download';
            }
        }
        
        function uploadBackup() {
            const file = document.getElementById('restoreFile').files[0];
            if (!file) return;
            
            if (!confirm('WARNING: This will replace ALL current data with the backup file. Continue?')) {
                document.getElementById('restoreFile').value = '';
                return;
            }
            
            const formData = new FormData();
            formData.append('backup', file);
            
            fetch('/api/backup/restore', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Backup restored successfully! Reloading...');
                    location.reload();
                } else {
                    alert('Restore failed: ' + data.error);
                }
            })
            .catch(err => alert('Restore failed: ' + err));
        }

        // Global Search Functions
        let searchData = { all: [] };
        let currentSearchFilter = 'all';
        
        function openSearch() {
            document.getElementById('searchModal').classList.add('show');
            document.getElementById('globalSearch').focus();
            loadRecentSearches();
        }
        
        function closeSearch() {
            document.getElementById('searchModal').classList.remove('show');
            document.getElementById('globalSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }
        
        function loadRecentSearches() {
            const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            if (recent.length === 0) return;
            
            let html = '<div style="font-size: 0.85em; color: var(--gray); margin-bottom: 5px;">Recent:</div>';
            html += '<div style="display: flex; gap: 5px; flex-wrap: wrap;">';
            recent.forEach(term => {
                html += `<button onclick="document.getElementById('globalSearch').value='${term}'; performSearch();" style="background: var(--gray-light); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">${term}</button>`;
            });
            html += '</div>';
            document.getElementById('recentSearches').innerHTML = html;
        }
        
        function saveRecentSearch(term) {
            if (!term || term.length < 2) return;
            let recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            recent = recent.filter(t => t !== term);
            recent.unshift(term);
            recent = recent.slice(0, 10);
            localStorage.setItem('recentSearches', JSON.stringify(recent));
        }
        
        async function performSearch() {
            const query = document.getElementById('globalSearch').value.toLowerCase();
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            saveRecentSearch(query);
            
            const [events, catering, contacts, menu, employees] = await Promise.all([
                fetch('/api/events').then(r => r.json()),
                fetch('/api/catering').then(r => r.json()),
                fetch('/api/contacts').then(r => r.json()),
                fetch('/api/menu').then(r => r.json()),
                fetch('/api/employees').then(r => r.json())
            ]);
            
            searchData = {
                all: [],
                events: events.filter(e => e.name?.toLowerCase().includes(query) || e.location?.toLowerCase().includes(query)),
                catering: catering.filter(c => c.client?.toLowerCase().includes(query) || c.location?.toLowerCase().includes(query)),
                contacts: contacts.filter(c => c.name?.toLowerCase().includes(query) || c.company?.toLowerCase().includes(query)),
                menu: menu.filter(m => m.name?.toLowerCase().includes(query)),
                employees: employees.filter(e => e.name?.toLowerCase().includes(query) || e.role?.toLowerCase().includes(query))
            };
            
            searchData.all = [
                ...searchData.events.map(e => ({...e, type: 'event'})),
                ...searchData.catering.map(c => ({...c, type: 'catering'})),
                ...searchData.contacts.map(c => ({...c, type: 'contact'})),
                ...searchData.menu.map(m => ({...m, type: 'menu'})),
                ...searchData.employees.map(e => ({...e, type: 'employee'}))
            ];
            
            displaySearchResults();
        }
        
        function filterSearchResults(type) {
            currentSearchFilter = type;
            document.querySelectorAll('[id^="search-"]').forEach(btn => btn.style.background = 'var(--gray)');
            document.getElementById(`search-${type}`).style.background = 'var(--orange)';
            displaySearchResults();
        }
        
        function displaySearchResults() {
            const results = searchData[currentSearchFilter] || [];
            if (results.length === 0) {
                document.getElementById('searchResults').innerHTML = '<div style="text-align: center; color: var(--gray); padding: 20px;">No results found</div>';
                return;
            }
            
            let html = '';
            results.forEach(item => {
                const type = item.type;
                const icons = { event: '📅', catering: '🍽️', contact: '👤', menu: '🍴', employee: '👔' };
                const pages = { event: 'events', catering: 'catering', contact: 'contacts', menu: 'menu', employee: 'employee' };
                
                html += `<div onclick="closeSearch(); showPage('${pages[type]}');" style="background: var(--gray-light); padding: 12px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; border: 1px solid var(--border);" onmouseover="this.style.borderColor='var(--orange)'" onmouseout="this.style.borderColor='var(--border)'">`;
                html += `<div style="display: flex; align-items: center; gap: 10px;">`;
                html += `<span style="font-size: 1.5em;">${icons[type]}</span>`;
                html += `<div style="flex: 1;">`;
                html += `<div style="font-weight: 600;">${item.name || item.client}</div>`;
                html += `<div style="font-size: 0.85em; color: var(--gray);">`;
                if (type === 'event') html += `${item.location} • ${item.date}`;
                if (type === 'catering') html += `${item.guests} guests • ${item.date}`;
                if (type === 'contact') html += `${item.company || ''} • ${item.category || ''}`;
                if (type === 'menu') html += `$${item.price} • ${item.recipe_type || ''}`;
                if (type === 'employee') html += `${item.role}`;
                html += `</div></div></div></div>`;
            });
            
            document.getElementById('searchResults').innerHTML = html;
        }

        // Authentication Functions
        async function checkAuth() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                currentUser = JSON.parse(user);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.querySelector('.nav').style.display = 'block';
                resetSessionTimeout();
                await migrateEmployeesToDatabase();
                loadDashboard();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.querySelector('.nav').style.display = 'none';
                initializeDefaultUsers();
            }
        }
        
        async function migrateEmployeesToDatabase() {
            const localEmployees = JSON.parse(localStorage.getItem('employees') || '[]');
            if (localEmployees.length > 0) {
                const dbEmployees = await fetch('/api/employees').then(r => r.json());
                for (const emp of localEmployees) {
                    const exists = dbEmployees.find(e => e.name === emp.name);
                    if (!exists) {
                        await fetch('/api/employees', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(emp)
                        });
                    }
                }
            }
        }

        function attemptLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                return;
            }

            // Input validation
            if (username.length < 3 || password.length < 6) {
                errorDiv.textContent = 'Invalid credentials format';
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.querySelector('.nav').style.display = 'block';
                resetSessionTimeout(); // Start session management
                loadDashboard();
                errorDiv.textContent = '';
                
                // Clear password field for security
                document.getElementById('loginPassword').value = '';
            } else {
                errorDiv.textContent = 'Invalid username or password';
                // Clear password field on failed attempt
                document.getElementById('loginPassword').value = '';
            }
        }

        function showEmployeeRegistration() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'block';
            document.getElementById('loginError').textContent = '';
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('loginError').textContent = '';
        }

        function registerEmployee() {
            const name = document.getElementById('regName').value.trim();
            const role = document.getElementById('regRole').value;
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!name || !role || !username || !password) {
                errorDiv.textContent = 'Please fill in name, role, username, and password';
                return;
            }

            // Password strength validation
            if (password.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters long';
                return;
            }
            
            if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
                errorDiv.textContent = 'Password must contain uppercase, lowercase, and number';
                return;
            }

            // Username validation
            if (username.length < 3 || !/^[a-zA-Z0-9_]+$/.test(username)) {
                errorDiv.textContent = 'Username must be 3+ characters, letters/numbers/underscore only';
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.find(u => u.username === username)) {
                errorDiv.textContent = 'Username already exists. Please choose another.';
                return;
            }

            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const newEmployee = {
                id: Date.now(),
                name,
                role,
                username,
                email,
                phone,
                address: '',
                notes: 'Self-registered',
                status: 'signed-out',
                signInTime: null,
                totalHours: 0
            };

            employees.push(newEmployee);
            localStorage.setItem('employees', JSON.stringify(employees));

            users.push({
                id: newEmployee.id,
                username,
                password,
                role: 'Employee',
                name,
                employeeId: newEmployee.id
            });
            localStorage.setItem('users', JSON.stringify(users));

            errorDiv.style.color = 'var(--success)';
            errorDiv.textContent = 'Registration successful! You can now login.';
            
            setTimeout(() => {
                showLogin();
                document.getElementById('loginUsername').value = username;
                errorDiv.textContent = '';
                errorDiv.style.color = 'var(--danger)';
            }, 2000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear session timeout
                if (sessionTimeout) {
                    clearTimeout(sessionTimeout);
                    sessionTimeout = null;
                }
                
                // Clear user data
                currentUser = null;
                localStorage.removeItem('currentUser');
                
                // Clear all form fields for security
                document.querySelectorAll('input[type="password"]').forEach(input => input.value = '');
                document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
                document.querySelectorAll('input[type="email"]').forEach(input => input.value = '');
                
                // Reset UI
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.querySelector('.nav').style.display = 'none';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            }
        }

        function initializeDefaultUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.length === 0) {
                const adminUser = {
                    id: 1,
                    username: 'admin',
                    password: generateSecurePassword(),
                    role: 'Owner',
                    name: 'System Administrator'
                };
                localStorage.setItem('users', JSON.stringify([adminUser]));
                console.log('Default admin created. Username: admin, Password:', adminUser.password);
                alert(`Default admin created!\nUsername: admin\nPassword: ${adminUser.password}\n\nPlease save this password and change it immediately.`);
            }
            
            let employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const hasMaria = employees.some(e => e.name === 'Maria Garcia');
            const hasCarlos = employees.some(e => e.name === 'Carlos Rodriguez');
            
            if (!hasMaria) {
                employees.push({ id: Date.now(), name: 'Maria Garcia', role: 'Cook', status: 'signed-out', signInTime: null, totalHours: 0 });
            }
            if (!hasCarlos) {
                employees.push({ id: Date.now() + 1, name: 'Carlos Rodriguez', role: 'Cashier', status: 'signed-out', signInTime: null, totalHours: 0 });
            }
            
            if (!hasMaria || !hasCarlos) {
                localStorage.setItem('employees', JSON.stringify(employees));
            }
        }
        
        function generateSecurePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Permission Functions
        function hasPermission(page) {
            if (!currentUser || currentUser.role !== 'Employee') return true;
            const permissions = currentUser.permissions || {};
            return permissions[page] && (permissions[page].read || permissions[page].write);
        }
        
        function isReadOnly(page) {
            if (!currentUser || currentUser.role !== 'Employee') return false;
            const permissions = currentUser.permissions || {};
            return permissions[page] && permissions[page].read && !permissions[page].write;
        }
        
        function togglePermSection(section) {
            const content = document.getElementById(`${section}-permissions`);
            const icon = document.getElementById(`${section}-perm-icon`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▲';
            } else {
                content.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        

        
        function hideSettingsSections() {
            if (!currentUser || currentUser.role !== 'Employee') return;
            const sections = currentUser.permissions?.settingsSections || {};
            
            // Hide sections based on permissions
            if (!sections.theme?.read) document.getElementById('theme-content')?.parentElement?.remove();
            if (!sections.business?.read) document.getElementById('business-content')?.parentElement?.remove();
            if (!sections.categories?.read) {
                document.getElementById('menuCategories-content')?.parentElement?.remove();
                document.getElementById('supplierCategories-content')?.parentElement?.remove();
                document.getElementById('units-content')?.parentElement?.remove();
                document.getElementById('eventStatuses-content')?.parentElement?.remove();
                document.getElementById('fileCategories-content')?.parentElement?.remove();
            }
            if (!sections.roles?.read) document.getElementById('employeeRoles-content')?.parentElement?.remove();
            if (!sections.permissions?.read) document.getElementById('permissions-content')?.parentElement?.remove();
            if (!sections.data?.read) document.getElementById('data-content')?.parentElement?.remove();
            
            // Hide write functions (buttons) for read-only sections
            Object.keys(sections).forEach(section => {
                if (sections[section].read && !sections[section].write) {
                    const sectionElement = document.getElementById(`${section}-content`);
                    if (sectionElement) {
                        sectionElement.querySelectorAll('button, input[type="text"], select').forEach(el => {
                            if (!el.type || el.type !== 'checkbox') el.disabled = true;
                        });
                    }
                }
            });
        }

        // Input sanitization function
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/[<>"'&]/g, function(match) {
                const escapeMap = {
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#x27;',
                    '&': '&amp;'
                };
                return escapeMap[match];
            });
        }
        
        // Page Navigation
        function showPage(pageId) {
            // Validate pageId to prevent XSS
            const validPages = ['dashboard', 'menu', 'ingredients', 'inventory', 'suppliers', 'employee', 'tools', 'catering', 'events', 'contacts', 'marketing', 'analytics', 'settings'];
            if (!validPages.includes(pageId)) {
                console.error('Invalid page ID:', pageId);
                return;
            }
            
            // Check permissions
            if (!hasPermission(pageId)) {
                alert('Access denied. You do not have permission to view this page.');
                return;
            }
            
            currentPage = pageId;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            const navItem = document.querySelector(`[onclick*="${pageId}"]`);
            if (navItem && navItem.classList.contains('nav-item')) {
                navItem.classList.add('active');
            }
            
            document.getElementById('extraMenu').classList.remove('show');
            
            // Show/hide FAB based on page and permissions
            const fabBtn = document.getElementById('fabBtn');
            if (['dashboard', 'analytics', 'settings', 'marketing', 'events', 'catering', 'employee', 'tools', 'contacts'].includes(pageId) || isReadOnly(pageId)) {
                fabBtn.style.display = 'none';
            } else {
                fabBtn.style.display = 'block';
                fabBtn.style.background = '#ff6b35';
            }
            
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'menu') loadMenu();
            if (pageId === 'ingredients') loadIngredients();
            if (pageId === 'inventory') loadInventory();
            if (pageId === 'suppliers') loadSuppliers();
            if (pageId === 'employee') { 
                loadEmployees(); 
                updateEmployeeRoleDropdown();
                setTimeout(() => {
                    const employeeSelect = document.getElementById('employeeSelect');
                    if (employeeSelect) {
                        employeeSelect.addEventListener('change', updateCurrentStatus);
                    }
                }, 100);
            }
            if (pageId === 'tools') { loadFiles(); loadLicenses(); loadMaintenanceTasks(); loadRecipesForCalculator(); loadArchives(); }
            if (pageId === 'catering') { loadCatering(); loadTools(); }
            if (pageId === 'events') loadEvents();
            if (pageId === 'marketing') loadReviews();
            if (pageId === 'analytics') { loadExpenses(); loadAnalytics(); }
            if (pageId === 'contacts') loadContacts();
            if (pageId === 'settings') { loadMeasurementUnits(); loadMenuCategories(); loadInventoryCategories(); loadSupplierCategories(); loadEventStatuses(); loadFileCategories(); loadEmployeeRoles(); loadContactCategories(); loadDefaultMargin(); loadBusinessInfo(); loadUserProfile(); hideSettingsSections(); }
            
            // Expand calendar clicked item
            if (calendarClickedItem) {
                const itemType = calendarClickedItem.type;
                const itemId = calendarClickedItem.id;
                calendarClickedItem = null;
                setTimeout(() => {
                    if (itemType === 'event') {
                        toggleEventDetails(itemId);
                        setTimeout(() => {
                            const details = document.getElementById(`event-details-${itemId}`);
                            if (details) details.scrollIntoView({behavior: 'smooth', block: 'center'});
                        }, 100);
                    } else if (itemType === 'catering') {
                        toggleCateringDetails(itemId);
                        setTimeout(() => {
                            const details = document.getElementById(`catering-details-${itemId}`);
                            if (details) details.scrollIntoView({behavior: 'smooth', block: 'center'});
                        }, 100);
                    }
                }, 500);
            }
            
            // Hide add buttons for read-only access
            if (isReadOnly(pageId)) {
                setTimeout(() => {
                    document.querySelectorAll('.btn').forEach(btn => {
                        if (btn.textContent.includes('Add') || btn.textContent.includes('Edit') || btn.textContent.includes('Delete')) {
                            btn.style.display = 'none';
                        }
                    });
                    document.querySelectorAll('.card-actions').forEach(actions => {
                        actions.style.display = 'none';
                    });
                }, 100);
            }
        }

        // Modal Functions
        function openAddModal() {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            let title = '';
            let form = '';
            
            switch(currentPage) {
                case 'menu':
                    title = 'Add New Recipe';
                    form = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="recipeName" placeholder="Recipe Name (e.g., Birria Tacos)">
                            </div>
                            <div class="form-row">
                                <select id="recipeType">
                                    ${getAllMenuCategories().map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                                <input type="number" id="portions" placeholder="Portions" min="1" value="1">
                            </div>
                            <div class="form-row">
                                <input type="number" id="price" placeholder="Menu Price ($)" step="0.01">
                                <input type="number" id="cost" placeholder="Recipe Cost ($)" step="0.01">
                            </div>
                            <button class="btn" onclick="addRecipe(); closeAddModal();">Add Recipe</button>
                        </div>
                    `;
                    break;
                case 'ingredients':
                    title = 'Add Ingredient';
                    const units = getAllMeasurementUnits();
                    const unitOptions = units.map(unit => `<option value="${unit}">${unit}</option>`).join('');
                    form = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="ingredientName" placeholder="Ingredient Name (e.g., Ground Beef)">
                            </div>
                            <div class="form-row">
                                <input type="number" id="ingredientCost" placeholder="Cost per Unit ($)" step="0.01">
                                <select id="ingredientUnit">
                                    <option value="">Select unit...</option>
                                    ${unitOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="number" id="ingredientServings" placeholder="Servings" min="1">
                            </div>
                            <button class="btn" onclick="addIngredient(); closeAddModal();">Add Ingredient</button>
                        </div>
                    `;
                    break;
                case 'inventory':
                    title = 'Add to Inventory';
                    form = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="inventoryItemName" placeholder="Item Name (e.g., Paper Towels, Ground Beef)">
                            </div>
                            <div class="form-row">
                                <select id="inventoryCategory" onchange="document.getElementById('addToIngredients').checked = (this.value === 'Food')">
                                    ${getAllInventoryCategories().map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                                <select id="inventoryUnit">
                                    <option value="">Select unit...</option>
                                    ${getAllMeasurementUnits().map(unit => `<option value="${unit}">${unit}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <input type="number" id="currentStock" placeholder="Current Stock" step="0.1">
                                <input type="number" id="minStock" placeholder="Min Stock" step="0.1">
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                <label style="margin: 0; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="addToIngredients" checked style="width: auto; cursor: pointer;">
                                    <span>Add to Ingredients (for recipes)</span>
                                </label>
                            </div>
                            <button class="btn" onclick="addInventoryItem(); closeAddModal();">Add to Inventory</button>
                        </div>
                    `;
                    break;
                case 'suppliers':
                    title = 'Add Supplier';
                    form = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="supplierName" placeholder="Supplier Name">
                            </div>
                            <div class="form-row">
                                <input type="text" id="supplierContact" placeholder="Contact Person">
                                <select id="supplierCategory">
                                    ${getAllSupplierCategories().map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <input type="tel" id="supplierPhone" placeholder="Phone Number">
                                <input type="email" id="supplierEmail" placeholder="Email">
                            </div>
                            <div class="form-group">
                                <input type="text" id="supplierAddress" placeholder="Address">
                            </div>
                            <div class="form-group">
                                <textarea id="supplierDescription" placeholder="Description, notes, terms..." rows="3"></textarea>
                            </div>
                            <button class="btn" onclick="addSupplier(); closeAddModal();">Add Supplier</button>
                        </div>
                    `;
                    break;
                case 'tools':
                    title = 'Add Tool or Upload File';
                    form = `
                        <div class="form">
                            <h4 style="margin-bottom: 15px;">Add Tool</h4>
                            <div class="form-group">
                                <input type="text" id="toolName" placeholder="Tool/Equipment Name">
                            </div>
                            <div class="form-row">
                                <select id="toolCategory">
                                    <option value="Cooking">Cooking Equipment</option>
                                    <option value="Prep">Prep Tools</option>
                                    <option value="Storage">Storage</option>
                                    <option value="Cleaning">Cleaning</option>
                                </select>
                                <select id="toolStatus">
                                    <option value="Working">Working</option>
                                    <option value="Maintenance">Needs Maintenance</option>
                                    <option value="Broken">Broken</option>
                                </select>
                            </div>
                            <button class="btn" onclick="addTool(); closeAddModal();">Add Tool</button>
                            
                            <hr style="margin: 20px 0;">
                            
                            <h4 style="margin-bottom: 15px;">Upload File</h4>
                            <div class="form-group">
                                <input type="file" id="fileUpload" multiple accept="image/*,.pdf,.doc,.docx">
                            </div>
                            <button class="btn" onclick="uploadFile(); closeAddModal();">Upload File</button>
                        </div>
                    `;
                    break;
                case 'events':
                    title = 'Add Event';
                    form = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="eventName" placeholder="Event Name (e.g., Downtown Food Festival)">
                            </div>
                            <div class="form-row">
                                <select id="eventType">
                                    <option value="Festival">Festival</option>
                                    <option value="Farmers Market">Farmers Market</option>
                                    <option value="Street Fair">Street Fair</option>
                                    <option value="Concert">Concert</option>
                                    <option value="Sports Event">Sports Event</option>
                                    <option value="Corporate Event">Corporate Event</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" id="eventLocation" placeholder="Location">
                            </div>
                            <div class="form-row">
                                <input type="text" id="eventDate" placeholder="Start Date" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                                <input type="text" id="eventEndDate" placeholder="End Date (optional)" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                            </div>
                            <div class="form-group">
                                <input type="text" id="eventTime" placeholder="Time (e.g., 10am-6pm)">
                            </div>
                            <div class="form-row">
                                <input type="number" id="applicationFee" placeholder="Application Fee ($)" step="0.01" min="0">
                                <select id="eventStatus">
                                    <option value="Interested">Interested</option>
                                    <option value="Applied">Applied</option>
                                    <option value="Accepted">Accepted</option>
                                    <option value="Accepted & Paid">Accepted & Paid</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <textarea id="eventNotes" placeholder="Notes (organizer contact, requirements, competition...)" rows="2"></textarea>
                            </div>
                            <button class="btn" onclick="saveEvent(); closeAddModal();">Add Event</button>
                        </div>
                    `;
                    break;

            }
            
            modalTitle.textContent = title;
            modalForm.innerHTML = form;
            
            // Load ingredients for inventory dropdown if needed
            if (currentPage === 'inventory') {
                setTimeout(() => {
                    fetch('/api/ingredients')
                        .then(r => r.json())
                        .then(ingredients => {
                            const inventorySelect = document.getElementById('inventoryIngredient');
                            if (inventorySelect) {
                                inventorySelect.innerHTML = 
                                    '<option value="">Select ingredient...</option>' +
                                    ingredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('');
                            }
                        });
                }, 100);
            }
            
            modal.classList.add('show');
        }
        
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('show');
        }

        // Extra Menu
        function toggleExtraMenu() {
            document.getElementById('extraMenu').classList.toggle('show');
        }

        document.addEventListener('click', function(event) {
            const menu = document.getElementById('extraMenu');
            const btn = event.target.closest('[onclick="toggleExtraMenu()"]');
            if (!menu.contains(event.target) && !btn) {
                menu.classList.remove('show');
            }
        });

        // Dashboard Functions
        function loadUpcomingSchedule() {
            const today = new Date().toISOString().split('T')[0];
            const futureDate = new Date(Date.now() + 60*24*60*60*1000).toISOString().split('T')[0];
            
            Promise.all([
                fetch('/api/events').then(r => r.json()),
                fetch('/api/catering').then(r => r.json())
            ]).then(([events, catering]) => {
                const upcomingEvents = events.filter(e => e.date && e.date >= today && e.date <= futureDate);
                const upcomingCatering = catering.filter(c => c.date && c.date >= today && c.date <= futureDate);
                
                const allUpcoming = [
                    ...upcomingEvents.map(e => ({...e, type: 'event'})),
                    ...upcomingCatering.map(c => ({...c, type: 'catering'}))
                ].sort((a, b) => new Date(a.date) - new Date(b.date));

                let scheduleHtml = '';
                if (allUpcoming.length === 0) {
                    scheduleHtml = `
                        <div class="card" style="text-align: center; color: var(--gray);">
                            <div class="card-title">No upcoming events</div>
                            <div class="card-meta">Add events or catering orders to see your schedule</div>
                        </div>
                    `;
                } else {
                    scheduleHtml = allUpcoming.slice(0, 6).map(item => {
                        const isToday = item.date === today;
                        const daysDiff = Math.ceil((new Date(item.date) - new Date()) / (1000 * 60 * 60 * 24));
                        const timeText = daysDiff === 0 ? 'Today' : daysDiff === 1 ? 'Tomorrow' : `${daysDiff} days`;
                        const typeColor = item.type === 'event' ? '#17a2b8' : '#28a745';
                        const typeLabel = item.type === 'event' ? 'EVENT' : 'CATERING';
                        
                        return `
                            <div class="card" style="${isToday ? 'border-color: var(--orange); background: rgba(255, 107, 53, 0.05);' : ''} cursor: pointer; border-left: 4px solid ${typeColor};" onclick="${item.type === 'event' ? `showPage('events');` : `showPage('catering');`}">
                                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${item.type === 'event' ? item.name : item.client}</span>
                                    <span style="background: ${typeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: bold;">${typeLabel}</span>
                                </div>
                                <div class="card-meta">${item.type === 'event' ? item.location : `${item.guests} guests`}</div>
                                <div class="card-meta" style="color: ${isToday ? 'var(--orange)' : 'var(--gray)'}; font-weight: ${isToday ? 'bold' : 'normal'};">${item.date} • ${timeText}</div>
                                ${item.type === 'catering' && item.price ? `<div class="card-meta">$${item.price.toFixed(2)}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('upcomingSchedule').innerHTML = scheduleHtml;
            });
        }
        
        function loadDashboard() {
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    const totalItems = items.length;
                    const avgFoodCost = totalItems > 0 ? items.reduce((sum, item) => sum + ((item.cost / item.price) * 100), 0) / totalItems : 0;
                    const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                    const goodItems = items.filter(item => ((item.price - item.cost) / item.price) * 100 >= defaultMargin).length;
                    const totalRevenue = items.reduce((sum, item) => sum + (item.price * 10), 0);

                    document.getElementById('dashboardStats').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${totalItems}</div>
                            <div class="stat-label">Menu Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${avgFoodCost.toFixed(1)}%</div>
                            <div class="stat-label">Avg Food Cost</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${goodItems}</div>
                            <div class="stat-label">Good Items (30%+)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">$${totalRevenue.toFixed(0)}</div>
                            <div class="stat-label">Est. Revenue</div>
                        </div>
                    `;

                    const topItems = items.sort((a, b) => (b.cost / b.price) - (a.cost / a.price)).slice(0, 6);
                    document.getElementById('topItems').innerHTML = topItems.map(item => {
                        const foodCost = (item.cost / item.price) * 100;
                        const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                        const margin = ((item.price - item.cost) / item.price) * 100;
                        const status = margin >= defaultMargin ? '🟢 Good' : margin >= (defaultMargin * 0.67) ? '🟡 Needs Attention' : '🔴 Bad - Urgent';
                        return `
                            <div class="card">
                                <div class="card-title">${item.name}</div>
                                <div class="card-meta">$${item.price} • ${foodCost.toFixed(1)}% food cost</div>
                                <div class="card-meta">${status}</div>
                            </div>
                        `;
                    }).join('');
                    
                    // Load upcoming schedule
                    loadUpcomingSchedule();
                });
        }

        // Menu Functions
        function addRecipe() {
            const name = document.getElementById('recipeName').value;
            const type = document.getElementById('recipeType').value;
            const portions = parseInt(document.getElementById('portions').value) || 1;
            const price = parseFloat(document.getElementById('price').value);
            const cost = parseFloat(document.getElementById('cost').value);

            if (!name || !price || !cost) {
                alert('Please fill in all fields');
                return;
            }

            fetch('/api/menu', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, price, cost, recipe_type: type, portions })
            }).then(() => {
                document.getElementById('recipeName').value = '';
                document.getElementById('price').value = '';
                document.getElementById('cost').value = '';
                document.getElementById('portions').value = '1';
                loadMenu();
            });
        }

        function loadMenu() {
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    // Group items by category
                    const grouped = {};
                    items.forEach(item => {
                        const category = item.recipe_type || 'Uncategorized';
                        if (!grouped[category]) grouped[category] = [];
                        grouped[category].push(item);
                    });
                    
                    let html = '';
                    Object.keys(grouped).sort().forEach(category => {
                        html += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0;"><h3 style="color: var(--orange); font-size: 18px; font-weight: 600; border-bottom: 2px solid var(--orange); padding-bottom: 8px;">${category}</h3></div>`;
                        
                        grouped[category].forEach(item => {
                            const margin = ((item.price - item.cost) / item.price) * 100;
                            const status = margin >= 30 ? '🟢 Good' : margin >= 20 ? '🟡 Needs Attention' : '🔴 Bad - Urgent';
                            html += `
                                <div class="card">
                                    <div class="card-header" onclick="toggleMenuDetails(${item.id})" style="cursor: pointer;">
                                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                                            ${item.name}
                                            <span class="expand-icon" id="icon-${item.id}">▼</span>
                                        </div>
                                        <div class="card-meta">${item.recipe_type || 'Uncategorized'} • ${item.portions} portions</div>
                                        <div class="card-meta" style="display: flex; gap: 15px; align-items: center;">
                                            <span>Cost: $${item.cost.toFixed(2)}</span>
                                            <span style="display: flex; align-items: center;">Price: $<input type="number" class="inline-edit-input" value="${item.price.toFixed(2)}" step="0.01" min="0" onchange="updatePrice(${item.id}, this.value)" style="width: 70px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; background: var(--white); color: var(--charcoal); margin-left: 2px;" onclick="event.stopPropagation();"></span>
                                        </div>
                                        <div class="card-meta">Margin: <input type="number" class="inline-edit-input" value="${margin.toFixed(1)}" step="0.1" min="0" max="100" onchange="updateMargin(${item.id}, this.value)" style="width: 50px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; background: var(--white); color: var(--charcoal);" onclick="event.stopPropagation();">% ${status}</div>
                                    </div>
                                    <div class="card-details" id="details-${item.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                                        <h4 style="margin-bottom: 10px;">Ingredients:</h4>
                                        <div id="ingredients-${item.id}">Loading ingredients...</div>
                                    </div>
                                    <div class="card-actions" style="display: flex; gap: 10px; margin-top: 15px;">
                                        <button class="btn" onclick="event.stopPropagation(); editRecipe(${item.id})" style="flex: 1; background: var(--orange); color: white;">Edit</button>
                                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteRecipe(${item.id})" style="flex: 1;">Delete</button>
                                    </div>
                                </div>
                            `;
                        });
                    });
                    
                    document.getElementById('menuItems').innerHTML = html;
                });
        }

        function toggleMenuDetails(id) {
            const details = document.getElementById(`details-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '▲';
                loadMenuIngredients(id);
            } else {
                details.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        
        function loadMenuIngredients(menuId) {
            const ingredients = JSON.parse(localStorage.getItem(`recipe-${menuId}`) || '[]');
            
            if (ingredients.length === 0) {
                document.getElementById(`ingredients-${menuId}`).innerHTML = '<div style="color: var(--gray); font-style: italic;">No ingredients added yet. Use Edit to add ingredients.</div>';
                return;
            }
            
            const ingredientsHtml = ingredients.map(ing => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: var(--gray-light); border-radius: 6px;">
                    <span>${ing.name}</span>
                    <span>${ing.amount} servings - $${(ing.calculatedCost || 0).toFixed(2)}</span>
                </div>
            `).join('');
            
            document.getElementById(`ingredients-${menuId}`).innerHTML = ingredientsHtml;
        }

        function editRecipe(id) {
            editingRecipeId = id;
            editIngredients = JSON.parse(localStorage.getItem(`recipe-${id}`) || '[]');
            
            // Get recipe data
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    const recipe = items.find(item => item.id === id);
                    if (!recipe) return;
                    
                    // Open modal with edit form
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    modalTitle.textContent = 'Edit Recipe';
                    const ingredients = JSON.parse(localStorage.getItem(`recipe-${id}`) || '[]');
                    
                    modalForm.innerHTML = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="recipeName" placeholder="Recipe Name" value="${recipe.name}">
                            </div>
                            <div class="form-row">
                                <select id="recipeType">
                                    ${getAllMenuCategories().map(cat => `<option value="${cat}" ${recipe.recipe_type === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                                <input type="number" id="portions" placeholder="Portions" min="1" value="${recipe.portions}">
                            </div>
                            <div class="form-row">
                                <input type="number" id="price" placeholder="Menu Price ($)" step="0.01" value="${recipe.price}">
                                <input type="number" id="cost" placeholder="Recipe Cost ($)" step="0.01" value="${ingredients.reduce((sum, ing) => sum + (ing.calculatedCost || 0), 0).toFixed(2)}" readonly style="background: var(--gray-light);">
                            </div>
                            
                            <h4 style="margin: 20px 0 10px 0;">Ingredients</h4>
                            <div id="editIngredientsList">
                                ${ingredients.map((ing, index) => `
                                    <div class="form-row" style="align-items: center; margin-bottom: 10px;">
                                        <select onchange="updateEditIngredient(${index}, 'ingredientId', this.value); calculateIngredientCost(${index})" style="flex: 1;">
                                            <option value="">Select ingredient...</option>
                                            <option value="${ing.ingredientId || ''}" selected>${ing.name || 'Select ingredient...'}</option>
                                        </select>
                                        <input type="number" placeholder="Servings" step="0.1" value="${ing.amount}" onchange="updateEditIngredient(${index}, 'amount', this.value); calculateIngredientCost(${index})" style="width: 80px;">
                                        <span style="width: 80px; text-align: center; font-size: 12px;">$${(ing.calculatedCost || 0).toFixed(2)}</span>
                                        <button type="button" onclick="removeEditIngredient(${index})" style="background: var(--danger); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">&times;</button>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="text-align: right; margin: 10px 0; font-weight: bold;">Total Cost: $<span id="totalCost">${ingredients.reduce((sum, ing) => sum + (ing.calculatedCost || 0), 0).toFixed(2)}</span></div>
                            <button type="button" class="btn" onclick="addEditIngredient()" style="background: var(--success); margin-bottom: 15px;">+ Add Ingredient</button>
                            
                            <button class="btn" onclick="updateRecipe(${id}); closeAddModal();">Update Recipe</button>
                        </div>
                    `;
                    
                    modal.classList.add('show');
                });
        }
        
        function updateRecipe(id) {
            const name = document.getElementById('recipeName').value;
            const type = document.getElementById('recipeType').value;
            const portions = parseInt(document.getElementById('portions').value) || 1;
            const price = parseFloat(document.getElementById('price').value);
            
            let sum = 0;
            editIngredients.forEach(ing => {
                sum += Math.round((ing.calculatedCost || 0) * 100);
            });
            const cost = sum / 100;

            if (!name || !price) {
                alert('Please fill in name and price');
                return;
            }
            
            localStorage.setItem(`recipe-${id}`, JSON.stringify(editIngredients));

            fetch(`/api/menu/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, price, cost, recipe_type: type, portions })
            }).then(() => {
                setTimeout(() => loadMenu(), 200);
            });
        }

        function deleteRecipe(id) {
            if (confirm('Delete this recipe?')) {
                fetch(`/api/menu/${id}`, { method: 'DELETE' })
                    .then(() => loadMenu());
            }
        }

        function updatePrice(id, newPrice) {
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) return;
            
            // Get current item to preserve other fields
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    const item = items.find(i => i.id === id);
                    if (!item) return;
                    
                    fetch(`/api/menu/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name: item.name,
                            price: price,
                            cost: item.cost,
                            recipe_type: item.recipe_type,
                            portions: item.portions
                        })
                    }).then(() => {
                        loadMenu();
                    });
                });
        }

        function updateMargin(id, newMargin) {
            const margin = parseFloat(newMargin);
            if (isNaN(margin) || margin < 0) return;
            
            // Get current item data to calculate new price
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    const item = items.find(i => i.id === id);
                    if (!item) return;
                    
                    // Calculate new price based on margin: price = cost / (1 - margin/100)
                    const newPrice = item.cost / (1 - margin / 100);
                    
                    fetch(`/api/menu/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name: item.name,
                            price: newPrice,
                            cost: item.cost,
                            recipe_type: item.recipe_type,
                            portions: item.portions
                        })
                    }).then(() => {
                        loadMenu();
                    });
                });
        }
        
        let editingRecipeId = null;
        let editIngredients = [];
        
        function addEditIngredient() {
            editIngredients.push({ ingredientId: '', name: '', amount: '1', unit: '', calculatedCost: 0 });
            refreshEditIngredients();
        }
        
        function updateEditIngredient(index, field, value) {
            if (editIngredients[index]) {
                if (field === 'amount') {
                    editIngredients[index][field] = parseFloat(value) || 0;
                } else if (field === 'ingredientId') {
                    editIngredients[index][field] = value;
                    // Update name, unit, and servings from selected ingredient
                    fetch('/api/ingredients')
                        .then(r => r.json())
                        .then(ingredients => {
                            const ingredient = ingredients.find(ing => ing.id == value);
                            if (ingredient) {
                                editIngredients[index].name = ingredient.name;
                                editIngredients[index].unit = ingredient.unit;
                                editIngredients[index].unitCost = ingredient.cost;
                                editIngredients[index].servings = ingredient.servings || 1;
                                refreshEditIngredients();
                            }
                        });
                } else {
                    editIngredients[index][field] = value;
                }
            }
        }
        
        function calculateIngredientCost(index) {
            if (editIngredients[index] && editIngredients[index].unitCost && editIngredients[index].amount && editIngredients[index].servings) {
                // Calculate cost per serving, then multiply by amount of servings needed
                const costPerServing = editIngredients[index].unitCost / editIngredients[index].servings;
                editIngredients[index].calculatedCost = parseFloat((costPerServing * editIngredients[index].amount).toFixed(2));
                updateTotalCost();
                refreshEditIngredients();
            }
        }
        
        function updateTotalCost() {
            let sum = 0;
            editIngredients.forEach(ing => {
                sum += Math.round((ing.calculatedCost || 0) * 100);
            });
            const totalCost = sum / 100;
            const totalCostElement = document.getElementById('totalCost');
            const costInput = document.getElementById('cost');
            if (totalCostElement) {
                totalCostElement.textContent = totalCost.toFixed(2);
            }
            if (costInput) {
                costInput.value = totalCost.toFixed(2);
            }
        }
        
        function removeEditIngredient(index) {
            editIngredients.splice(index, 1);
            updateTotalCost();
            refreshEditIngredients();
        }
        
        function refreshEditIngredients() {
            // Load ingredients for dropdowns
            fetch('/api/ingredients')
                .then(r => r.json())
                .then(ingredients => {
                    const editList = document.getElementById('editIngredientsList');
                    if (editList) {
                        editList.innerHTML = editIngredients.map((ing, index) => `
                            <div class="form-row" style="align-items: center; margin-bottom: 10px;">
                                <select onchange="updateEditIngredient(${index}, 'ingredientId', this.value); calculateIngredientCost(${index})" style="flex: 1;">
                                    <option value="">Select ingredient...</option>
                                    ${ingredients.map(ingredient => `<option value="${ingredient.id}" ${ingredient.id == ing.ingredientId ? 'selected' : ''}>${ingredient.name} (${ingredient.servings || 1} servings per ${ingredient.unit})</option>`).join('')}
                                </select>
                                <input type="number" placeholder="Servings" step="0.1" value="${ing.amount}" onchange="updateEditIngredient(${index}, 'amount', this.value); calculateIngredientCost(${index})" style="width: 80px;">
                                <span style="width: 80px; text-align: center; font-size: 12px;">$${(ing.calculatedCost || 0).toFixed(2)}</span>
                                <button type="button" onclick="removeEditIngredient(${index})" style="background: var(--danger); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">&times;</button>
                            </div>
                        `).join('');
                    }
                });
        }

        // Ingredient Functions
        function addIngredient() {
            const name = document.getElementById('ingredientName').value;
            const cost = parseFloat(document.getElementById('ingredientCost').value);
            const unit = document.getElementById('ingredientUnit').value;
            const servings = parseInt(document.getElementById('ingredientServings').value) || 1;

            if (!name || !cost || !unit) {
                alert('Please fill in all fields');
                return;
            }

            fetch('/api/ingredients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, cost, unit, servings })
            }).then(() => {
                document.getElementById('ingredientName').value = '';
                document.getElementById('ingredientCost').value = '';
                document.getElementById('ingredientUnit').value = '';
                document.getElementById('ingredientServings').value = '';
                loadIngredients();
            });
        }

        function loadIngredients() {
            fetch('/api/ingredients')
                .then(r => r.json())
                .then(items => {
                    document.getElementById('ingredientsList').innerHTML = items.map(item => `
                        <div class="card">
                            <div class="card-title">${item.name}</div>
                            <div class="card-meta">Cost: $${item.cost} per ${item.unit}</div>
                            <div class="card-meta">Servings: ${item.servings || 1} per ${item.unit}</div>
                            <div class="card-meta">Cost per serving: $${((item.cost || 0) / (item.servings || 1)).toFixed(2)}</div>
                            <div class="card-actions">
                                <button class="btn" onclick="editIngredient(${item.id})" style="background: var(--orange); color: white;">Edit</button>
                                <button class="btn btn-danger" onclick="deleteIngredient(${item.id})">Delete</button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Update inventory dropdown if it exists - show all ingredients
                    const inventorySelect = document.getElementById('inventoryIngredient');
                    if (inventorySelect) {
                        inventorySelect.innerHTML = 
                            '<option value="">Select ingredient...</option>' +
                            realIngredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('');
                    }
                });
        }

        function editIngredient(id) {
            fetch('/api/ingredients')
                .then(r => r.json())
                .then(items => {
                    const ingredient = items.find(item => item.id === id);
                    if (!ingredient) return;
                    
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    modalTitle.textContent = 'Edit Ingredient';
                    const units = getAllMeasurementUnits();
                    const unitOptions = units.map(unit => `<option value="${unit}" ${unit === ingredient.unit ? 'selected' : ''}>${unit}</option>`).join('');
                    
                    modalForm.innerHTML = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="ingredientName" placeholder="Ingredient Name" value="${ingredient.name}">
                            </div>
                            <div class="form-row">
                                <input type="number" id="ingredientCost" placeholder="Cost per Unit ($)" step="0.01" value="${ingredient.cost}">
                                <select id="ingredientUnit">
                                    <option value="">Select unit...</option>
                                    ${unitOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="number" id="ingredientServings" placeholder="Servings" min="1" value="${ingredient.servings || 1}">
                            </div>
                            <button class="btn" onclick="updateIngredient(${id}); closeAddModal();">Update Ingredient</button>
                        </div>
                    `;
                    
                    modal.classList.add('show');
                });
        }
        
        function updateIngredient(id) {
            const name = document.getElementById('ingredientName').value;
            const cost = parseFloat(document.getElementById('ingredientCost').value);
            const unit = document.getElementById('ingredientUnit').value;
            const servings = parseInt(document.getElementById('ingredientServings').value) || 1;

            if (!name || !cost || !unit) {
                alert('Please fill in all fields');
                return;
            }

            fetch(`/api/ingredients/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, cost, unit, servings })
            }).then(() => {
                loadIngredients();
            });
        }

        function deleteIngredient(id) {
            if (confirm('Delete this ingredient? This will also remove it from inventory.')) {
                fetch(`/api/ingredients/${id}`, { method: 'DELETE' })
                    .then(() => {
                        loadIngredients();
                        loadInventory();
                    });
            }
        }

        // Barcode Scanner Functions
        let html5QrCode = null;
        
        function openBarcodeScanner() {
            document.getElementById('barcodeScannerModal').classList.add('show');
            document.getElementById('barcodeScanResult').innerHTML = '<div style="text-align: center; color: var(--gray);">Position barcode in camera view...</div>';
            
            html5QrCode = new Html5Qrcode("barcodeScannerReader");
            
            Html5Qrcode.getCameras().then(cameras => {
                if (cameras && cameras.length) {
                    const cameraId = cameras[cameras.length - 1].id;
                    html5QrCode.start(
                        cameraId,
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        onScanSuccess,
                        onScanFailure
                    ).catch(err => {
                        console.error('Camera start error:', err);
                        document.getElementById('barcodeScanResult').innerHTML = '<div style="color: var(--danger);">Camera access denied or not available</div>';
                    });
                }
            }).catch(err => {
                console.error('Camera error:', err);
                document.getElementById('barcodeScanResult').innerHTML = '<div style="color: var(--danger);">No camera found</div>';
            });
        }
        
        function closeBarcodeScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                    document.getElementById('barcodeScannerModal').classList.remove('show');
                }).catch(err => {
                    console.error('Stop error:', err);
                    html5QrCode = null;
                    document.getElementById('barcodeScannerModal').classList.remove('show');
                });
            } else {
                document.getElementById('barcodeScannerModal').classList.remove('show');
            }
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            html5QrCode.pause(true);
            
            fetch('/api/inventory')
                .then(r => r.json())
                .then(items => {
                    console.log('Scanned:', decodedText);
                    console.log('Inventory items:', items.map(i => ({name: i.name, barcode: i.barcode})));
                    const item = items.find(i => i.barcode && i.barcode.trim() === decodedText.trim());
                    
                    if (item) {
                        document.getElementById('barcodeScanResult').innerHTML = `
                            <div style="background: var(--success); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h3 style="margin: 0 0 10px 0;">✓ Item Found</h3>
                                <div style="font-size: 1.2em; font-weight: bold;">${item.name}</div>
                                <div style="margin-top: 10px;">Current Stock: ${item.current_stock} ${item.unit}</div>
                                <div>Min Stock: ${item.min_stock} ${item.unit}</div>
                                <div style="margin-top: 10px; font-weight: bold;">${item.current_stock <= item.min_stock ? '🔴 LOW STOCK' : '🟢 Stock OK'}</div>
                            </div>
                            <button class="btn" onclick="editInventoryFromScan(${item.id})" style="width: 100%; margin-bottom: 10px;">Update Stock</button>
                            <button class="btn" onclick="closeBarcodeScanner()" style="width: 100%; background: var(--gray);">Close</button>
                        `;
                    } else {
                        document.getElementById('barcodeScanResult').innerHTML = `
                            <div style="background: var(--warning); color: var(--charcoal); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h3 style="margin: 0 0 10px 0;">⚠ Item Not Found</h3>
                                <div>Barcode: ${decodedText}</div>
                                <div style="margin-top: 10px;">This barcode is not in your inventory.</div>
                            </div>
                            <button class="btn" onclick="addInventoryWithBarcode('${decodedText}')" style="width: 100%; margin-bottom: 10px; background: var(--success);">Add New Item</button>
                            <button class="btn" onclick="closeBarcodeScanner()" style="width: 100%; background: var(--gray);">Close</button>
                        `;
                    }
                });
        }
        
        function onScanFailure(error) {
            // Ignore scan failures (happens continuously while scanning)
        }
        
        function editInventoryFromScan(id) {
            closeBarcodeScanner();
            editInventoryItem(id);
        }
        
        function addInventoryWithBarcode(barcode) {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                    document.getElementById('barcodeScannerModal').classList.remove('show');
                    openAddInventoryModal(barcode);
                }).catch(err => {
                    console.error(err);
                    document.getElementById('barcodeScannerModal').classList.remove('show');
                    openAddInventoryModal(barcode);
                });
            } else {
                document.getElementById('barcodeScannerModal').classList.remove('show');
                openAddInventoryModal(barcode);
            }
        }
        
        function openAddInventoryModal(barcode) {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Add Inventory Item';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="inventoryItemName" placeholder="Item Name">
                    </div>
                    <div class="form-row">
                        <select id="inventoryCategory">
                            ${getAllInventoryCategories().map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                        <select id="inventoryUnit">
                            <option value="">Select unit...</option>
                            ${getAllMeasurementUnits().map(unit => `<option value="${unit}">${unit}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row">
                        <input type="number" id="currentStock" placeholder="Current Stock" step="0.1">
                        <input type="number" id="minStock" placeholder="Min Stock" step="0.1">
                    </div>
                    <div class="form-group">
                        <input type="text" id="inventoryBarcode" placeholder="Barcode" value="${barcode}" readonly style="background: var(--gray-light);">
                    </div>
                    <button class="btn" onclick="addInventoryItemWithBarcode(); closeAddModal();">Add to Inventory</button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function addInventoryItemWithBarcode() {
            const itemName = document.getElementById('inventoryItemName').value.trim();
            const category = document.getElementById('inventoryCategory').value;
            const unit = document.getElementById('inventoryUnit').value.trim();
            const currentStock = parseFloat(document.getElementById('currentStock').value) || 0;
            const minStock = parseFloat(document.getElementById('minStock').value) || 0;
            const barcode = document.getElementById('inventoryBarcode').value.trim();

            if (!itemName || !unit) {
                alert('Please enter item name and unit');
                return;
            }

            fetch('/api/inventory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: itemName, unit: unit, category: category, current_stock: currentStock, min_stock: minStock, max_stock: 100, barcode: barcode || null })
            }).then(r => r.json()).then(data => {
                console.log('Item added:', data);
                setTimeout(() => loadInventory(), 500);
            });
        }

        // Inventory Functions
        function addInventoryItem() {
            const itemName = document.getElementById('inventoryItemName').value.trim();
            const category = document.getElementById('inventoryCategory').value;
            const unit = document.getElementById('inventoryUnit').value.trim();
            const currentStock = parseFloat(document.getElementById('currentStock').value) || 0;
            const minStock = parseFloat(document.getElementById('minStock').value) || 0;
            const addToIngredients = document.getElementById('addToIngredients')?.checked || false;

            if (!itemName || !unit) {
                alert('Please enter item name and unit');
                return;
            }

            if (addToIngredients) {
                fetch('/api/ingredients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: itemName, cost: 0, unit: unit, servings: 1 })
                }).then(r => r.json()).then(data => {
                    fetch('/api/inventory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ingredient_id: data.id, current_stock: currentStock, min_stock: minStock, max_stock: 100, barcode: null, category: category })
                    }).then(() => {
                        loadInventory();
                        loadIngredients();
                    });
                });
            } else {
                fetch('/api/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: itemName, unit: unit, category: category, current_stock: currentStock, min_stock: minStock, max_stock: 100, barcode: null })
                }).then(() => {
                    loadInventory();
                });
            }
        }

        function loadInventory() {
            fetch('/api/inventory')
                .then(r => r.json())
                .then(items => {
                    document.getElementById('inventoryList').innerHTML = items.map(item => {
                        const status = item.current_stock <= item.min_stock ? '🔴 Low Stock' : '🟢 Good';
                        return `
                            <div class="card">
                                <div class="card-title">${item.name}</div>
                                <div class="card-meta">${status}</div>
                                <div class="card-meta">Stock: ${item.current_stock} / ${item.min_stock} min ${item.unit}</div>
                                ${item.barcode ? `<div class="card-meta" style="font-family: monospace; font-size: 0.85em;">📊 ${item.barcode}</div>` : ''}
                                <div class="card-actions">
                                    <button class="btn" onclick="editInventoryItem(${item.id})" style="background: var(--orange); color: white;">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteInventoryItem(${item.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
        }

        function editInventoryItem(id) {
            fetch('/api/inventory')
                .then(r => r.json())
                .then(items => {
                    const item = items.find(inv => inv.id === id);
                    if (!item) return;
                    
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    modalTitle.textContent = 'Edit Inventory';
                    modalForm.innerHTML = `
                        <div class="form">
                            <div class="form-group">
                                <label>Item Name</label>
                                <input type="text" value="${item.name}" disabled style="background: var(--gray-light);">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="inventoryCategory">
                                    ${getAllInventoryCategories().map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <input type="number" id="currentStock" placeholder="Current Stock" step="0.1" value="${item.current_stock}">
                                <input type="number" id="minStock" placeholder="Min Stock" step="0.1" value="${item.min_stock}">
                            </div>
                            <div class="form-group">
                                <input type="number" id="maxStock" placeholder="Max Stock" step="0.1" value="${item.max_stock}">
                            </div>
                            <div class="form-group">
                                <input type="text" id="inventoryBarcode" placeholder="Barcode (optional)" value="${item.barcode || ''}">
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                <label style="margin: 0; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="isIngredient" ${item.ingredient_id ? 'checked' : ''} style="width: auto; cursor: pointer;">
                                    <span>Available in Ingredients (for recipes)</span>
                                </label>
                            </div>
                            <button class="btn" onclick="updateInventoryItem(${id}); closeAddModal();">Update Inventory</button>
                        </div>
                    `;
                    
                    modal.classList.add('show');
                });
        }
        
        function updateInventoryItem(id) {
            const currentStock = parseFloat(document.getElementById('currentStock').value) || 0;
            const minStock = parseFloat(document.getElementById('minStock').value) || 5;
            const maxStock = parseFloat(document.getElementById('maxStock').value) || 100;
            const barcode = document.getElementById('inventoryBarcode')?.value.trim() || null;
            const category = document.getElementById('inventoryCategory')?.value || 'Food';
            const isIngredient = document.getElementById('isIngredient')?.checked || false;

            fetch('/api/inventory')
                .then(r => r.json())
                .then(items => {
                    const item = items.find(inv => inv.id === id);
                    if (!item) return;

                    if (isIngredient && !item.ingredient_id) {
                        // Add to ingredients
                        fetch('/api/ingredients', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: item.name, cost: 0, unit: item.unit, servings: 1 })
                        }).then(r => r.json()).then(data => {
                            fetch(`/api/inventory/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ingredient_id: data.id, current_stock: currentStock, min_stock: minStock, max_stock: maxStock, barcode: barcode, category: category })
                            }).then(() => {
                                loadInventory();
                                loadIngredients();
                            });
                        });
                    } else if (!isIngredient && item.ingredient_id) {
                        // Remove from ingredients
                        fetch(`/api/inventory/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: item.name, unit: item.unit, ingredient_id: null, current_stock: currentStock, min_stock: minStock, max_stock: maxStock, barcode: barcode, category: category })
                        }).then(() => {
                            fetch(`/api/ingredients/${item.ingredient_id}`, { method: 'DELETE' })
                                .then(() => {
                                    loadInventory();
                                    loadIngredients();
                                });
                        });
                    } else {
                        // Just update inventory
                        fetch(`/api/inventory/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ current_stock: currentStock, min_stock: minStock, max_stock: maxStock, barcode: barcode, category: category })
                        }).then(() => {
                            loadInventory();
                            loadIngredients();
                        });
                    }
                });
        }

        function deleteInventoryItem(id) {
            if (confirm('Delete this inventory item?')) {
                fetch(`/api/inventory/${id}`, { method: 'DELETE' })
                    .then(() => loadInventory());
            }
        }

        // Supplier Functions
        function addSupplier() {
            const name = document.getElementById('supplierName').value;
            const contact = document.getElementById('supplierContact').value;
            const phone = document.getElementById('supplierPhone').value;
            const email = document.getElementById('supplierEmail').value;
            const address = document.getElementById('supplierAddress').value;
            const category = document.getElementById('supplierCategory').value;
            const description = document.getElementById('supplierDescription').value;

            if (!name) {
                alert('Please enter supplier name');
                return;
            }

            fetch('/api/suppliers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, contact, phone, email, address, category, description })
            }).then(() => {
                document.getElementById('supplierName').value = '';
                document.getElementById('supplierContact').value = '';
                document.getElementById('supplierPhone').value = '';
                document.getElementById('supplierEmail').value = '';
                document.getElementById('supplierAddress').value = '';
                document.getElementById('supplierDescription').value = '';
                loadSuppliers();
            });
        }

        function loadSuppliers() {
            fetch('/api/suppliers')
                .then(r => r.json())
                .then(items => {
                    document.getElementById('suppliersList').innerHTML = items.map(item => `
                        <div class="card">
                            <div class="card-header" onclick="toggleSupplierDetails(${item.id})" style="cursor: pointer;">
                                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                                    ${item.name}
                                    <span class="expand-icon" id="supplier-icon-${item.id}">▼</span>
                                </div>
                                <div class="card-meta">${item.category || 'Food'}</div>
                            </div>
                            <div class="card-details" id="supplier-details-${item.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                                <div class="card-meta">Contact: ${item.contact || 'No contact'}</div>
                                <div class="card-meta">Phone: ${item.phone || 'No phone'}</div>
                                <div class="card-meta">Email: ${item.email || 'No email'}</div>
                                ${item.address ? `<div class="card-meta">Address: ${item.address}</div>` : ''}
                                ${item.description ? `<div class="card-meta">Description: ${item.description}</div>` : ''}
                            </div>
                            <div class="card-actions">
                                <button class="btn" onclick="editSupplier(${item.id})" style="background: var(--orange); color: white;">Edit</button>
                                <button class="btn btn-danger" onclick="deleteSupplier(${item.id})">Delete</button>
                            </div>
                        </div>
                    `).join('');
                });
        }

        function editSupplier(id) {
            fetch('/api/suppliers')
                .then(r => r.json())
                .then(items => {
                    const supplier = items.find(item => item.id === id);
                    if (!supplier) return;
                    
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    modalTitle.textContent = 'Edit Supplier';
                    modalForm.innerHTML = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="supplierName" placeholder="Supplier Name" value="${supplier.name}">
                            </div>
                            <div class="form-row">
                                <input type="text" id="supplierContact" placeholder="Contact Person" value="${supplier.contact || ''}">
                                <select id="supplierCategory">
                                    ${getAllSupplierCategories().map(cat => `<option value="${cat}" ${supplier.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <input type="tel" id="supplierPhone" placeholder="Phone Number" value="${supplier.phone || ''}">
                                <input type="email" id="supplierEmail" placeholder="Email" value="${supplier.email || ''}">
                            </div>
                            <div class="form-group">
                                <input type="text" id="supplierAddress" placeholder="Address" value="${supplier.address || ''}">
                            </div>
                            <div class="form-group">
                                <textarea id="supplierDescription" placeholder="Description, notes, terms..." rows="3">${supplier.description || ''}</textarea>
                            </div>
                            <button class="btn" onclick="updateSupplier(${id}); closeAddModal();">Update Supplier</button>
                        </div>
                    `;
                    
                    modal.classList.add('show');
                });
        }
        
        function updateSupplier(id) {
            const name = document.getElementById('supplierName').value;
            const contact = document.getElementById('supplierContact').value;
            const phone = document.getElementById('supplierPhone').value;
            const email = document.getElementById('supplierEmail').value;
            const address = document.getElementById('supplierAddress').value;
            const category = document.getElementById('supplierCategory').value;
            const description = document.getElementById('supplierDescription').value;

            if (!name) {
                alert('Please enter supplier name');
                return;
            }

            fetch(`/api/suppliers/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, contact, phone, email, address, category, description })
            }).then(() => {
                loadSuppliers();
            });
        }

        function deleteSupplier(id) {
            if (confirm('Delete this supplier?')) {
                fetch(`/api/suppliers/${id}`, { method: 'DELETE' })
                    .then(() => loadSuppliers());
            }
        }
        
        function toggleSupplierDetails(id) {
            const details = document.getElementById(`supplier-details-${id}`);
            const icon = document.getElementById(`supplier-icon-${id}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '▲';
            } else {
                details.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        // Tools Functions
        function addTool() {
            const name = document.getElementById('toolName').value;
            const category = document.getElementById('toolCategory').value;
            const status = document.getElementById('toolStatus').value;
            
            if (!name) {
                alert('Please enter tool name');
                return;
            }
            
            const tools = JSON.parse(localStorage.getItem('tools') || '[]');
            tools.push({ id: Date.now(), name, category, status });
            localStorage.setItem('tools', JSON.stringify(tools));
            
            document.getElementById('toolName').value = '';
            loadTools();
        }
        
        function loadTools() {
            const tools = JSON.parse(localStorage.getItem('tools') || '[]');
            document.getElementById('toolsList').innerHTML = tools.map(tool => `
                <div class="card">
                    <div class="card-title">${tool.name}</div>
                    <div class="card-meta">${tool.category} • ${tool.status}</div>
                    <div class="card-actions">
                        <button class="btn btn-danger" onclick="deleteTool(${tool.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function deleteTool(id) {
            if (confirm('Delete this tool?')) {
                const tools = JSON.parse(localStorage.getItem('tools') || '[]');
                const filtered = tools.filter(t => t.id !== id);
                localStorage.setItem('tools', JSON.stringify(filtered));
                loadTools();
            }
        }
        
        // File Upload Functions
        function uploadFile() {
            const fileInput = document.getElementById('fileUpload');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
                    uploadedFiles.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        path: data.path,
                        size: file.size,
                        type: file.type,
                        uploadDate: new Date().toLocaleDateString()
                    });
                    localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                    loadFiles();
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    alert('Upload failed');
                });
            }
            
            fileInput.value = '';
        }
        
        let currentFileFilter = 'All';
        
        function uploadFileFromSection() {
            const fileInput = document.getElementById('fileUpload');
            const files = fileInput.files;
            const category = document.getElementById('uploadFileCategory').value;
            
            if (files.length === 0) return;
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
                    uploadedFiles.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        path: data.path,
                        size: file.size,
                        type: file.type,
                        category: category,
                        uploadDate: new Date().toLocaleDateString()
                    });
                    localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                    loadFiles();
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    alert('Upload failed');
                });
            }
            
            fileInput.value = '';
        }
        
        function filterFiles(category) {
            currentFileFilter = category;
            
            // Update button styles
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.style.background = 'var(--gray)';
            });
            document.getElementById(`filter-${category}`).style.background = 'var(--orange)';
            
            loadFiles();
        }
        
        function loadFiles() {
            const storedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            const existingFiles = [
                {
                    id: 1,
                    name: 'birria-fusion-logo.png',
                    path: '/uploads/1763192867406_birria-fusion-logo.png',
                    size: 0,
                    type: 'image/png',
                    category: 'Images',
                    uploadDate: 'Previously uploaded'
                }
            ];
            
            const allFiles = [...existingFiles, ...storedFiles];
            displayFiles(allFiles);
        }
        
        function displayFiles(files) {
            // Filter files based on current filter
            const filteredFiles = currentFileFilter === 'All' ? files : files.filter(file => file.category === currentFileFilter);
            
            const categoryColors = {
                'General': '#6c757d',
                'Event Contracts': '#ff6b35',
                'Catering Contracts': '#28a745',
                'Permits': '#dc3545',
                'Insurance': '#6f42c1',
                'Marketing': '#20c997',
                'Images': '#17a2b8',
                'Receipts': '#ffc107',
                'Other': '#fd7e14'
            };
            
            document.getElementById('filesList').innerHTML = filteredFiles.map(file => {
                const isImage = file.type && file.type.startsWith('image/');
                const category = file.category || 'General';
                const categoryColor = categoryColors[category] || '#6c757d';
                
                const thumbnail = isImage ? 
                    `<img src="${file.path}" class="file-thumbnail">` : 
                    `<div class="file-icon" style="background: ${categoryColor};">${file.name.split('.').pop().toUpperCase()}</div>`;
                
                return `
                    <div class="file-card">
                        ${thumbnail}
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta" style="color: ${categoryColor}; font-weight: bold;">${category}</div>
                        <div class="file-meta">${file.size > 0 ? `${(file.size / 1024).toFixed(1)} KB` : 'Logo'}</div>
                        <div class="file-actions">
                            <button class="btn" onclick="viewFile('${file.path}')" style="background: #ff6b35; color: white;">View</button>
                            <button class="btn" onclick="editFile(${file.id})" style="background: var(--success); color: white;">Edit</button>
                            ${file.id !== 1 ? `<button class="btn btn-danger" onclick="deleteFile(${file.id})">Del</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function viewFile(path) {
            window.open(path, '_blank');
        }
        
        function editFile(id) {
            // Handle existing logo file
            if (id === 1) {
                const modal = document.getElementById('addModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalForm = document.getElementById('modalForm');
                
                modalTitle.textContent = 'Edit File';
                modalForm.innerHTML = `
                    <div class="form">
                        <div class="form-group">
                            <input type="text" id="fileName" placeholder="File Name" value="birria-fusion-logo.png">
                        </div>
                        <div class="form-group">
                            <select id="fileCategory">
                                <option value="General">General</option>
                                <option value="Event Contracts">Event Contracts</option>
                                <option value="Catering Contracts">Catering Contracts</option>
                                <option value="Permits">Permits</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Marketing" selected>Marketing</option>
                                <option value="Receipts">Receipts</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <button class="btn" onclick="updateFile(${id}); closeAddModal();">Update File</button>
                    </div>
                `;
                
                modal.classList.add('show');
                return;
            }
            
            const files = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            const file = files.find(f => f.id === id);
            if (!file) return;
            
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Edit File';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="fileName" placeholder="File Name" value="${file.name}">
                    </div>
                    <div class="form-group">
                        <select id="fileCategory">
                            ${getAllFileCategories().map(cat => `<option value="${cat}" ${file.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn" onclick="updateFile(${id}); closeAddModal();">Update File</button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function updateFile(id) {
            const newName = document.getElementById('fileName').value;
            const newCategory = document.getElementById('fileCategory').value;
            
            if (!newName) {
                alert('Please enter a file name');
                return;
            }
            
            // Handle existing logo file
            if (id === 1) {
                // Update the existing files array to include the logo with new details
                const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
                const logoFile = {
                    id: 1,
                    name: newName,
                    path: '/uploads/1763192867406_birria-fusion-logo.png',
                    size: 0,
                    type: 'image/png',
                    category: newCategory,
                    uploadDate: 'Previously uploaded'
                };
                
                // Remove any existing logo entry and add updated one
                const filteredFiles = uploadedFiles.filter(f => f.id !== 1);
                filteredFiles.unshift(logoFile);
                localStorage.setItem('uploadedFiles', JSON.stringify(filteredFiles));
                loadFiles();
                return;
            }
            
            const files = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            const fileIndex = files.findIndex(f => f.id === id);
            
            if (fileIndex !== -1) {
                files[fileIndex].name = newName;
                files[fileIndex].category = newCategory;
                localStorage.setItem('uploadedFiles', JSON.stringify(files));
                loadFiles();
            }
        }
        
        function deleteFile(id) {
            if (confirm('Delete this file?')) {
                const files = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
                const filtered = files.filter(f => f.id !== id);
                localStorage.setItem('uploadedFiles', JSON.stringify(filtered));
                loadFiles();
            }
        }
        
        // Catering Functions
        function addCateringOrder() {
            Promise.all([
                fetch('/api/menu').then(r => r.json()),
                fetch('/api/contacts').then(r => r.json())
            ]).then(([menuItems, contacts]) => {
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                    
                    modalTitle.textContent = 'Add Catering Order & Quote';
                    modalForm.innerHTML = `
                        <div class="form">
                            <h4 style="margin-bottom: 10px;">Client Information</h4>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Link to Contact (optional):</label>
                                <select id="cateringContactId" onchange="fillContactInfo()">
                                    <option value="">Select existing contact or enter new...</option>
                                    ${contacts.map(c => `<option value="${c.id}">${c.name}${c.company ? ' - ' + c.company : ''}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Client Name:</label>
                                    <input type="text" id="cateringClient" placeholder="Client Name">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Date:</label>
                                    <input type="date" id="cateringDate">
                                </div>
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Number of Guests:</label>
                                    <input type="number" id="cateringGuests" placeholder="Number of Guests" min="1">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Status:</label>
                                    <select id="cateringStatus">
                                        <option value="Inquiry">Inquiry</option>
                                        <option value="Quote Sent">Quote Sent</option>
                                        <option value="Booked">Booked</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Location:</label>
                                <input type="text" id="cateringLocation" placeholder="Event Location">
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Setup Time (hours):</label>
                                    <input type="number" id="setupTime" placeholder="Setup Time (hours)" step="0.5" min="0">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Start Time:</label>
                                    <input type="time" id="eventStartTime" placeholder="Event Start Time">
                                </div>
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event End Time:</label>
                                    <input type="time" id="eventEndTime" placeholder="Event End Time">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Deposit ($):</label>
                                    <input type="number" id="cateringDeposit" placeholder="Deposit ($)" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Payment Status:</label>
                                <select id="paymentStatus">
                                    <option value="Deposit Needed">Deposit Needed</option>
                                    <option value="Deposit Paid">Deposit Paid</option>
                                    <option value="Partial Payment">Partial Payment</option>
                                    <option value="Paid in Full">Paid in Full</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Notes (shown on PDF):</label>
                                <textarea id="cateringNotes" placeholder="Special requests, dietary restrictions, etc..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Personal Notes (internal only):</label>
                                <textarea id="personalNotes" placeholder="Internal notes, reminders, etc..." rows="2"></textarea>
                            </div>
                            
                            <h4 style="margin: 20px 0 10px 0;">Menu Items</h4>
                            <div id="menuSelection" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                ${menuItems.map(item => {
                                    const suggestedPrice = item.cost / (1 - defaultMargin / 100);
                                    return `
                                    <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <h4 style="margin: 0; color: var(--charcoal);">${item.name}</h4>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" id="qty-${item.id}" min="0" value="0" style="width: 60px; padding: 6px; text-align: center; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()" placeholder="0">
                                                <span style="font-weight: 500; font-size: 0.9em;">servings</span>
                                            </div>
                                        </div>
                                        <div id="cost-display-${item.id}" style="display: none; background: var(--gray-light); padding: 6px; border-radius: 4px; margin-bottom: 6px; font-size: 0.85em;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                                <div>Food Cost: <strong style="color: var(--orange);">$<span id="total-cost-${item.id}">0.00</span></strong></div>
                                                <div>Suggested: <strong style="color: var(--green);">$<span id="suggested-price-${item.id}">0.00</span></strong></div>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-weight: 500; font-size: 0.9em;">Your Price: $</label>
                                            <input type="number" id="price-${item.id}" step="0.01" min="0" value="0" style="flex: 1; padding: 6px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                            
                            <h4 style="margin-bottom: 10px;">Additional Services</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div>
                                    <label style="font-weight: 500; display: block; margin-bottom: 5px;">Service Type:</label>
                                    <select id="serviceType" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;">
                                        <option value="Delivery">Delivery Only</option>
                                        <option value="On-Premise">On-Premise Service</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight: 500; display: block; margin-bottom: 5px;">Number of Staff:</label>
                                    <input type="number" id="staffCount" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Staff Cost: $</label>
                                <input type="number" id="staffCost" step="0.01" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                            </div>
                            
                            <h4 style="margin: 20px 0 10px 0;">Equipment</h4>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Equipment Provided By:</label>
                                <select id="equipmentProvider" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="toggleEquipmentCost()">
                                    <option value="Birria Fusion">Birria Fusion</option>
                                    <option value="Client Provides">Client Provides</option>
                                    <option value="Third-Party Rental">Third-Party Rental</option>
                                </select>
                            </div>
                            <div id="equipmentCostSection" style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Equipment Cost: $</label>
                                <input type="number" id="equipmentCost" step="0.01" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Equipment Notes (optional):</label>
                                <textarea id="equipmentNotes" rows="2" placeholder="List specific equipment items..." style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;"></textarea>
                            </div>
                            
                            <div style="text-align: right; margin-bottom: 15px; font-weight: bold; font-size: 1.1em; border-top: 2px solid var(--orange); padding-top: 10px; margin-top: 10px;">
                                Total: $<span id="newQuoteTotal">0.00</span>
                            </div>
                            <button class="btn" onclick="saveCateringOrderWithQuote(); closeAddModal();">Add Catering Order</button>
                        </div>
                    `;
                    
                    modal.classList.add('show');
                });
        }
        
        function updateNewQuoteTotal() {
            fetch('/api/menu')
                .then(r => r.json())
                .then(menuItems => {
                    const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                    let total = 0;
                    menuItems.forEach(item => {
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const priceInput = document.getElementById(`price-${item.id}`);
                        if (qtyInput && priceInput) {
                            const qty = parseInt(qtyInput.value) || 0;
                            const totalPrice = parseFloat(priceInput.value) || 0;
                            const totalCostSpan = document.getElementById(`total-cost-${item.id}`);
                            const suggestedPriceSpan = document.getElementById(`suggested-price-${item.id}`);
                            const costDisplay = document.getElementById(`cost-display-${item.id}`);
                            
                            if (qty > 0) {
                                const totalFoodCost = qty * item.cost;
                                const suggestedPrice = item.cost / (1 - defaultMargin / 100);
                                const totalSuggestedPrice = qty * suggestedPrice;
                                if (totalCostSpan) totalCostSpan.textContent = totalFoodCost.toFixed(2);
                                if (suggestedPriceSpan) suggestedPriceSpan.textContent = totalSuggestedPrice.toFixed(2);
                                if (costDisplay) costDisplay.style.display = 'block';
                                total += totalPrice;
                            } else {
                                if (costDisplay) costDisplay.style.display = 'none';
                            }
                        }
                    });
                    const staffCost = parseFloat(document.getElementById('staffCost')?.value || 0);
                    const equipmentCost = parseFloat(document.getElementById('equipmentCost')?.value || 0);
                    const grandTotal = total + staffCost + equipmentCost;
                    document.getElementById('newQuoteTotal').textContent = grandTotal.toFixed(2);
                });
        }
        
        function toggleEquipmentCost() {
            const provider = document.getElementById('equipmentProvider')?.value;
            const costSection = document.getElementById('equipmentCostSection');
            if (costSection) {
                costSection.style.display = provider === 'Client Provides' ? 'none' : 'block';
                if (provider === 'Client Provides') {
                    document.getElementById('equipmentCost').value = 0;
                    updateNewQuoteTotal();
                }
            }
        }
        
        async function fillContactInfo() {
            const contactId = document.getElementById('cateringContactId').value;
            if (!contactId) return;
            
            const contacts = await fetch('/api/contacts').then(r => r.json());
            const contact = contacts.find(c => c.id == contactId);
            if (contact) {
                document.getElementById('cateringClient').value = contact.name;
            }
        }
        
        function saveCateringOrderWithQuote() {
            const contactId = document.getElementById('cateringContactId')?.value || null;
            const client = document.getElementById('cateringClient')?.value.trim() || '';
            const date = document.getElementById('cateringDate')?.value || '';
            const guests = parseInt(document.getElementById('cateringGuests')?.value) || 0;
            const status = document.getElementById('cateringStatus')?.value || 'Inquiry';
            const location = document.getElementById('cateringLocation')?.value || '';
            const setupTime = parseFloat(document.getElementById('setupTime')?.value) || 0;
            const eventStartTime = document.getElementById('eventStartTime')?.value || '';
            const eventEndTime = document.getElementById('eventEndTime')?.value || '';
            const deposit = parseFloat(document.getElementById('cateringDeposit')?.value) || 0;
            const notes = document.getElementById('cateringNotes')?.value || '';
            const personalNotes = document.getElementById('personalNotes')?.value || '';
            const serviceType = document.getElementById('serviceType')?.value || 'Delivery';
            const staffCount = parseInt(document.getElementById('staffCount')?.value) || 0;
            const staffCost = parseFloat(document.getElementById('staffCost')?.value) || 0;
            const equipmentProvider = document.getElementById('equipmentProvider')?.value || 'Birria Fusion';
            const equipmentCost = parseFloat(document.getElementById('equipmentCost')?.value) || 0;
            const equipmentNotes = document.getElementById('equipmentNotes')?.value || '';
            const paymentStatus = document.getElementById('paymentStatus')?.value || 'Deposit Needed';
            
            if (!client || !date || !guests) {
                alert('Please fill in client name, date, and number of guests');
                return;
            }
            
            fetch('/api/menu')
                .then(r => r.json())
                .then(menuItems => {
                    const selectedMenu = [];
                    let totalPrice = 0;
                    
                    menuItems.forEach(item => {
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const priceInput = document.getElementById(`price-${item.id}`);
                        if (qtyInput && priceInput) {
                            const qty = parseInt(qtyInput.value) || 0;
                            const totalItemPrice = parseFloat(priceInput.value) || 0;
                            if (qty > 0) {
                                selectedMenu.push({
                                    id: item.id,
                                    name: item.name,
                                    price: totalItemPrice / qty,
                                    totalPrice: totalItemPrice,
                                    foodCost: item.cost,
                                    quantity: qty,
                                    total: totalItemPrice
                                });
                                totalPrice += totalItemPrice;
                            }
                        }
                    });
                    
                    const grandTotal = totalPrice + staffCost + equipmentCost;
                    
                    return fetch('/api/catering', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contact_id: contactId,
                            client,
                            date,
                            guests,
                            status,
                            price: grandTotal,
                            deposit,
                            setup_time: setupTime,
                            selected_menu: JSON.stringify(selectedMenu),
                            service_type: serviceType,
                            staff_count: staffCount,
                            staff_cost: staffCost,
                            notes,
                            location,
                            event_start_time: eventStartTime,
                            event_end_time: eventEndTime,
                            equipment_provider: equipmentProvider,
                            equipment_cost: equipmentCost,
                            equipment_notes: equipmentNotes,
                            payment_status: paymentStatus,
                            personal_notes: personalNotes
                        })
                    });
                })
                .then(() => loadCatering());
        }
        
        function saveCateringOrder() {
            const client = document.getElementById('cateringClient')?.value.trim() || '';
            const date = document.getElementById('cateringDate')?.value || '';
            const guests = parseInt(document.getElementById('cateringGuests')?.value) || 0;
            const status = document.getElementById('cateringStatus')?.value || 'Inquiry';
            const location = document.getElementById('cateringLocation')?.value || '';
            const time = document.getElementById('cateringTime')?.value || '';
            const setupTime = parseFloat(document.getElementById('setupTime')?.value) || 0;
            const deposit = parseFloat(document.getElementById('cateringDeposit')?.value) || 0;
            const notes = document.getElementById('cateringNotes')?.value || '';
            const personalNotes = document.getElementById('personalNotes')?.value || '';
            
            if (!client || !date || !guests) {
                alert('Please fill in client name, date, and number of guests');
                return;
            }
            
            fetch('/api/catering', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client, date, guests, status, price: 0, deposit, setup_time: setupTime, notes, personal_notes: personalNotes })
            }).then(() => loadCatering());
        }
        
        function loadCatering() {
            fetch('/api/catering')
                .then(r => r.json())
                .then(orders => {
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate stats
            const upcomingOrders = orders.filter(o => o.date >= today && o.status === 'Booked').length;
            const bookedOrders = orders.filter(o => o.status === 'Booked').length;
            const totalRevenue = orders.filter(o => o.status === 'Completed').reduce((sum, o) => sum + (o.price || 0), 0);
            const pendingQuotes = orders.filter(o => o.status === 'Quote Sent').length;
            
            document.getElementById('cateringStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${upcomingOrders}</div>
                    <div class="stat-label">Upcoming Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${bookedOrders}</div>
                    <div class="stat-label">Booked Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${totalRevenue.toFixed(0)}</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: ${pendingQuotes > 0 ? 'var(--warning)' : 'var(--success)'}">${pendingQuotes}</div>
                    <div class="stat-label">Pending Quotes</div>
                </div>
            `;
            
            // Show orders sorted by date
            const sortedOrders = orders.sort((a, b) => new Date(a.date) - new Date(b.date));
            document.getElementById('cateringList').innerHTML = sortedOrders.map(order => {
                const statusColors = {
                    'Inquiry': '#6c757d',
                    'Quote Sent': '#ffc107',
                    'Booked': '#28a745',
                    'Completed': '#17a2b8',
                    'Cancelled': '#dc3545'
                };
                
                return `
                    <div class="card" style="border-left: 4px solid ${order.service_type === 'On-Premise' ? '#17a2b8' : '#ff6b35'};">
                        <div class="card-header" onclick="toggleCateringDetails(${order.id})" style="cursor: pointer;">
                            <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${order.client}</span>
                                <div style="display: flex; gap: 8px;">
                                    ${order.status === 'Booked' || order.status === 'Completed' ? `<span style="background: ${order.payment_status === 'Paid in Full' ? '#28a745' : order.payment_status === 'Deposit Paid' ? '#ffc107' : order.payment_status === 'Partial Payment' ? '#17a2b8' : '#dc3545'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold;">${order.payment_status || 'Deposit Needed'}</span>` : ''}
                                    <span style="color: ${statusColors[order.status]}; font-size: 0.8em; font-weight: bold;">${order.status}</span>
                                </div>
                            </div>
                            <div class="card-meta">${order.date} • ${order.guests} guests${order.price > 0 ? ` • $${order.price.toFixed(2)}` : ''}</div>
                            ${order.location ? `<div class="card-meta">${order.location}</div>` : ''}
                        </div>
                        <div class="card-details" id="catering-details-${order.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); overflow-wrap: break-word; word-wrap: break-word;">
                            ${order.event_start_time || order.event_end_time ? `<div class="card-meta">Event: ${order.event_start_time || 'TBD'} - ${order.event_end_time || 'TBD'}${order.setup_time > 0 ? ` (${order.setup_time}hr setup)` : ''}</div>` : order.setup_time > 0 ? `<div class="card-meta">Setup: ${order.setup_time} hours</div>` : ''}
                            ${order.service_type || order.staff_count > 0 ? `<div class="card-meta">${order.service_type || ''}${order.service_type && order.staff_count > 0 ? ' • ' : ''}${order.staff_count > 0 ? `${order.staff_count} staff - $${order.staff_cost.toFixed(2)}` : ''}</div>` : ''}
                            ${order.equipment_provider ? `<div class="card-meta">Equipment: ${order.equipment_provider}${order.equipment_cost > 0 ? ` - $${order.equipment_cost.toFixed(2)}` : ''}${order.equipment_notes ? ` (${order.equipment_notes})` : ''}</div>` : ''}
                            ${order.deposit > 0 || (order.status === 'Booked' || order.status === 'Completed') ? `<div class="card-meta">Payment: ${order.payment_status || 'Deposit Needed'}${order.deposit > 0 ? ` - $${order.deposit.toFixed(2)} deposit` : ''}</div>` : ''}
                            ${(() => {
                                let selectedMenu = [];
                                if (order.selected_menu) {
                                    try {
                                        selectedMenu = typeof order.selected_menu === 'string' ? JSON.parse(order.selected_menu) : order.selected_menu;
                                    } catch(e) {}
                                }
                                if (selectedMenu && selectedMenu.length > 0) {
                                    return `<div class="card-meta" style="margin-top: 8px;"><strong>Menu Items:</strong><ul style="margin: 5px 0 0 20px;">${selectedMenu.map(item => `<li>${item.name} (${item.quantity} servings) - $${(item.total || item.totalPrice).toFixed(2)}</li>`).join('')}</ul></div>`;
                                }
                                return '';
                            })()}
                            ${order.notes ? `<div class="card-meta" style="font-style: italic; margin-top: 8px;">Event Notes: ${order.notes}</div>` : ''}
                            ${order.personal_notes ? `<div class="card-meta" style="font-style: italic; margin-top: 8px; color: #6c757d;">Personal Notes: ${order.personal_notes}</div>` : ''}
                            <div class="card-actions" style="margin-top: 10px;">
                                <button class="btn" onclick="editCateringOrder(${order.id})" style="background: var(--orange); color: white;">Edit</button>
                                <button class="btn" onclick="printCateringDetails(${order.id})" style="background: #666; color: white;">Print</button>
                                <button class="btn" onclick="exportCateringPDF(${order.id})" style="background: var(--warning); color: white;">PDF</button>
                                <button class="btn" onclick="updateCateringStatus(${order.id})" style="background: var(--success); color: white;">Status</button>
                                <button class="btn" onclick="openNotesModal('catering', ${order.id}, '${order.client.replace(/'/g, "\\'")}')" style="background: #666; color: white;">Notes</button>
                                <button class="btn" onclick="archiveCateringOrder(${order.id})" style="background: #6c757d; color: white;">Archive</button>
                                <button class="btn btn-danger" onclick="deleteCateringOrder(${order.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
                });
        }
        
        function toggleCateringDetails(id) {
            const details = document.getElementById(`catering-details-${id}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }
        
        function editCateringOrder(id) {
            let currentOrder;
            Promise.all([
                fetch('/api/catering').then(r => r.json()),
                fetch('/api/menu').then(r => r.json()),
                fetch('/api/contacts').then(r => r.json())
            ]).then(([orders, menuItems, contacts]) => {
                currentOrder = orders.find(o => o.id === id);
                if (!currentOrder) return;
                    const order = currentOrder;
                    const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                    
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    modalTitle.textContent = 'Edit Catering Order & Quote';
                    modalForm.innerHTML = `
                        <div class="form">
                            <h4 style="margin-bottom: 10px;">Client Information</h4>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Link to Contact (optional):</label>
                                <select id="cateringContactId" onchange="fillContactInfo()">
                                    <option value="">Select existing contact or enter new...</option>
                                    ${contacts.map(c => `<option value="${c.id}" ${c.id == order.contact_id ? 'selected' : ''}>${c.name}${c.company ? ' - ' + c.company : ''}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Client Name:</label>
                                    <input type="text" id="cateringClient" placeholder="Client Name" value="${order.client}">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Date:</label>
                                    <input type="date" id="cateringDate" value="${order.date}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Number of Guests:</label>
                                    <input type="number" id="cateringGuests" placeholder="Number of Guests" min="1" value="${order.guests}">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Status:</label>
                                    <select id="cateringStatus">
                                        <option value="Inquiry" ${order.status === 'Inquiry' ? 'selected' : ''}>Inquiry</option>
                                        <option value="Quote Sent" ${order.status === 'Quote Sent' ? 'selected' : ''}>Quote Sent</option>
                                        <option value="Booked" ${order.status === 'Booked' ? 'selected' : ''}>Booked</option>
                                        <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Location:</label>
                                <input type="text" id="cateringLocation" placeholder="Event Location" value="${order.location || ''}">
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Setup Time (hours):</label>
                                    <input type="number" id="setupTime" placeholder="Setup Time (hours)" step="0.5" min="0" value="${order.setup_time || 0}">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Start Time:</label>
                                    <input type="time" id="eventStartTime" placeholder="Event Start Time" value="${order.event_start_time || ''}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event End Time:</label>
                                    <input type="time" id="eventEndTime" placeholder="Event End Time" value="${order.event_end_time || ''}">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Deposit ($):</label>
                                    <input type="number" id="cateringDeposit" placeholder="Deposit ($)" step="0.01" min="0" value="${order.deposit || 0}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Payment Status:</label>
                                <select id="paymentStatus">
                                    <option value="Deposit Needed" ${(order.payment_status || 'Deposit Needed') === 'Deposit Needed' ? 'selected' : ''}>Deposit Needed</option>
                                    <option value="Deposit Paid" ${order.payment_status === 'Deposit Paid' ? 'selected' : ''}>Deposit Paid</option>
                                    <option value="Partial Payment" ${order.payment_status === 'Partial Payment' ? 'selected' : ''}>Partial Payment</option>
                                    <option value="Paid in Full" ${order.payment_status === 'Paid in Full' ? 'selected' : ''}>Paid in Full</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Event Notes (shown on PDF):</label>
                                <textarea id="cateringNotes" placeholder="Special requests, dietary restrictions, etc..." rows="2">${order.notes || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--charcoal);">Personal Notes (internal only):</label>
                                <textarea id="editPersonalNotes" placeholder="Internal notes, reminders, etc..." rows="2">${order.personal_notes || ''}</textarea>
                            </div>
                            
                            <h4 style="margin: 20px 0 10px 0;">Menu Items</h4>
                            <div id="menuSelection" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                ${menuItems.map(item => {
                                    const suggestedPrice = item.cost / (1 - defaultMargin / 100);
                                    return `
                                    <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <h4 style="margin: 0; color: var(--charcoal);">${item.name}</h4>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" id="qty-${item.id}" min="0" value="0" style="width: 60px; padding: 6px; text-align: center; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()" placeholder="0">
                                                <span style="font-weight: 500; font-size: 0.9em;">servings</span>
                                            </div>
                                        </div>
                                        <div id="cost-display-${item.id}" style="display: none; background: var(--gray-light); padding: 6px; border-radius: 4px; margin-bottom: 6px; font-size: 0.85em;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                                <div>Food Cost: <strong style="color: var(--orange);">$<span id="total-cost-${item.id}">0.00</span></strong></div>
                                                <div>Suggested: <strong style="color: var(--green);">$<span id="suggested-price-${item.id}">0.00</span></strong></div>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-weight: 500; font-size: 0.9em;">Your Price: $</label>
                                            <input type="number" id="price-${item.id}" step="0.01" min="0" value="0" style="flex: 1; padding: 6px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                            
                            <h4 style="margin-bottom: 10px;">Additional Services</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div>
                                    <label style="font-weight: 500; display: block; margin-bottom: 5px;">Service Type:</label>
                                    <select id="serviceType" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;">
                                        <option value="Delivery">Delivery Only</option>
                                        <option value="On-Premise">On-Premise Service</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight: 500; display: block; margin-bottom: 5px;">Number of Staff:</label>
                                    <input type="number" id="staffCount" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Staff Cost: $</label>
                                <input type="number" id="staffCost" step="0.01" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                            </div>
                            
                            <h4 style="margin: 20px 0 10px 0;">Equipment</h4>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Equipment Provided By:</label>
                                <select id="equipmentProvider" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="toggleEquipmentCost()">
                                    <option value="Birria Fusion">Birria Fusion</option>
                                    <option value="Client Provides">Client Provides</option>
                                    <option value="Third-Party Rental">Third-Party Rental</option>
                                </select>
                            </div>
                            <div id="equipmentCostSection" style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Equipment Cost: $</label>
                                <input type="number" id="equipmentCost" step="0.01" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateNewQuoteTotal()">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Equipment Notes (optional):</label>
                                <textarea id="equipmentNotes" rows="2" placeholder="List specific equipment items..." style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;"></textarea>
                            </div>
                            
                            <div style="text-align: right; margin-bottom: 15px; font-weight: bold; font-size: 1.1em; border-top: 2px solid var(--orange); padding-top: 10px; margin-top: 10px;">
                                Total: $<span id="newQuoteTotal">0.00</span>
                            </div>
                            <button class="btn" onclick="updateCateringOrderWithQuote(${id});">Update Catering Order</button>
                        </div>
                    `;
                    
                    // Load existing menu items
                    let selectedMenu = [];
                    if (order.selected_menu) {
                        selectedMenu = typeof order.selected_menu === 'string' ? JSON.parse(order.selected_menu) : order.selected_menu;
                    }
                    
                    if (selectedMenu && selectedMenu.length > 0) {
                        selectedMenu.forEach(menuItem => {
                            const qtyInput = document.getElementById(`qty-${menuItem.id}`);
                            const priceInput = document.getElementById(`price-${menuItem.id}`);
                            if (qtyInput) qtyInput.value = menuItem.quantity;
                            if (priceInput) priceInput.value = menuItem.totalPrice || menuItem.total;
                        });
                    }
                    
                    // Load service details
                    document.getElementById('serviceType').value = order.service_type || 'Delivery';
                    document.getElementById('staffCount').value = order.staff_count || 0;
                    document.getElementById('staffCost').value = order.staff_cost || 0;
                    
                    // Load equipment details
                    document.getElementById('equipmentProvider').value = order.equipment_provider || 'Birria Fusion';
                    document.getElementById('equipmentCost').value = order.equipment_cost || 0;
                    document.getElementById('equipmentNotes').value = order.equipment_notes || '';
                    toggleEquipmentCost();
                    
                    updateNewQuoteTotal();
                    modal.classList.add('show');
                });
        }
        
        function updateCateringOrderWithQuote(id) {
            const contactId = document.getElementById('cateringContactId')?.value || null;
            const client = document.getElementById('cateringClient')?.value.trim() || '';
            const date = document.getElementById('cateringDate')?.value || '';
            const guests = parseInt(document.getElementById('cateringGuests')?.value) || 0;
            const status = document.getElementById('cateringStatus')?.value || 'Inquiry';
            const location = document.getElementById('cateringLocation')?.value || '';
            const setupTime = parseFloat(document.getElementById('setupTime')?.value) || 0;
            const eventStartTime = document.getElementById('eventStartTime')?.value || '';
            const eventEndTime = document.getElementById('eventEndTime')?.value || '';
            const deposit = parseFloat(document.getElementById('cateringDeposit')?.value) || 0;
            const notes = document.getElementById('cateringNotes')?.value || '';
            const personalNotes = document.getElementById('editPersonalNotes')?.value || '';
            const serviceType = document.getElementById('serviceType')?.value || 'Delivery';
            const staffCount = parseInt(document.getElementById('staffCount')?.value) || 0;
            const staffCost = parseFloat(document.getElementById('staffCost')?.value) || 0;
            const equipmentProvider = document.getElementById('equipmentProvider')?.value || 'Birria Fusion';
            const paymentStatus = document.getElementById('paymentStatus')?.value || 'Deposit Needed';
            const equipmentCost = parseFloat(document.getElementById('equipmentCost')?.value) || 0;
            const equipmentNotes = document.getElementById('equipmentNotes')?.value || '';
            
            if (!client || !date || !guests) {
                alert('Please fill in client name, date, and number of guests');
                return;
            }
            
            fetch('/api/menu')
                .then(r => r.json())
                .then(menuItems => {
                    const selectedMenu = [];
                    let totalPrice = 0;
                    
                    menuItems.forEach(item => {
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const priceInput = document.getElementById(`price-${item.id}`);
                        if (qtyInput && priceInput) {
                            const qty = parseInt(qtyInput.value) || 0;
                            const totalItemPrice = parseFloat(priceInput.value) || 0;
                            if (qty > 0) {
                                selectedMenu.push({
                                    id: item.id,
                                    name: item.name,
                                    price: totalItemPrice / qty,
                                    totalPrice: totalItemPrice,
                                    foodCost: item.cost,
                                    quantity: qty,
                                    total: totalItemPrice
                                });
                                totalPrice += totalItemPrice;
                            }
                        }
                    });
                    
                    const grandTotal = totalPrice + staffCost + equipmentCost;
                    
                    return fetch(`/api/catering/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contact_id: contactId,
                            client,
                            date,
                            guests,
                            status,
                            price: grandTotal,
                            deposit,
                            setup_time: setupTime,
                            selected_menu: JSON.stringify(selectedMenu),
                            staff_assigned: null,
                            service_type: serviceType,
                            staff_count: staffCount,
                            staff_cost: staffCost,
                            notes,
                            location,
                            event_start_time: eventStartTime,
                            event_end_time: eventEndTime,
                            equipment_provider: equipmentProvider,
                            equipment_cost: equipmentCost,
                            equipment_notes: equipmentNotes,
                            payment_status: paymentStatus,
                            personal_notes: personalNotes
                        })
                    });
                })
                .then(() => { document.getElementById('addModal').classList.remove('show'); loadCatering(); });
        }
        
        function updateCateringStatus(id) {
            fetch('/api/catering')
                .then(r => r.json())
                .then(orders => {
                    const order = orders.find(o => o.id === id);
                    if (!order) return;
                    
                    const statusOptions = ['Inquiry', 'Quote Sent', 'Booked', 'Completed', 'Cancelled'];
                    const optionsText = statusOptions.map((status, index) => `${index + 1}. ${status}`).join('\n');
                    
                    const choice = prompt(`Current status: ${order.status}\n\nSelect new status:\n${optionsText}\n\nEnter number (1-5):`);
                    const choiceNum = parseInt(choice);
                    
                    if (choiceNum >= 1 && choiceNum <= 5) {
                        const newStatus = statusOptions[choiceNum - 1];
                        fetch(`/api/catering/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...order, status: newStatus, setup_time: order.setup_time })
                        }).then(() => loadCatering());
                    }
                });
        }
        
        function buildQuote(id) {
            let currentOrder;
            fetch('/api/catering')
                .then(r => r.json())
                .then(orders => {
                    currentOrder = orders.find(o => o.id === id);
                    if (!currentOrder) return;
                    
                    // Get menu items for quote builder
                    return fetch('/api/menu');
                })
                .then(r => r.json())
                .then(menuItems => {
                    const order = currentOrder;
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    modalTitle.textContent = `Build Quote - ${order.client}`;
                    modalForm.innerHTML = `
                        <div class="form">
                            <h4 style="margin-bottom: 10px;">Select Menu Items</h4>
                            <div id="menuSelection" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                ${menuItems.map(item => {
                                    const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                                    const suggestedPrice = item.cost / (1 - defaultMargin / 100);
                                    return `
                                    <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <h4 style="margin: 0; color: var(--charcoal);">${item.name}</h4>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" id="qty-${item.id}" min="0" value="0" style="width: 70px; padding: 8px; text-align: center; border: 2px solid var(--border); border-radius: 6px;" onchange="updateQuoteTotal()" placeholder="0">
                                                <span style="font-weight: 500;">servings</span>
                                            </div>
                                        </div>
                                        <div id="cost-display-${item.id}" style="display: none; background: var(--gray-light); padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 0.9em;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                                <div>Food Cost: <strong style="color: var(--orange);">$<span id="total-cost-${item.id}">0.00</span></strong></div>
                                                <div>Suggested: <strong style="color: var(--green);">$<span id="suggested-price-${item.id}">0.00</span></strong></div>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-weight: 500;">Your Price: $</label>
                                            <input type="number" id="price-${item.id}" step="0.01" min="0" value="0" style="flex: 1; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateQuoteTotal()">
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                            <div style="border-top: 2px solid var(--border); padding-top: 15px; margin-top: 15px;">
                                <h4 style="margin-bottom: 10px;">Additional Services</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-weight: 500; display: block; margin-bottom: 5px;">Service Type:</label>
                                        <select id="serviceType" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;">
                                            <option value="Delivery">Delivery Only</option>
                                            <option value="On-Premise">On-Premise Service</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-weight: 500; display: block; margin-bottom: 5px;">Number of Staff:</label>
                                        <input type="number" id="staffCount" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateQuoteTotal()">
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <label style="font-weight: 500; display: block; margin-bottom: 5px;">Staff Cost: $</label>
                                    <input type="number" id="staffCost" step="0.01" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: 6px;" onchange="updateQuoteTotal()">
                                </div>
                            </div>
                            <div style="text-align: right; margin-bottom: 15px; font-weight: bold; font-size: 1.1em; border-top: 2px solid var(--orange); padding-top: 10px; margin-top: 10px;">
                                Total: $<span id="quoteTotal">0.00</span>
                            </div>
                            <button class="btn" onclick="saveQuote(${id}); closeAddModal();">Save Quote</button>
                        </div>
                    `;
                    
                    // Load existing quote if available
                    let selectedMenu = [];
                    if (order.selected_menu) {
                        selectedMenu = typeof order.selected_menu === 'string' ? JSON.parse(order.selected_menu) : order.selected_menu;
                    } else if (order.selectedMenu) {
                        selectedMenu = typeof order.selectedMenu === 'string' ? JSON.parse(order.selectedMenu) : order.selectedMenu;
                    }
                    
                    if (selectedMenu && selectedMenu.length > 0) {
                        selectedMenu.forEach(menuItem => {
                            const qtyInput = document.getElementById(`qty-${menuItem.id}`);
                            const priceInput = document.getElementById(`price-${menuItem.id}`);
                            if (qtyInput) {
                                qtyInput.value = menuItem.quantity;
                            }
                            if (priceInput && menuItem.totalPrice !== undefined) {
                                priceInput.value = menuItem.totalPrice.toFixed(2);
                            }
                        });
                    }
                    
                    // Load service details with defaults
                    document.getElementById('serviceType').value = order.service_type || 'Delivery';
                    document.getElementById('staffCount').value = order.staff_count || 0;
                    document.getElementById('staffCost').value = order.staff_cost || 0;
                    
                    updateQuoteTotal();
                    
                    modal.classList.add('show');
                });
        }
        
        function updateQuoteTotal() {
            const staffCostInput = document.getElementById('staffCost');
            if (!staffCostInput) return;
            
            fetch('/api/menu')
                .then(r => r.json())
                .then(menuItems => {
                    const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                    let total = 0;
                    menuItems.forEach(item => {
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const priceInput = document.getElementById(`price-${item.id}`);
                        if (qtyInput && priceInput) {
                            const qty = parseInt(qtyInput.value) || 0;
                            const totalPrice = parseFloat(priceInput.value) || 0;
                            const totalCostSpan = document.getElementById(`total-cost-${item.id}`);
                            const suggestedPriceSpan = document.getElementById(`suggested-price-${item.id}`);
                            const costDisplay = document.getElementById(`cost-display-${item.id}`);
                            
                            if (qty > 0) {
                                const totalFoodCost = qty * item.cost;
                                const suggestedPrice = item.cost / (1 - defaultMargin / 100);
                                const totalSuggestedPrice = qty * suggestedPrice;
                                if (totalCostSpan) totalCostSpan.textContent = totalFoodCost.toFixed(2);
                                if (suggestedPriceSpan) suggestedPriceSpan.textContent = totalSuggestedPrice.toFixed(2);
                                if (costDisplay) costDisplay.style.display = 'block';
                                total += totalPrice;
                            } else {
                                if (costDisplay) costDisplay.style.display = 'none';
                            }
                        }
                    });
                    const staffCost = parseFloat(document.getElementById('staffCost')?.value || 0);
                    const grandTotal = total + staffCost;
                    document.getElementById('quoteTotal').textContent = grandTotal.toFixed(2);
                });
        }
        
        function saveQuote(orderId) {
            let currentOrder;
            fetch('/api/catering')
                .then(r => r.json())
                .then(orders => {
                    currentOrder = orders.find(o => o.id === orderId);
                    return fetch('/api/menu');
                })
                .then(r => r.json())
                .then(menuItems => {
                    const selectedMenu = [];
                    let totalPrice = 0;
                    
                    menuItems.forEach(item => {
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const priceInput = document.getElementById(`price-${item.id}`);
                        if (qtyInput && priceInput) {
                            const qty = parseInt(qtyInput.value) || 0;
                            const totalItemPrice = parseFloat(priceInput.value) || 0;
                            if (qty > 0) {
                                selectedMenu.push({
                                    id: item.id,
                                    name: item.name,
                                    price: totalItemPrice / qty,
                                    totalPrice: totalItemPrice,
                                    foodCost: item.cost,
                                    quantity: qty,
                                    total: totalItemPrice
                                });
                                totalPrice += totalItemPrice;
                            }
                        }
                    });
                    
                    const serviceType = document.getElementById('serviceType').value;
                    const staffCount = parseInt(document.getElementById('staffCount').value) || 0;
                    const staffCost = parseFloat(document.getElementById('staffCost').value) || 0;
                    const grandTotal = totalPrice + staffCost;
                    
                    return fetch(`/api/catering/${orderId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client: currentOrder.client,
                            date: currentOrder.date,
                            guests: currentOrder.guests,
                            price: grandTotal,
                            status: currentOrder.status,
                            deposit: currentOrder.deposit,
                            setup_time: currentOrder.setup_time,
                            selected_menu: JSON.stringify(selectedMenu),
                            staff_assigned: currentOrder.staff_assigned,
                            service_type: serviceType,
                            staff_count: staffCount,
                            staff_cost: staffCost,
                            notes: currentOrder.notes
                        })
                    });
                })
                .then(() => loadCatering());
        }
        
        async function exportCateringPDF(id) {
            const response = await fetch('/api/catering');
            const orders = await response.json();
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            // Load jsPDF library if not already loaded
            if (typeof window.jsPDF === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = async () => await generateCateringPDF(order);
                document.head.appendChild(script);
            } else {
                await generateCateringPDF(order);
            }
        }
        
        async function generateCateringPDF(order) {
            const doc = new window.jspdf.jsPDF();
            
            // Parse selectedMenu if it's a string
            let selectedMenu = [];
            if (order.selected_menu) {
                selectedMenu = typeof order.selected_menu === 'string' ? JSON.parse(order.selected_menu) : order.selected_menu;
            } else if (order.selectedMenu) {
                selectedMenu = typeof order.selectedMenu === 'string' ? JSON.parse(order.selectedMenu) : order.selectedMenu;
            }
            
            // Fetch business info from database
            const response = await fetch('/api/business-info');
            const businessInfo = await response.json();
            
            // Add logo
            const logo = new Image();
            logo.src = '/uploads/1763192867406_birria-fusion-logo.png';
            logo.onload = function() {
                doc.addImage(logo, 'PNG', 15, 10, 30, 30);
                
                // Header - Company Name
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 107, 53);
                doc.text('BIRRIA FUSION', 50, 22);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                const phone = businessInfo.phone || '(555) 123-4567';
                const email = businessInfo.email || 'info@birriafusion.com';
                const website = businessInfo.website || 'www.birriafusion.com';
                doc.text(`${phone} | ${email}`, 50, 28);
                doc.text(website, 50, 33);
                
                // Title
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('CATERING QUOTE', 105, 55, { align: 'center' });
                
                // Horizontal line
                doc.setDrawColor(255, 107, 53);
                doc.setLineWidth(0.5);
                doc.line(15, 60, 195, 60);
                
                // Client Info Box
                doc.setFillColor(250, 250, 250);
                doc.rect(15, 68, 180, 35, 'F');
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('CLIENT INFORMATION', 20, 76);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Client: ${order.client}`, 20, 84);
                doc.text(`Event Date: ${order.date}`, 20, 90);
                doc.text(`Number of Guests: ${order.guests}`, 20, 96);
                
                const serviceType = order.service_type || 'Delivery';
                doc.text(`Service Type: ${serviceType}`, 120, 84);
                if (order.setup_time || order.setupTime) {
                    doc.text(`Setup Time: ${order.setup_time || order.setupTime}`, 120, 90);
                }
                
                // Menu Items Section
                let yPos = 115;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('MENU ITEMS', 20, yPos);
                
                yPos += 8;
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.line(15, yPos, 195, yPos);
                
                // Table Header
                yPos += 7;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(80, 80, 80);
                doc.text('ITEM', 20, yPos);
                doc.text('QUANTITY', 130, yPos);
                doc.text('PRICE', 185, yPos, { align: 'right' });
                
                yPos += 3;
                doc.line(15, yPos, 195, yPos);
                
                // Menu Items
                yPos += 8;
                let subtotal = 0;
                if (selectedMenu && selectedMenu.length > 0) {
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    
                    selectedMenu.forEach(item => {
                        const itemTotal = item.total || item.totalPrice;
                        doc.setFontSize(10);
                        doc.text(item.name, 20, yPos);
                        doc.text(`${item.quantity} servings`, 130, yPos);
                        doc.text(`$${itemTotal.toFixed(2)}`, 185, yPos, { align: 'right' });
                        subtotal += itemTotal;
                        yPos += 8;
                    });
                }
                
                // Totals Section
                yPos += 5;
                doc.setDrawColor(200, 200, 200);
                doc.line(120, yPos, 195, yPos);
                
                yPos += 8;
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('FOOD SUBTOTAL:', 130, yPos);
                doc.text(`$${subtotal.toFixed(2)}`, 185, yPos, { align: 'right' });
                
                if (order.staff_count > 0 || order.staff_cost > 0) {
                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Staff (${order.staff_count || 0} person${order.staff_count !== 1 ? 's' : ''}):`, 130, yPos);
                    doc.text(`$${(order.staff_cost || 0).toFixed(2)}`, 185, yPos, { align: 'right' });
                }
                
                if (order.equipment_cost > 0) {
                    yPos += 8;
                    doc.setFont('helvetica', 'normal');
                    doc.text('Equipment Rental:', 130, yPos);
                    doc.text(`$${(order.equipment_cost || 0).toFixed(2)}`, 185, yPos, { align: 'right' });
                }
                
                yPos += 8;
                doc.setFont('helvetica', 'bold');
                const totalPrice = order.price || subtotal + (order.staff_cost || 0) + (order.equipment_cost || 0);
                doc.text('TOTAL:', 130, yPos);
                doc.text(`$${totalPrice.toFixed(2)}`, 185, yPos, { align: 'right' });
                
                if (order.deposit > 0) {
                    yPos += 8;
                    doc.setTextColor(255, 107, 53);
                    doc.text('DEPOSIT REQUIRED:', 130, yPos);
                    doc.text(`$${order.deposit.toFixed(2)}`, 185, yPos, { align: 'right' });
                    
                    yPos += 8;
                    doc.setTextColor(0, 0, 0);
                    doc.text('BALANCE DUE:', 130, yPos);
                    doc.text(`$${(totalPrice - order.deposit).toFixed(2)}`, 185, yPos, { align: 'right' });
                }
                
                yPos += 3;
                doc.setDrawColor(255, 107, 53);
                doc.setLineWidth(0.5);
                doc.line(120, yPos, 195, yPos);
                
                // Notes Section
                if (order.notes) {
                    yPos += 15;
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('SPECIAL NOTES:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    const splitNotes = doc.splitTextToSize(order.notes, 170);
                    doc.text(splitNotes, 20, yPos);
                }
                
                // Footer
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(120, 120, 120);
                doc.text('Thank you for choosing Birria Fusion for your catering needs!', 105, 275, { align: 'center' });
                doc.text('This quote is valid for 30 days from the date of issue.', 105, 280, { align: 'center' });
                
                // Save PDF
                doc.save(`Catering-Quote-${order.client}-${order.date}.pdf`);
            };
            
            // Fallback if logo doesn't load
            logo.onerror = function() {
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 107, 53);
                doc.text('BIRRIA FUSION', 15, 25);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('(555) 123-4567 | info@birriafusion.com | www.birriafusion.com', 15, 32);
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('CATERING QUOTE', 105, 55, { align: 'center' });
                
                doc.save(`Catering-Quote-${order.client}-${order.date}.pdf`);
            };
        }

        function archiveCateringOrder(id) {
            if (confirm('Archive this order? You can restore it later from Archives.')) {
                fetch(`/api/catering/${id}/archive`, { method: 'POST' })
                    .then(() => loadCatering());
            }
        }
        
        function deleteCateringOrder(id) {
            if (confirm('Delete this catering order?')) {
                fetch(`/api/catering/${id}`, { method: 'DELETE' })
                    .then(() => loadCatering());
            }
        }







        
        // Event Functions
        function addEvent() {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Add Event';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="eventName" placeholder="Event Name (e.g., Downtown Food Festival)">
                    </div>
                    <div class="form-row">
                        <select id="eventType">
                            <option value="Festival">Festival</option>
                            <option value="Farmers Market">Farmers Market</option>
                            <option value="Street Fair">Street Fair</option>
                            <option value="Concert">Concert</option>
                            <option value="Sports Event">Sports Event</option>
                            <option value="Corporate Event">Corporate Event</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" id="eventLocation" placeholder="Location">
                    </div>
                    <div class="form-row">
                        <input type="text" id="eventDate" placeholder="Start Date" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                        <input type="text" id="eventEndDate" placeholder="End Date (optional)" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                    </div>
                    <div class="form-group">
                        <input type="text" id="eventTime" placeholder="Time (e.g., 10am-6pm)">
                    </div>
                    <div class="form-row">
                        <input type="number" id="applicationFee" placeholder="Application Fee ($)" step="0.01" min="0">
                        <select id="eventStatus">
                            <option value="Interested">Interested</option>
                            <option value="Applied">Applied</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Accepted & Paid">Accepted & Paid</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea id="eventNotes" placeholder="Notes (organizer contact, requirements, competition...)" rows="2"></textarea>
                    </div>
                    <button class="btn" onclick="saveEvent(); closeAddModal();">Add Event</button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function saveEvent() {
            const name = document.getElementById('eventName').value;
            const type = document.getElementById('eventType').value;
            const location = document.getElementById('eventLocation').value;
            const date = document.getElementById('eventDate').value;
            const endDate = document.getElementById('eventEndDate').value;
            const time = document.getElementById('eventTime').value;
            const fee = parseFloat(document.getElementById('applicationFee').value) || 0;
            const status = document.getElementById('eventStatus').value;
            const notes = document.getElementById('eventNotes').value;
            
            if (!name || !location || !date) {
                alert('Please fill in event name, location, and start date');
                return;
            }
            
            const events = JSON.parse(localStorage.getItem('events') || '[]');
            events.push({
                id: Date.now(),
                name,
                type,
                location,
                date,
                endDate,
                time,
                fee,
                status,
                notes,
                paid: false
            });
            localStorage.setItem('events', JSON.stringify(events));
            loadEvents();
        }
        
        function loadEvents() {
            fetch('/api/events')
                .then(r => r.json())
                .then(events => {
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate stats
            const upcomingEvents = events.filter(e => e.date >= today && e.status === 'Accepted').length;
            const appliedEvents = events.filter(e => e.status === 'Applied').length;
            const completedEvents = events.filter(e => e.status === 'Completed').length;
            const totalFees = events.reduce((sum, e) => sum + (e.paid ? e.fee : 0), 0);
            
            document.getElementById('eventStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${upcomingEvents}</div>
                    <div class="stat-label">Upcoming Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${appliedEvents}</div>
                    <div class="stat-label">Pending Applications</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${completedEvents}</div>
                    <div class="stat-label">Completed Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${totalFees.toFixed(0)}</div>
                    <div class="stat-label">Total Fees Paid</div>
                </div>
            `;
            
            // Show events sorted by date
            const sortedEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));
            document.getElementById('eventList').innerHTML = sortedEvents.map(event => {
                const isUpcoming = event.date >= today;
                const statusColors = {
                    'Interested': '#6c757d',
                    'Applied': '#ffc107',
                    'Accepted': '#28a745',
                    'Accepted & Paid': '#20c997',
                    'Rejected': '#dc3545',
                    'Completed': '#17a2b8'
                };
                
                return `
                    <div class="card">
                        <div class="card-header" onclick="toggleEventDetails(${event.id})" style="cursor: pointer;">
                            <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${event.name}</span>
                                <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                    <span style="color: ${statusColors[event.status]}; font-size: 0.8em; font-weight: bold; white-space: nowrap;">${event.status}</span>
                                    ${event.fee > 0 ? `<span style="color: ${event.paid ? 'var(--success)' : 'var(--danger)'}; font-size: 0.7em; font-weight: bold; white-space: nowrap;">${event.paid ? '✓ PAID' : '✗ UNPAID'}</span>` : ''}
                                </div>
                            </div>
                            <div class="card-meta" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${event.type} • ${event.location}</span>
                                <span>${event.end_date ? `${event.date} - ${event.end_date}` : event.date}</span>
                            </div>
                        </div>
                        <div class="card-details" id="event-details-${event.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); overflow-wrap: break-word; word-wrap: break-word;">
                            ${event.time ? `<div class="card-meta">Time: ${event.time}</div>` : ''}
                            ${event.fee > 0 ? `<div class="card-meta">Fee: $${event.fee.toFixed(2)}</div>` : ''}
                            ${event.notes ? `<div class="card-meta" style="font-style: italic;">Notes: ${event.notes}</div>` : ''}
                            <div class="card-actions" style="margin-top: 10px;">
                                <button class="btn" onclick="editEvent(${event.id})" style="background: var(--orange); color: white;">Edit</button>
                                <button class="btn" onclick="printEventDetails(${event.id})" style="background: #666; color: white;">Print</button>
                                <button class="btn" onclick="updateEventStatus(${event.id})" style="background: var(--success); color: white;">Status</button>
                                ${event.fee > 0 ? `<button class="btn" onclick="togglePayment(${event.id})" style="background: ${event.paid ? 'var(--danger)' : 'var(--success)'}; color: white;">${event.paid ? 'Mark Unpaid' : 'Mark Paid'}</button>` : ''}
                                <button class="btn" onclick="openNotesModal('event', ${event.id}, '${event.name.replace(/'/g, "\\'")}')" style="background: #666; color: white;">Notes</button>
                                <button class="btn" onclick="archiveEvent(${event.id})" style="background: #6c757d; color: white;">Archive</button>
                                <button class="btn btn-danger" onclick="deleteEvent(${event.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            });
        }
        
        function updateEventStatus(id) {
            fetch('/api/events')
                .then(r => r.json())
                .then(events => {
                    const event = events.find(e => e.id === id);
                    if (!event) return;
                    
                    const statusOptions = ['Interested', 'Applied', 'Accepted', 'Accepted & Paid', 'Rejected', 'Completed'];
                    const optionsText = statusOptions.map((status, index) => `${index + 1}. ${status}`).join('\n');
                    
                    const choice = prompt(`Current status: ${event.status}\n\nSelect new status:\n${optionsText}\n\nEnter number (1-6):`);
                    const choiceNum = parseInt(choice);
                    
                    if (choiceNum >= 1 && choiceNum <= 6) {
                        const newStatus = statusOptions[choiceNum - 1];
                        fetch(`/api/events/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...event, status: newStatus, end_date: event.end_date })
                        }).then(() => loadEvents());
                    }
                });
        }
        
        function editEvent(id) {
            fetch('/api/events')
                .then(r => r.json())
                .then(events => {
                    const event = events.find(e => e.id === id);
                    if (!event) return;
            
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Edit Event';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="eventName" placeholder="Event Name" value="${event.name}">
                    </div>
                    <div class="form-row">
                        <select id="eventType">
                            <option value="Festival" ${event.type === 'Festival' ? 'selected' : ''}>Festival</option>
                            <option value="Farmers Market" ${event.type === 'Farmers Market' ? 'selected' : ''}>Farmers Market</option>
                            <option value="Street Fair" ${event.type === 'Street Fair' ? 'selected' : ''}>Street Fair</option>
                            <option value="Concert" ${event.type === 'Concert' ? 'selected' : ''}>Concert</option>
                            <option value="Sports Event" ${event.type === 'Sports Event' ? 'selected' : ''}>Sports Event</option>
                            <option value="Corporate Event" ${event.type === 'Corporate Event' ? 'selected' : ''}>Corporate Event</option>
                            <option value="Other" ${event.type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                        <input type="text" id="eventLocation" placeholder="Location" value="${event.location}">
                    </div>
                    <div class="form-row">
                        <input type="date" id="eventDate" value="${event.date}">
                        <input type="date" id="eventEndDate" placeholder="End Date" value="${event.endDate || ''}">
                    </div>
                    <div class="form-group">
                        <input type="text" id="eventTime" placeholder="Time" value="${event.time || ''}">
                    </div>
                    <div class="form-row">
                        <input type="number" id="applicationFee" placeholder="Application Fee ($)" step="0.01" min="0" value="${event.fee}">
                        <select id="eventStatus">
                            <option value="Interested" ${event.status === 'Interested' ? 'selected' : ''}>Interested</option>
                            <option value="Applied" ${event.status === 'Applied' ? 'selected' : ''}>Applied</option>
                            <option value="Accepted" ${event.status === 'Accepted' ? 'selected' : ''}>Accepted</option>
                            <option value="Accepted & Paid" ${event.status === 'Accepted & Paid' ? 'selected' : ''}>Accepted & Paid</option>
                            <option value="Rejected" ${event.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                            <option value="Completed" ${event.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea id="eventNotes" placeholder="Notes" rows="2">${event.notes || ''}</textarea>
                    </div>
                    <button class="btn" onclick="updateEvent(${id}); closeAddModal();">Update Event</button>
                </div>
            `;
            
            modal.classList.add('show');
                });
        }
        
        function updateEvent(id) {
            const name = document.getElementById('eventName').value;
            const type = document.getElementById('eventType').value;
            const location = document.getElementById('eventLocation').value;
            const date = document.getElementById('eventDate').value;
            const endDate = document.getElementById('eventEndDate').value;
            const time = document.getElementById('eventTime').value;
            const fee = parseFloat(document.getElementById('applicationFee').value) || 0;
            const status = document.getElementById('eventStatus').value;
            const notes = document.getElementById('eventNotes').value;
            
            if (!name || !location || !date) {
                alert('Please fill in event name, location, and start date');
                return;
            }
            
            fetch(`/api/events/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, type, location, date, end_date: endDate, time, fee, status, notes, paid: 0 })
            }).then(() => loadEvents());
        }
        
        function archiveEvent(id) {
            if (confirm('Archive this event? You can restore it later from Archives.')) {
                fetch(`/api/events/${id}/archive`, { method: 'POST' })
                    .then(() => loadEvents());
            }
        }
        
        function deleteEvent(id) {
            if (confirm('Delete this event?')) {
                fetch(`/api/events/${id}`, { method: 'DELETE' })
                    .then(() => loadEvents());
            }
        }







        
        function toggleEventDetails(id) {
            const details = document.getElementById(`event-details-${id}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }
        
        function togglePayment(id) {
            fetch('/api/events')
                .then(r => r.json())
                .then(events => {
                    const event = events.find(e => e.id === id);
                    if (!event) return;
                    
                    fetch(`/api/events/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...event, paid: event.paid ? 0 : 1, end_date: event.end_date })
                    }).then(() => loadEvents());
                });
        }

        // Review Functions
        function addReview() {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Add Review';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-row">
                        <select id="reviewPlatform">
                            <option value="Google">Google</option>
                            <option value="Yelp">Yelp</option>
                            <option value="Facebook">Facebook</option>
                            <option value="TripAdvisor">TripAdvisor</option>
                            <option value="Other">Other</option>
                        </select>
                        <select id="reviewRating">
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="2">2 Stars</option>
                            <option value="1">1 Star</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" id="reviewerName" placeholder="Reviewer Name">
                    </div>
                    <div class="form-group">
                        <textarea id="reviewText" placeholder="Review text..." rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <input type="text" id="reviewDate" placeholder="Review Date" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                        <select id="responseStatus">
                            <option value="Not Responded">Not Responded</option>
                            <option value="Responded">Responded</option>
                            <option value="No Response Needed">No Response Needed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea id="responseText" placeholder="Your response (optional)..." rows="2"></textarea>
                    </div>
                    <button class="btn" onclick="saveReview(); closeAddModal();">Add Review</button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function saveReview() {
            const platform = document.getElementById('reviewPlatform').value;
            const rating = parseInt(document.getElementById('reviewRating').value);
            const reviewerName = document.getElementById('reviewerName').value;
            const reviewText = document.getElementById('reviewText').value;
            const reviewDate = document.getElementById('reviewDate').value;
            const responseStatus = document.getElementById('responseStatus').value;
            const responseText = document.getElementById('responseText').value;
            
            if (!reviewerName || !reviewText || !reviewDate) {
                alert('Please fill in reviewer name, review text, and date');
                return;
            }
            
            const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
            reviews.push({
                id: Date.now(),
                platform,
                rating,
                reviewerName,
                reviewText,
                reviewDate,
                responseStatus,
                responseText
            });
            localStorage.setItem('reviews', JSON.stringify(reviews));
            loadReviews();
        }
        
        function loadReviews() {
            const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
            
            // Calculate stats
            const avgRating = reviews.length > 0 ? (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1) : '0.0';
            const totalReviews = reviews.length;
            const needResponse = reviews.filter(r => r.responseStatus === 'Not Responded').length;
            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthlyReviews = reviews.filter(r => r.reviewDate.startsWith(thisMonth)).length;
            
            document.getElementById('reviewStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${avgRating}</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalReviews}</div>
                    <div class="stat-label">Total Reviews</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: ${needResponse > 0 ? 'var(--danger)' : 'var(--success)'}">${needResponse}</div>
                    <div class="stat-label">Need Response</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${monthlyReviews}</div>
                    <div class="stat-label">This Month</div>
                </div>
            `;
            
            // Show recent reviews
            const recentReviews = reviews.sort((a, b) => new Date(b.reviewDate) - new Date(a.reviewDate)).slice(0, 10);
            document.getElementById('reviewList').innerHTML = recentReviews.map(review => {
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                const statusColor = review.responseStatus === 'Not Responded' ? 'var(--danger)' : 
                                   review.responseStatus === 'Responded' ? 'var(--success)' : 'var(--gray)';
                
                return `
                    <div class="card">
                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${review.reviewerName}</span>
                            <span style="color: #ffc107;">${stars}</span>
                        </div>
                        <div class="card-meta">${review.platform} • ${review.reviewDate}</div>
                        <div class="card-meta" style="font-style: italic; margin: 8px 0;">"${review.reviewText.substring(0, 100)}${review.reviewText.length > 100 ? '...' : ''}"</div>
                        <div class="card-meta" style="color: ${statusColor}; font-weight: bold;">${review.responseStatus}</div>
                        ${review.responseText ? `<div class="card-meta" style="background: var(--gray-light); padding: 8px; border-radius: 4px; margin-top: 8px;">Response: "${review.responseText.substring(0, 80)}${review.responseText.length > 80 ? '...' : ''}"</div>` : ''}
                        <div class="card-actions">
                            <button class="btn" onclick="respondToReview(${review.id})" style="background: var(--orange); color: white;">Respond</button>
                            <button class="btn btn-danger" onclick="deleteReview(${review.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function respondToReview(id) {
            const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
            const review = reviews.find(r => r.id === id);
            if (!review) return;
            
            const response = prompt('Enter your response:', review.responseText || '');
            if (response !== null) {
                review.responseText = response;
                review.responseStatus = response.trim() ? 'Responded' : 'Not Responded';
                localStorage.setItem('reviews', JSON.stringify(reviews));
                loadReviews();
            }
        }
        
        function deleteReview(id) {
            if (confirm('Delete this review?')) {
                const reviews = JSON.parse(localStorage.getItem('reviews') || '[]');
                const filtered = reviews.filter(r => r.id !== id);
                localStorage.setItem('reviews', JSON.stringify(filtered));
                loadReviews();
            }
        }

        // Expense Functions
        function addExpense() {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Add Expense';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-row">
                        <select id="expenseCategory">
                            <option value="Fuel">Fuel</option>
                            <option value="Supplies">Supplies</option>
                            <option value="Permits">Permits & Licenses</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Maintenance">Vehicle Maintenance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Labor">Labor</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="number" id="expenseAmount" placeholder="Amount ($)" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <input type="text" id="expenseDescription" placeholder="Description (e.g., Gas station fill-up, Paper towels)">
                    </div>
                    <div class="form-row">
                        <input type="text" id="expenseDate" placeholder="Date" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                        <select id="expensePayment">
                            <option value="Cash">Cash</option>
                            <option value="Card">Credit/Debit Card</option>
                            <option value="Check">Check</option>
                            <option value="Online">Online Payment</option>
                        </select>
                    </div>
                    <button class="btn" onclick="saveExpense(); closeAddModal();">Add Expense</button>
                </div>
            `;
            
            // Set today's date as default
            setTimeout(() => {
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            }, 100);
            
            modal.classList.add('show');
        }
        
        function saveExpense() {
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;
            const date = document.getElementById('expenseDate').value;
            const payment = document.getElementById('expensePayment').value;
            
            if (!amount || !description || !date) {
                alert('Please fill in amount, description, and date');
                return;
            }
            
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses.push({
                id: Date.now(),
                category,
                amount,
                description,
                date,
                payment
            });
            localStorage.setItem('expenses', JSON.stringify(expenses));
            loadExpenses();
        }
        
        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            
            // Calculate stats
            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthlyExpenses = expenses.filter(e => e.date.startsWith(thisMonth));
            const totalMonthly = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            const categories = {};
            monthlyExpenses.forEach(e => {
                categories[e.category] = (categories[e.category] || 0) + e.amount;
            });
            
            const topCategory = Object.keys(categories).reduce((a, b) => categories[a] > categories[b] ? a : b, 'None');
            
            document.getElementById('expenseStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">$${totalMonthly.toFixed(0)}</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${monthlyExpenses.length}</div>
                    <div class="stat-label">Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${(totalMonthly / (monthlyExpenses.length || 1)).toFixed(0)}</div>
                    <div class="stat-label">Avg per Transaction</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${topCategory}</div>
                    <div class="stat-label">Top Category</div>
                </div>
            `;
            
            // Show recent expenses
            const recentExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            document.getElementById('expenseList').innerHTML = recentExpenses.map(expense => {
                const categoryColors = {
                    'Fuel': '#ff6b35',
                    'Supplies': '#28a745',
                    'Permits': '#dc3545',
                    'Insurance': '#6f42c1',
                    'Maintenance': '#fd7e14',
                    'Marketing': '#20c997',
                    'Utilities': '#6c757d',
                    'Labor': '#007bff',
                    'Other': '#ffc107'
                };
                
                return `
                    <div class="card">
                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${expense.description}</span>
                            <span style="color: ${categoryColors[expense.category] || '#666'}; font-weight: bold;">$${expense.amount.toFixed(2)}</span>
                        </div>
                        <div class="card-meta">${expense.category} • ${expense.date}</div>
                        <div class="card-meta">Paid by ${expense.payment}</div>
                        <div class="card-actions">
                            <button class="btn btn-danger" onclick="deleteExpense(${expense.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                const filtered = expenses.filter(e => e.id !== id);
                localStorage.setItem('expenses', JSON.stringify(filtered));
                loadExpenses();
            }
        }

        // Analytics Functions
        function loadAnalytics() {
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    const totalItems = items.length;
                    const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                    const goodItems = items.filter(item => ((item.price - item.cost) / item.price) * 100 >= defaultMargin).length;
                    const needsAttention = items.filter(item => {
                        const margin = ((item.price - item.cost) / item.price) * 100;
                        return margin >= (defaultMargin * 0.67) && margin < defaultMargin;
                    }).length;
                    const badItems = items.filter(item => ((item.price - item.cost) / item.price) * 100 < (defaultMargin * 0.67)).length;
                    
                    document.getElementById('analyticsStats').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success)">${goodItems}</div>
                            <div class="stat-label">Good Items (30%+)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning)">${needsAttention}</div>
                            <div class="stat-label">Needs Attention (20-29%)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--danger)">${badItems}</div>
                            <div class="stat-label">Bad Items (<20%)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalItems}</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                    `;
                    
                    document.getElementById('foodCostAnalysis').innerHTML = items.map(item => {
                        const foodCost = (item.cost / item.price) * 100;
                        const defaultMargin = parseFloat(localStorage.getItem('defaultMargin') || '30');
                        const margin = ((item.price - item.cost) / item.price) * 100;
                        const status = margin >= defaultMargin ? 'Good' : margin >= (defaultMargin * 0.67) ? 'Needs Attention' : 'Bad - Urgent';
                        const color = margin >= defaultMargin ? 'var(--success)' : margin >= (defaultMargin * 0.67) ? 'var(--warning)' : 'var(--danger)';
                        return `
                            <div class="card">
                                <div class="card-title">${item.name}</div>
                                <div class="card-meta">Food Cost: <span style="color: ${color}">${foodCost.toFixed(1)}%</span></div>
                                <div class="card-meta">Status: <span style="color: ${color}">${status}</span></div>
                                <div class="card-meta">Price: $${item.price} • Cost: $${item.cost}</div>
                            </div>
                        `;
                    }).join('');
                });
        }

        // Theme Functions
        function toggleTheme() {
            const isDark = document.getElementById('darkMode').checked;
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('darkMode').checked = savedTheme === 'dark';
        }

        // Menu Categories Functions
        function addMenuCategory() {
            const category = document.getElementById('newCategory').value.trim();
            if (!category) {
                alert('Please enter a category name');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('menuCategories') || '[]');
            if (!categories.includes(category)) {
                categories.push(category);
                localStorage.setItem('menuCategories', JSON.stringify(categories));
                document.getElementById('newCategory').value = '';
                loadMenuCategories();
            } else {
                alert('Category already exists');
            }
        }
        
        function loadMenuCategories() {
            const categories = JSON.parse(localStorage.getItem('menuCategories') || '["Entree","Appetizer","Dessert","Sauce","Side","Beverage"]');
            
            document.getElementById('categoriesList').innerHTML = categories.map(category => `
                <span onclick="editMenuCategory('${category}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${category}
                </span>
            `).join('');
        }
        
        let editType = '';
        let editOriginalValue = '';
        
        function editMenuCategory(category) {
            editType = 'category';
            editOriginalValue = category;
            document.getElementById('editModalTitle').textContent = 'Edit Category';
            document.getElementById('editInput').value = category;
            document.getElementById('editModal').classList.add('show');
        }
        
        function deleteMenuCategory(category) {
            if (confirm(`Delete category "${category}"?`)) {
                const categories = JSON.parse(localStorage.getItem('menuCategories') || '["Entree","Appetizer","Dessert","Sauce","Side","Beverage"]');
                const filtered = categories.filter(c => c !== category);
                localStorage.setItem('menuCategories', JSON.stringify(filtered));
                loadMenuCategories();
            }
        }
        
        function getAllMenuCategories() {
            return JSON.parse(localStorage.getItem('menuCategories') || '["Entree","Appetizer","Dessert","Sauce","Side","Beverage"]');
        }

        // Supplier Categories Functions
        function addInventoryCategory() {
            const category = document.getElementById('newInventoryCategory').value.trim();
            if (!category) {
                alert('Please enter a category name');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('inventoryCategories') || '[]');
            if (!categories.includes(category)) {
                categories.push(category);
                localStorage.setItem('inventoryCategories', JSON.stringify(categories));
                document.getElementById('newInventoryCategory').value = '';
                loadInventoryCategories();
            } else {
                alert('Category already exists');
            }
        }
        
        function loadInventoryCategories() {
            const categories = JSON.parse(localStorage.getItem('inventoryCategories') || '["Food","Cleaning Supplies","To Go Supplies","Equipment","Other"]');
            
            document.getElementById('inventoryCategoriesList').innerHTML = categories.map(category => `
                <span onclick="editInventoryCategory('${category}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${category}
                </span>
            `).join('');
        }
        
        function editInventoryCategory(category) {
            editType = 'inventoryCategory';
            editOriginalValue = category;
            document.getElementById('editModalTitle').textContent = 'Edit Inventory Category';
            document.getElementById('editInput').value = category;
            document.getElementById('editModal').classList.add('show');
        }
        
        function getAllInventoryCategories() {
            return JSON.parse(localStorage.getItem('inventoryCategories') || '["Food","Cleaning Supplies","To Go Supplies","Equipment","Other"]');
        }

        function addSupplierCategory() {
            const category = document.getElementById('newSupplierCategory').value.trim();
            if (!category) {
                alert('Please enter a category name');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('supplierCategories') || '[]');
            if (!categories.includes(category)) {
                categories.push(category);
                localStorage.setItem('supplierCategories', JSON.stringify(categories));
                document.getElementById('newSupplierCategory').value = '';
                loadSupplierCategories();
            } else {
                alert('Category already exists');
            }
        }
        
        function loadSupplierCategories() {
            const categories = JSON.parse(localStorage.getItem('supplierCategories') || '["Food","Equipment","Supplies","Other"]');
            
            document.getElementById('supplierCategoriesList').innerHTML = categories.map(category => `
                <span onclick="editSupplierCategory('${category}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${category}
                </span>
            `).join('');
        }
        
        function editSupplierCategory(category) {
            editType = 'supplierCategory';
            editOriginalValue = category;
            document.getElementById('editModalTitle').textContent = 'Edit Supplier Category';
            document.getElementById('editInput').value = category;
            document.getElementById('editModal').classList.add('show');
        }
        
        function getAllSupplierCategories() {
            return JSON.parse(localStorage.getItem('supplierCategories') || '["Food","Equipment","Supplies","Other"]');
        }

        // Measurement Units Functions
        function addMeasurementUnit() {
            const unit = document.getElementById('newUnit').value.trim();
            if (!unit) {
                alert('Please enter a unit name');
                return;
            }
            
            const units = JSON.parse(localStorage.getItem('measurementUnits') || '["lb","oz","kg","g","cups","tbsp","tsp","liters","ml","pieces","pack"]');
            if (!units.includes(unit)) {
                units.push(unit);
                localStorage.setItem('measurementUnits', JSON.stringify(units));
                document.getElementById('newUnit').value = '';
                loadMeasurementUnits();
            } else {
                alert('Unit already exists');
            }
        }
        
        function loadMeasurementUnits() {
            const units = JSON.parse(localStorage.getItem('measurementUnits') || '["lb","oz","kg","g","cups","tbsp","tsp","liters","ml","pieces","pack"]');
            
            document.getElementById('unitsList').innerHTML = units.map(unit => `
                <span onclick="editMeasurementUnit('${unit}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${unit}
                </span>
            `).join('');
        }
        
        function editMeasurementUnit(unit) {
            editType = 'unit';
            editOriginalValue = unit;
            document.getElementById('editModalTitle').textContent = 'Edit Unit';
            document.getElementById('editInput').value = unit;
            document.getElementById('editModal').classList.add('show');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        
        function saveEdit() {
            const newValue = document.getElementById('editInput').value.trim();
            if (!newValue) return;
            
            if (editType === 'category') {
                const categories = JSON.parse(localStorage.getItem('menuCategories') || '["Entree","Appetizer","Dessert","Sauce","Side","Beverage"]');
                const index = categories.indexOf(editOriginalValue);
                if (index !== -1) {
                    categories[index] = newValue;
                    localStorage.setItem('menuCategories', JSON.stringify(categories));
                    loadMenuCategories();
                }
            } else if (editType === 'unit') {
                const units = JSON.parse(localStorage.getItem('measurementUnits') || '["lb","oz","kg","g","cups","tbsp","tsp","liters","ml","pieces","pack"]');
                const index = units.indexOf(editOriginalValue);
                if (index !== -1) {
                    units[index] = newValue;
                    localStorage.setItem('measurementUnits', JSON.stringify(units));
                    loadMeasurementUnits();
                }
            } else if (editType === 'inventoryCategory') {
                const categories = JSON.parse(localStorage.getItem('inventoryCategories') || '["Food","Cleaning Supplies","To Go Supplies","Equipment","Other"]');
                const index = categories.indexOf(editOriginalValue);
                if (index !== -1) {
                    categories[index] = newValue;
                    localStorage.setItem('inventoryCategories', JSON.stringify(categories));
                    loadInventoryCategories();
                }
            } else if (editType === 'supplierCategory') {
                const categories = JSON.parse(localStorage.getItem('supplierCategories') || '["Food","Equipment","Supplies","Other"]');
                const index = categories.indexOf(editOriginalValue);
                if (index !== -1) {
                    categories[index] = newValue;
                    localStorage.setItem('supplierCategories', JSON.stringify(categories));
                    loadSupplierCategories();
                }
            } else if (editType === 'eventStatus') {
                const statuses = JSON.parse(localStorage.getItem('eventStatuses') || '["Interested","Applied","Accepted","Accepted & Paid","Rejected","Completed"]');
                const index = statuses.indexOf(editOriginalValue);
                if (index !== -1) {
                    statuses[index] = newValue;
                    localStorage.setItem('eventStatuses', JSON.stringify(statuses));
                    loadEventStatuses();
                }
            } else if (editType === 'fileCategory') {
                const categories = JSON.parse(localStorage.getItem('fileCategories') || '["General","Event Contracts","Catering Contracts","Permits","Insurance","Marketing","Images","Receipts","Other"]');
                const index = categories.indexOf(editOriginalValue);
                if (index !== -1) {
                    categories[index] = newValue;
                    localStorage.setItem('fileCategories', JSON.stringify(categories));
                    loadFileCategories();
                }
            } else if (editType === 'employeeRole') {
                const roles = JSON.parse(localStorage.getItem('employeeRoles') || '["Cook","Cashier","Manager","Prep Cook","Server","Driver","Cleaner"]');
                const index = roles.indexOf(editOriginalValue);
                if (index !== -1) {
                    roles[index] = newValue;
                    localStorage.setItem('employeeRoles', JSON.stringify(roles));
                    loadEmployeeRoles();
                    updateEmployeeRoleDropdown();
                }
            } else if (editType === 'contactCategory') {
                const categories = JSON.parse(localStorage.getItem('contactCategories') || '["General","Catering Client","Event Organizer","Vendor"]');
                const index = categories.indexOf(editOriginalValue);
                if (index !== -1) {
                    categories[index] = newValue;
                    localStorage.setItem('contactCategories', JSON.stringify(categories));
                    loadContactCategories();
                }
            }
            closeEditModal();
        }
        
        function deleteItem() {
            if (!confirm(`Delete "${editOriginalValue}"?`)) return;
            
            if (editType === 'category') {
                const categories = JSON.parse(localStorage.getItem('menuCategories') || '["Entree","Appetizer","Dessert","Sauce","Side","Beverage"]');
                const filtered = categories.filter(c => c !== editOriginalValue);
                localStorage.setItem('menuCategories', JSON.stringify(filtered));
                loadMenuCategories();
            } else if (editType === 'unit') {
                const units = JSON.parse(localStorage.getItem('measurementUnits') || '["lb","oz","kg","g","cups","tbsp","tsp","liters","ml","pieces","pack"]');
                const filtered = units.filter(u => u !== editOriginalValue);
                localStorage.setItem('measurementUnits', JSON.stringify(filtered));
                loadMeasurementUnits();
            } else if (editType === 'inventoryCategory') {
                const categories = JSON.parse(localStorage.getItem('inventoryCategories') || '["Food","Cleaning Supplies","To Go Supplies","Equipment","Other"]');
                const filtered = categories.filter(c => c !== editOriginalValue);
                localStorage.setItem('inventoryCategories', JSON.stringify(filtered));
                loadInventoryCategories();
            } else if (editType === 'supplierCategory') {
                const categories = JSON.parse(localStorage.getItem('supplierCategories') || '["Food","Equipment","Supplies","Other"]');
                const filtered = categories.filter(c => c !== editOriginalValue);
                localStorage.setItem('supplierCategories', JSON.stringify(filtered));
                loadSupplierCategories();
            } else if (editType === 'eventStatus') {
                const statuses = JSON.parse(localStorage.getItem('eventStatuses') || '["Interested","Applied","Accepted","Accepted & Paid","Rejected","Completed"]');
                const filtered = statuses.filter(s => s !== editOriginalValue);
                localStorage.setItem('eventStatuses', JSON.stringify(filtered));
                loadEventStatuses();
            } else if (editType === 'fileCategory') {
                const categories = JSON.parse(localStorage.getItem('fileCategories') || '["General","Event Contracts","Catering Contracts","Permits","Insurance","Marketing","Images","Receipts","Other"]');
                const filtered = categories.filter(c => c !== editOriginalValue);
                localStorage.setItem('fileCategories', JSON.stringify(filtered));
                loadFileCategories();
            } else if (editType === 'employeeRole') {
                const roles = JSON.parse(localStorage.getItem('employeeRoles') || '["Cook","Cashier","Manager","Prep Cook","Server","Driver","Cleaner"]');
                const filtered = roles.filter(r => r !== editOriginalValue);
                localStorage.setItem('employeeRoles', JSON.stringify(filtered));
                loadEmployeeRoles();
                updateEmployeeRoleDropdown();
            } else if (editType === 'contactCategory') {
                const categories = JSON.parse(localStorage.getItem('contactCategories') || '["General","Catering Client","Event Organizer","Vendor"]');
                const filtered = categories.filter(c => c !== editOriginalValue);
                localStorage.setItem('contactCategories', JSON.stringify(filtered));
                loadContactCategories();
            }
            closeEditModal();
        }
        
        function deleteMeasurementUnit(unit) {
            if (confirm(`Delete unit "${unit}"?`)) {
                const units = JSON.parse(localStorage.getItem('measurementUnits') || '["lb","oz","kg","g","cups","tbsp","tsp","liters","ml","pieces","pack"]');
                const filtered = units.filter(u => u !== unit);
                localStorage.setItem('measurementUnits', JSON.stringify(filtered));
                loadMeasurementUnits();
            }
        }
        
        function getAllMeasurementUnits() {
            return JSON.parse(localStorage.getItem('measurementUnits') || '["lb","oz","kg","g","cups","tbsp","tsp","liters","ml","pieces","pack"]');
        }
        
        // Event Status Functions
        function addEventStatus() {
            const status = document.getElementById('newEventStatus').value.trim();
            if (!status) {
                alert('Please enter a status name');
                return;
            }
            
            const statuses = JSON.parse(localStorage.getItem('eventStatuses') || '[]');
            if (!statuses.includes(status)) {
                statuses.push(status);
                localStorage.setItem('eventStatuses', JSON.stringify(statuses));
                document.getElementById('newEventStatus').value = '';
                loadEventStatuses();
            } else {
                alert('Status already exists');
            }
        }
        
        function loadEventStatuses() {
            const statuses = JSON.parse(localStorage.getItem('eventStatuses') || '["Interested","Applied","Accepted","Accepted & Paid","Rejected","Completed"]');
            
            document.getElementById('eventStatusesList').innerHTML = statuses.map(status => `
                <span onclick="editEventStatus('${status}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${status}
                </span>
            `).join('');
        }
        
        function editEventStatus(status) {
            editType = 'eventStatus';
            editOriginalValue = status;
            document.getElementById('editModalTitle').textContent = 'Edit Event Status';
            document.getElementById('editInput').value = status;
            document.getElementById('editModal').classList.add('show');
        }
        
        function getAllEventStatuses() {
            return JSON.parse(localStorage.getItem('eventStatuses') || '["Interested","Applied","Accepted","Accepted & Paid","Rejected","Completed"]');
        }
        
        // File Category Functions
        function addFileCategory() {
            const category = document.getElementById('newFileCategory').value.trim();
            if (!category) {
                alert('Please enter a category name');
                return;
            }
            
            const categories = JSON.parse(localStorage.getItem('fileCategories') || '[]');
            if (!categories.includes(category)) {
                categories.push(category);
                localStorage.setItem('fileCategories', JSON.stringify(categories));
                document.getElementById('newFileCategory').value = '';
                loadFileCategories();
            } else {
                alert('Category already exists');
            }
        }
        
        function loadFileCategories() {
            const categories = JSON.parse(localStorage.getItem('fileCategories') || '["General","Event Contracts","Catering Contracts","Permits","Insurance","Marketing","Images","Receipts","Other"]');
            
            document.getElementById('fileCategoriesList').innerHTML = categories.map(category => `
                <span onclick="editFileCategory('${category}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${category}
                </span>
            `).join('');
        }
        
        function editFileCategory(category) {
            editType = 'fileCategory';
            editOriginalValue = category;
            document.getElementById('editModalTitle').textContent = 'Edit File Category';
            document.getElementById('editInput').value = category;
            document.getElementById('editModal').classList.add('show');
        }
        
        function getAllFileCategories() {
            return JSON.parse(localStorage.getItem('fileCategories') || '["General","Event Contracts","Catering Contracts","Permits","Insurance","Marketing","Images","Receipts","Other"]');
        }
        
        // Employee Roles Functions
        function addEmployeeRole() {
            const role = document.getElementById('newEmployeeRoleInput').value.trim();
            if (!role) {
                alert('Please enter a role name');
                return;
            }
            
            const roles = JSON.parse(localStorage.getItem('employeeRoles') || '[]');
            if (!roles.includes(role)) {
                roles.push(role);
                localStorage.setItem('employeeRoles', JSON.stringify(roles));
                document.getElementById('newEmployeeRoleInput').value = '';
                loadEmployeeRoles();
                updateEmployeeRoleDropdown();
            } else {
                alert('Role already exists');
            }
        }
        
        function loadEmployeeRoles() {
            const roles = JSON.parse(localStorage.getItem('employeeRoles') || '["Cook","Cashier","Manager","Prep Cook","Server","Driver","Cleaner"]');
            
            document.getElementById('employeeRolesList').innerHTML = roles.map(role => `
                <span onclick="editEmployeeRole('${role}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${role}
                </span>
            `).join('');
        }
        
        function editEmployeeRole(role) {
            editType = 'employeeRole';
            editOriginalValue = role;
            document.getElementById('editModalTitle').textContent = 'Edit Employee Role';
            document.getElementById('editInput').value = role;
            document.getElementById('editModal').classList.add('show');
        }
        
        function getAllEmployeeRoles() {
            return JSON.parse(localStorage.getItem('employeeRoles') || '["Cook","Cashier","Manager","Prep Cook","Server","Driver","Cleaner"]');
        }
        
        function updateEmployeeRoleDropdown() {
            const roleSelect = document.getElementById('newEmployeeRole');
            if (roleSelect) {
                const roles = getAllEmployeeRoles();
                roleSelect.innerHTML = '<option value="">Select role...</option>' + 
                    roles.map(role => `<option value="${role}">${role}</option>`).join('');
            }
        }

        // Data Management Functions
        function loadContactCategories() {
            const categories = JSON.parse(localStorage.getItem('contactCategories') || '["General","Catering Client","Event Organizer","Vendor"]');
            
            document.getElementById('contactCategoriesList').innerHTML = categories.map(category => `
                <span onclick="editContactCategory('${category}')" style="display: inline-block; background: var(--orange); color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                    ${category}
                </span>
            `).join('');
        }
        
        function editContactCategory(category) {
            editType = 'contactCategory';
            editOriginalValue = category;
            document.getElementById('editModalTitle').textContent = 'Edit Contact Category';
            document.getElementById('editInput').value = category;
            document.getElementById('editModal').classList.add('show');
        }
        
        function getAllContactCategories() {
            return JSON.parse(localStorage.getItem('contactCategories') || '["General","Catering Client","Event Organizer","Vendor"]');
        }
        
        function addContactCategory() {
            const input = document.getElementById('newContactCategory');
            const category = input.value.trim();
            if (!category) return;
            
            const categories = JSON.parse(localStorage.getItem('contactCategories') || '["General","Catering Client","Event Organizer","Vendor"]');
            if (!categories.includes(category)) {
                categories.push(category);
                localStorage.setItem('contactCategories', JSON.stringify(categories));
                input.value = '';
                loadContactCategories();
            }
        }

        function exportData() {
            const data = {
                menu: [],
                ingredients: [],
                inventory: [],
                suppliers: [],
                tools: JSON.parse(localStorage.getItem('tools') || '[]'),
                catering: JSON.parse(localStorage.getItem('catering') || '[]'),
                measurementUnits: JSON.parse(localStorage.getItem('measurementUnits') || '[]'),
                uploadedFiles: JSON.parse(localStorage.getItem('uploadedFiles') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            // Get database data
            Promise.all([
                fetch('/api/menu').then(r => r.json()),
                fetch('/api/ingredients').then(r => r.json()),
                fetch('/api/inventory').then(r => r.json()),
                fetch('/api/suppliers').then(r => r.json())
            ]).then(([menu, ingredients, inventory, suppliers]) => {
                data.menu = menu;
                data.ingredients = ingredients;
                data.inventory = inventory;
                data.suppliers = suppliers;
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `birria-fusion-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }).catch(error => {
                console.error('Export error:', error);
                alert('Export failed');
            });
        }

        // Contacts Functions
        function loadContacts() {
            // Populate filter dropdown
            const filterSelect = document.getElementById('contactCategoryFilter');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '<option value="all">All Categories</option>' + 
                getAllContactCategories().map(cat => `<option value="${cat}">${cat}</option>`).join('');
            filterSelect.value = currentFilter;
            
            const filter = filterSelect.value;
            fetch('/api/contacts')
                .then(r => r.json())
                .then(contacts => {
                    const filtered = filter === 'all' ? contacts : contacts.filter(c => c.category === filter);
                    document.getElementById('contactsList').innerHTML = filtered.map(contact => `
                        <div class="card">
                            <div class="card-title">${contact.name}</div>
                            ${contact.company ? `<div class="card-meta">${contact.company}</div>` : ''}
                            <div class="card-meta" style="color: var(--orange); font-weight: 600;">${contact.category}</div>
                            ${contact.phone ? `<div class="card-meta"><a href="tel:${contact.phone}" style="color: var(--charcoal);">☎ ${contact.phone}</a></div>` : ''}
                            ${contact.email ? `<div class="card-meta"><a href="mailto:${contact.email}" style="color: var(--charcoal);">✉ ${contact.email}</a></div>` : ''}
                            ${contact.tags ? `<div class="card-meta" style="font-size: 0.8em;">${contact.tags.split(',').map(t => `<span style="background: var(--gray-light); padding: 2px 6px; border-radius: 4px; margin-right: 4px;">${t.trim()}</span>`).join('')}</div>` : ''}
                            <div class="card-actions">
                                <button class="btn" onclick="viewContactHistory(${contact.id})" style="background: #17a2b8; color: white;">History</button>
                                <button class="btn" onclick="editContact(${contact.id})" style="background: var(--orange); color: white;">Edit</button>
                                <button class="btn btn-danger" onclick="deleteContact(${contact.id})">Delete</button>
                            </div>
                        </div>
                    `).join('');
                });
        }
        
        function addContact() {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Add Contact';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="contactName" placeholder="Name *">
                    </div>
                    <div class="form-row">
                        <input type="text" id="contactCompany" placeholder="Company/Organization">
                        <select id="contactCategory">
                            ${getAllContactCategories().map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row">
                        <input type="tel" id="contactPhone" placeholder="Phone">
                        <input type="email" id="contactEmail" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <input type="text" id="contactAddress" placeholder="Address">
                    </div>
                    <div class="form-group">
                        <textarea id="contactNotes" placeholder="Notes" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="text" id="contactTags" placeholder="Tags (comma-separated, e.g. preferred, equipment)">
                    </div>
                    <button class="btn" onclick="saveContact(); closeAddModal();">Add Contact</button>
                </div>
            `;
            modal.classList.add('show');
        }
        
        function saveContact() {
            const name = document.getElementById('contactName').value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }
            
            fetch('/api/contacts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    company: document.getElementById('contactCompany').value.trim(),
                    category: document.getElementById('contactCategory').value,
                    phone: document.getElementById('contactPhone').value.trim(),
                    email: document.getElementById('contactEmail').value.trim(),
                    address: document.getElementById('contactAddress').value.trim(),
                    notes: document.getElementById('contactNotes').value.trim(),
                    tags: document.getElementById('contactTags').value.trim()
                })
            }).then(() => loadContacts());
        }
        
        function editContact(id) {
            fetch('/api/contacts')
                .then(r => r.json())
                .then(contacts => {
                    const contact = contacts.find(c => c.id === id);
                    if (!contact) return;
                    
                    const modal = document.getElementById('addModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalForm = document.getElementById('modalForm');
                    
                    modalTitle.textContent = 'Edit Contact';
                    modalForm.innerHTML = `
                        <div class="form">
                            <div class="form-group">
                                <input type="text" id="contactName" placeholder="Name *" value="${contact.name}">
                            </div>
                            <div class="form-row">
                                <input type="text" id="contactCompany" placeholder="Company/Organization" value="${contact.company || ''}">
                                <select id="contactCategory">
                                    ${getAllContactCategories().map(cat => `<option value="${cat}" ${contact.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <input type="tel" id="contactPhone" placeholder="Phone" value="${contact.phone || ''}">
                                <input type="email" id="contactEmail" placeholder="Email" value="${contact.email || ''}">
                            </div>
                            <div class="form-group">
                                <input type="text" id="contactAddress" placeholder="Address" value="${contact.address || ''}">
                            </div>
                            <div class="form-group">
                                <textarea id="contactNotes" placeholder="Notes" rows="2">${contact.notes || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <input type="text" id="contactTags" placeholder="Tags (comma-separated)" value="${contact.tags || ''}">
                            </div>
                            <button class="btn" onclick="updateContact(${id}); closeAddModal();">Update Contact</button>
                        </div>
                    `;
                    modal.classList.add('show');
                });
        }
        
        function updateContact(id) {
            const name = document.getElementById('contactName').value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }
            
            fetch(`/api/contacts/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    company: document.getElementById('contactCompany').value.trim(),
                    category: document.getElementById('contactCategory').value,
                    phone: document.getElementById('contactPhone').value.trim(),
                    email: document.getElementById('contactEmail').value.trim(),
                    address: document.getElementById('contactAddress').value.trim(),
                    notes: document.getElementById('contactNotes').value.trim(),
                    tags: document.getElementById('contactTags').value.trim()
                })
            }).then(() => loadContacts());
        }
        
        async function viewContactHistory(id) {
            const [contact, history] = await Promise.all([
                fetch(`/api/contacts/${id}`).then(r => r.json()),
                fetch(`/api/contacts/${id}/history`).then(r => r.json())
            ]);
            
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            const totalSpent = history.catering.reduce((sum, c) => sum + (c.price || 0), 0);
            
            modalTitle.textContent = `${contact.name} - Customer History`;
            modalForm.innerHTML = `
                <div class="form">
                    <div style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 1.2em; font-weight: 600; margin-bottom: 5px;">Total Spent: $${totalSpent.toFixed(2)}</div>
                        <div style="color: var(--gray);">Orders: ${history.catering.length} | Events: ${history.events.length}</div>
                    </div>
                    
                    <h4 style="margin-bottom: 10px;">Catering Orders</h4>
                    ${history.catering.length === 0 ? '<div style="color: var(--gray); font-style: italic; margin-bottom: 15px;">No catering orders</div>' : history.catering.map(order => `
                        <div style="background: var(--gray-light); padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="font-weight: 600;">${order.date} - ${order.guests} guests</div>
                            <div style="font-size: 0.9em; color: var(--gray);">$${order.price.toFixed(2)} - ${order.status}</div>
                            <button class="btn" onclick="reorderCatering(${order.id})" style="margin-top: 8px; padding: 6px 12px; font-size: 0.85em; width: 100%; background: var(--orange); color: white;">Reorder</button>
                        </div>
                    `).join('')}
                    
                    <h4 style="margin: 15px 0 10px 0;">Events</h4>
                    ${history.events.length === 0 ? '<div style="color: var(--gray); font-style: italic;">No events</div>' : history.events.map(event => `
                        <div style="background: var(--gray-light); padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="font-weight: 600;">${event.name}</div>
                            <div style="font-size: 0.9em; color: var(--gray);">${event.date} - ${event.location}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            modal.classList.add('show');
        }
        
        async function reorderCatering(orderId) {
            const order = await fetch('/api/catering').then(r => r.json()).then(orders => orders.find(o => o.id === orderId));
            if (!order) return;
            
            closeAddModal();
            setTimeout(() => {
                addCateringOrder();
                setTimeout(() => {
                    document.getElementById('cateringContactId').value = order.contact_id || '';
                    document.getElementById('cateringClient').value = order.client;
                    document.getElementById('cateringGuests').value = order.guests;
                    document.getElementById('cateringLocation').value = order.location || '';
                    document.getElementById('cateringNotes').value = order.notes || '';
                    
                    const selectedMenu = JSON.parse(order.selected_menu || '[]');
                    selectedMenu.forEach(item => {
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const priceInput = document.getElementById(`price-${item.id}`);
                        if (qtyInput) qtyInput.value = item.quantity;
                        if (priceInput) priceInput.value = item.total;
                    });
                    updateNewQuoteTotal();
                }, 500);
            }, 100);
        }
        
        function deleteContact(id) {
            if (confirm('Delete this contact?')) {
                fetch(`/api/contacts/${id}`, { method: 'DELETE' })
                    .then(() => loadContacts());
            }
        }

        // Settings Functions
        function toggleSettingsSection(section) {
            const content = document.getElementById(`${section}-content`);
            const icon = document.getElementById(`${section}-icon`);
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.textContent = '▼';
            } else {
                content.classList.add('show');
                icon.textContent = '▲';
            }
        }
        
        function toggleCategorySection(section) {
            const sectionDiv = document.getElementById(`${section}-section`);
            const arrow = document.getElementById(`${section}-arrow`);
            
            if (sectionDiv.style.display === 'none') {
                sectionDiv.style.display = 'block';
                arrow.textContent = '▼';
            } else {
                sectionDiv.style.display = 'none';
                arrow.textContent = '▶';
            }
            event.stopPropagation();
        }
        
        function saveDefaultMargin() {
            const margin = document.getElementById('defaultMargin').value;
            if (margin) {
                localStorage.setItem('defaultMargin', margin);
            }
        }
        
        function loadDefaultMargin() {
            const margin = localStorage.getItem('defaultMargin') || '30';
            document.getElementById('defaultMargin').value = margin;
        }
        
        async function saveBusinessInfo() {
            const data = {
                name: 'Birria Fusion',
                phone: document.getElementById('businessPhone').value,
                email: document.getElementById('businessEmail').value,
                address: document.getElementById('businessAddress').value,
                website: document.getElementById('businessWebsite').value,
                facebook: document.getElementById('businessFacebook').value,
                instagram: document.getElementById('businessInstagram').value,
                default_margin: parseFloat(document.getElementById('defaultMargin').value) || 30
            };
            await fetch('/api/business-info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            alert('Business information saved!');
        }
        
        async function loadBusinessInfo() {
            const response = await fetch('/api/business-info');
            const info = await response.json();
            document.getElementById('businessPhone').value = info.phone || '';
            document.getElementById('businessEmail').value = info.email || '';
            document.getElementById('businessAddress').value = info.address || '';
            document.getElementById('businessWebsite').value = info.website || '';
            document.getElementById('businessFacebook').value = info.facebook || '';
            document.getElementById('businessInstagram').value = info.instagram || '';
        }
        
        function loadUserProfile() {
            if (!currentUser) return;
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profileUsername').value = currentUser.username || '';
        }
        
        function updateUserProfile() {
            if (!currentUser) return;
            
            const name = document.getElementById('profileName').value.trim();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!name) {
                alert('Name is required');
                return;
            }
            
            // Update name
            currentUser.name = name;
            
            // Update password if provided
            if (newPassword) {
                if (!currentPassword) {
                    alert('Please enter your current password');
                    return;
                }
                
                if (currentUser.password !== currentPassword) {
                    alert('Current password is incorrect');
                    return;
                }
                
                if (newPassword.length < 8) {
                    alert('New password must be at least 8 characters');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                currentUser.password = newPassword;
            }
            
            // Update in localStorage
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            alert('Profile updated successfully!');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        function clearData() {
            if (confirm('This will delete ALL data. Are you sure?')) {
                localStorage.clear();
                alert('Data cleared! Please refresh the page.');
            }
        }

        // License Functions
        function addLicense() {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Add License/Permit';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <select id="licenseType">
                            <option value="Business License">Business License</option>
                            <option value="Food Handler's Permit">Food Handler's Permit</option>
                            <option value="Mobile Vendor Permit">Mobile Vendor Permit</option>
                            <option value="Health Department Permit">Health Department Permit</option>
                            <option value="Fire Department Permit">Fire Department Permit</option>
                            <option value="State Sales Tax License">State Sales Tax License</option>
                            <option value="Workers Compensation">Workers Compensation</option>
                            <option value="General Liability Insurance">General Liability Insurance</option>
                            <option value="Vehicle Registration">Vehicle Registration</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="customNameField" style="display: none;">
                        <input type="text" id="customLicenseName" placeholder="Enter license name">
                    </div>
                    <div class="form-row">
                        <input type="text" id="licenseNumber" placeholder="License/Permit Number">
                        <input type="text" id="issuingAgency" placeholder="Issuing Agency">
                    </div>
                    <div class="form-row">
                        <input type="text" id="expirationDate" placeholder="Expiration Date" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                        <input type="text" id="renewalCost" placeholder="Renewal Cost ($)">
                    </div>
                    <button class="btn" onclick="saveLicense(); closeAddModal();">Add License</button>
                </div>
            `;
            
            // Show custom name field when "Other" is selected
            setTimeout(() => {
                document.getElementById('licenseType').onchange = function() {
                    const customField = document.getElementById('customNameField');
                    customField.style.display = this.value === 'Other' ? 'block' : 'none';
                };
            }, 100);
            
            modal.classList.add('show');
        }
        
        function saveLicense() {
            const type = document.getElementById('licenseType').value;
            const customName = document.getElementById('customLicenseName')?.value;
            const name = type === 'Other' ? customName : type;
            const number = document.getElementById('licenseNumber').value;
            const agency = document.getElementById('issuingAgency').value;
            const expiration = document.getElementById('expirationDate').value;
            const cost = document.getElementById('renewalCost').value;
            
            if (!name || !expiration) {
                alert('Please enter license name and expiration date');
                return;
            }
            
            const licenses = JSON.parse(localStorage.getItem('licenses') || '[]');
            licenses.push({
                id: Date.now(),
                name,
                number,
                agency,
                expiration,
                cost
            });
            localStorage.setItem('licenses', JSON.stringify(licenses));
            loadLicenses();
        }
        
        function loadLicenses() {
            const licenses = JSON.parse(localStorage.getItem('licenses') || '[]');
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('licenseList').innerHTML = licenses.map(license => {
                const expDate = new Date(license.expiration);
                const daysUntilExp = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
                
                let status, statusColor;
                if (daysUntilExp < 0) {
                    status = '🔴 EXPIRED';
                    statusColor = 'var(--danger)';
                } else if (daysUntilExp <= 30) {
                    status = '🟡 Expires Soon';
                    statusColor = 'var(--warning)';
                } else {
                    status = '🟢 Valid';
                    statusColor = 'var(--success)';
                }
                
                return `
                    <div class="file-card">
                        <div class="file-icon" style="background: ${statusColor}; font-size: 0.6em;">${license.name.slice(0,4).toUpperCase()}</div>
                        <div class="file-name">${license.name}</div>
                        <div class="file-meta">${license.agency || 'No agency'}</div>
                        <div class="file-meta">Expires: ${license.expiration}</div>
                        <div class="file-meta" style="color: ${statusColor}; font-weight: bold;">${status}</div>
                        <div class="file-actions">
                            <button class="btn" onclick="renewLicense(${license.id})" style="background: var(--orange); color: white;">Renew</button>
                            <button class="btn btn-danger" onclick="deleteLicense(${license.id})">Del</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renewLicense(id) {
            const licenses = JSON.parse(localStorage.getItem('licenses') || '[]');
            const license = licenses.find(l => l.id === id);
            if (!license) return;
            
            const newExpiration = prompt('Enter new expiration date (YYYY-MM-DD):', license.expiration);
            if (newExpiration && /^\d{4}-\d{2}-\d{2}$/.test(newExpiration)) {
                license.expiration = newExpiration;
                localStorage.setItem('licenses', JSON.stringify(licenses));
                loadLicenses();
            }
        }
        
        function deleteLicense(id) {
            if (confirm('Delete this license/permit?')) {
                const licenses = JSON.parse(localStorage.getItem('licenses') || '[]');
                const filtered = licenses.filter(l => l.id !== id);
                localStorage.setItem('licenses', JSON.stringify(filtered));
                loadLicenses();
            }
        }

        // Maintenance Functions
        function addMaintenanceTask() {
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Add Maintenance Task';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="taskName" placeholder="Task Name (e.g., Clean Fryer, Health Inspection)">
                    </div>
                    <div class="form-row">
                        <select id="taskType">
                            <option value="Equipment">Equipment Service</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Inspection">Health Inspection</option>
                            <option value="Permit">Permit Renewal</option>
                        </select>
                        <select id="frequency">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Yearly">Yearly</option>
                            <option value="Once">One-time</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <input type="text" id="nextDue" placeholder="Next Due Date" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                        <input type="text" id="lastDone" placeholder="Last Completed" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
                    </div>
                    <button class="btn" onclick="saveMaintenanceTask(); closeAddModal();">Add Task</button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function saveMaintenanceTask() {
            const name = document.getElementById('taskName').value;
            const type = document.getElementById('taskType').value;
            const frequency = document.getElementById('frequency').value;
            const nextDue = document.getElementById('nextDue').value;
            const lastDone = document.getElementById('lastDone').value;
            
            if (!name || !nextDue) {
                alert('Please enter task name and due date');
                return;
            }
            
            const tasks = JSON.parse(localStorage.getItem('maintenanceTasks') || '[]');
            tasks.push({
                id: Date.now(),
                name,
                type,
                frequency,
                nextDue,
                lastDone,
                completed: false
            });
            localStorage.setItem('maintenanceTasks', JSON.stringify(tasks));
            loadMaintenanceTasks();
        }
        
        function loadMaintenanceTasks() {
            const tasks = JSON.parse(localStorage.getItem('maintenanceTasks') || '[]');
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('maintenanceList').innerHTML = tasks.map(task => {
                const isOverdue = task.nextDue < today;
                const isDueSoon = task.nextDue <= new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
                const status = isOverdue ? '🔴 Overdue' : isDueSoon ? '🟡 Due Soon' : '🟢 On Track';
                const statusColor = isOverdue ? 'var(--danger)' : isDueSoon ? 'var(--warning)' : 'var(--success)';
                
                return `
                    <div class="file-card">
                        <div class="file-icon" style="background: ${statusColor}; font-size: 0.7em;">${task.type.slice(0,3).toUpperCase()}</div>
                        <div class="file-name">${task.name}</div>
                        <div class="file-meta">${task.frequency} • Due: ${task.nextDue}</div>
                        <div class="file-meta" style="color: ${statusColor}; font-weight: bold;">${status}</div>
                        <div class="file-actions">
                            <button class="btn" onclick="completeTask(${task.id})" style="background: var(--success); color: white;">Done</button>
                            <button class="btn btn-danger" onclick="deleteMaintenanceTask(${task.id})">Del</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function completeTask(id) {
            const tasks = JSON.parse(localStorage.getItem('maintenanceTasks') || '[]');
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            const today = new Date().toISOString().split('T')[0];
            task.lastDone = today;
            
            // Calculate next due date based on frequency
            const nextDate = new Date(today);
            switch(task.frequency) {
                case 'Daily': nextDate.setDate(nextDate.getDate() + 1); break;
                case 'Weekly': nextDate.setDate(nextDate.getDate() + 7); break;
                case 'Monthly': nextDate.setMonth(nextDate.getMonth() + 1); break;
                case 'Quarterly': nextDate.setMonth(nextDate.getMonth() + 3); break;
                case 'Yearly': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
                case 'Once': 
                    tasks.splice(tasks.findIndex(t => t.id === id), 1);
                    localStorage.setItem('maintenanceTasks', JSON.stringify(tasks));
                    loadMaintenanceTasks();
                    return;
            }
            
            task.nextDue = nextDate.toISOString().split('T')[0];
            localStorage.setItem('maintenanceTasks', JSON.stringify(tasks));
            loadMaintenanceTasks();
        }
        
        function deleteMaintenanceTask(id) {
            if (confirm('Delete this maintenance task?')) {
                const tasks = JSON.parse(localStorage.getItem('maintenanceTasks') || '[]');
                const filtered = tasks.filter(t => t.id !== id);
                localStorage.setItem('maintenanceTasks', JSON.stringify(filtered));
                loadMaintenanceTasks();
            }
        }

        // Employee Functions
        function addEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const role = document.getElementById('newEmployeeRole').value;
            const email = document.getElementById('newEmployeeEmail').value.trim();
            const phone = document.getElementById('newEmployeePhone').value.trim();
            const address = document.getElementById('newEmployeeAddress').value.trim();
            const notes = document.getElementById('newEmployeeNotes').value.trim();
            
            if (!name || !role) {
                alert('Please enter employee name and role');
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const newEmployee = {
                id: Date.now(),
                name,
                role,
                email,
                phone,
                address,
                notes,
                status: 'signed-out',
                signInTime: null
            };
            
            employees.push(newEmployee);
            localStorage.setItem('employees', JSON.stringify(employees));
            
            // Clear form
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newEmployeeRole').value = '';
            document.getElementById('newEmployeeEmail').value = '';
            document.getElementById('newEmployeePhone').value = '';
            document.getElementById('newEmployeeAddress').value = '';
            document.getElementById('newEmployeeNotes').value = '';
            
            loadEmployees();
        }
        
        function toggleEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            const icon = document.getElementById('emplist-icon');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '▲';
                loadEmployeeList();
            } else {
                container.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        
        function toggleAddEmployeeInList() {
            const form = document.getElementById('add-employee-form');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
        
        function loadEmployeeList() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const list = document.getElementById('employeeList');
            
            let html = '';
            
            if (employees.length === 0) {
                html = '<div style="color: var(--gray); font-style: italic; text-align: center; padding: 20px;">No employees added yet</div>';
            } else {
                html = employees.map(emp => `
                    <div style="background: var(--gray-light); padding: 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">${emp.name}</div>
                            <div style="font-size: 0.85em; color: var(--gray);">${emp.role}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn" onclick="editEmployee(${emp.id})" style="padding: 6px 12px; font-size: 0.85em; width: auto; background: var(--orange); color: white;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteEmployee(${emp.id})" style="padding: 6px 12px; font-size: 0.85em; width: auto;">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            list.innerHTML = html;
        }
        
        function loadEmployees() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            
            // Update employee select dropdown
            const employeeSelect = document.getElementById('employeeSelect');
            employeeSelect.innerHTML = '<option value="">Select employee...</option>' +
                employees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.role})</option>`).join('');
            
            loadEmployeeList();
            
            // Update status list
            const statusList = document.getElementById('employeeStatusList');
            if (employees.length === 0) {
                statusList.innerHTML = '<div style="color: var(--gray); font-style: italic;">No employees added yet. Add an employee above to get started.</div>';
                return;
            }
            
            console.log('Loading employees:', employees);
            
            statusList.innerHTML = employees.map(emp => {
                const statusColor = emp.status === 'signed-in' ? 'var(--success)' : 'var(--gray)';
                const statusText = emp.status === 'signed-in' ? `Signed in at ${emp.signInTime}` : 'Signed out';
                
                return `
                    <div style="background: var(--white); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
                        <div onclick="toggleEmployeeDetails(${emp.id})" style="cursor: pointer; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; font-size: 1.1em;">${emp.name}</div>
                                <div style="font-size: 0.9em; color: var(--gray);">${emp.role}</div>
                                <div style="font-size: 0.8em; color: ${statusColor};">${statusText}</div>
                            </div>
                            <span id="emp-icon-${emp.id}" style="font-size: 1.2em;">▼</span>
                        </div>
                        <div id="emp-details-${emp.id}" style="display: none; padding: 0 15px 15px 15px; border-top: 1px solid var(--border);">
                            ${emp.email ? `<div style="margin: 8px 0;"><strong>Email:</strong> ${emp.email}</div>` : ''}
                            ${emp.phone ? `<div style="margin: 8px 0;"><strong>Phone:</strong> ${emp.phone}</div>` : ''}
                            ${emp.address ? `<div style="margin: 8px 0;"><strong>Address:</strong> ${emp.address}</div>` : ''}
                            ${emp.notes ? `<div style="margin: 8px 0;"><strong>Notes:</strong> ${emp.notes}</div>` : ''}
                            <div style="display: flex; gap: 8px; margin-top: 15px;">
                                <button class="btn" onclick="editEmployee(${emp.id})" style="padding: 8px 16px; font-size: 0.9em; width: auto; background: var(--orange); color: white;">Edit</button>
                                <button class="btn btn-danger" onclick="deleteEmployee(${emp.id})" style="padding: 8px 16px; font-size: 0.9em; width: auto;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update current status for time clock functionality
            updateCurrentStatus();
        }
        
        function editEmployee(id) {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Edit Employee';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="editEmployeeName" placeholder="Employee Name" value="${employee.name}">
                    </div>
                    <div class="form-group">
                        <select id="editEmployeeRole">
                            <option value="">Select role...</option>
                            ${getAllEmployeeRoles().map(role => `<option value="${role}" ${employee.role === role ? 'selected' : ''}>${role}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="email" id="editEmployeeEmail" placeholder="Email" value="${employee.email || ''}">
                    </div>
                    <div class="form-group">
                        <input type="tel" id="editEmployeePhone" placeholder="Phone" value="${employee.phone || ''}">
                    </div>
                    <div class="form-group">
                        <input type="text" id="editEmployeeAddress" placeholder="Address" value="${employee.address || ''}">
                    </div>
                    <div class="form-group">
                        <textarea id="editEmployeeNotes" placeholder="Notes" rows="2">${employee.notes || ''}</textarea>
                    </div>
                    <button class="btn" onclick="updateEmployee(${id}); closeAddModal();">Update Employee</button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function updateEmployee(id) {
            const name = document.getElementById('editEmployeeName').value.trim();
            const role = document.getElementById('editEmployeeRole').value;
            const email = document.getElementById('editEmployeeEmail').value.trim();
            const phone = document.getElementById('editEmployeePhone').value.trim();
            const address = document.getElementById('editEmployeeAddress').value.trim();
            const notes = document.getElementById('editEmployeeNotes').value.trim();
            
            if (!name || !role) {
                alert('Please enter employee name and role');
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employeeIndex = employees.findIndex(emp => emp.id === id);
            
            if (employeeIndex !== -1) {
                employees[employeeIndex] = {
                    ...employees[employeeIndex],
                    name,
                    role,
                    email,
                    phone,
                    address,
                    notes
                };
                localStorage.setItem('employees', JSON.stringify(employees));
                loadEmployees();
            }
        }
        
        function deleteEmployee(id) {
            if (confirm('Delete this employee?')) {
                fetch(`/api/employees/${id}`, { method: 'DELETE' })
                    .then(() => loadEmployees());
            }
        }








        
        function toggleEmployeeStatus() {
            const selectedId = document.getElementById('employeeSelect').value;
            if (!selectedId) {
                alert('Please select an employee');
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employee = employees.find(emp => emp.id == selectedId);
            if (!employee) return;
            
            if (employee.status === 'signed-out') {
                employee.status = 'signed-in';
                employee.signInTime = new Date().toLocaleTimeString();
            } else {
                employee.status = 'signed-out';
                employee.signInTime = null;
            }
            
            localStorage.setItem('employees', JSON.stringify(employees));
            loadEmployees();
            updateCurrentStatus();
        }
        
        function updateCurrentStatus() {
            const selectedId = document.getElementById('employeeSelect').value;
            const statusDiv = document.getElementById('currentStatus');
            const clockBtn = document.getElementById('clockBtn');
            
            if (!selectedId) {
                statusDiv.textContent = '';
                clockBtn.textContent = 'Punch In';
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employee = employees.find(emp => emp.id == selectedId);
            
            if (employee) {
                if (employee.status === 'signed-in') {
                    statusDiv.textContent = `Signed in at ${employee.signInTime}`;
                    statusDiv.style.color = 'var(--success)';
                    clockBtn.textContent = 'Punch Out';
                } else {
                    statusDiv.textContent = 'Currently signed out';
                    statusDiv.style.color = 'var(--gray)';
                    clockBtn.textContent = 'Punch In';
                }
            }
        }
        
        window.toggleEmployeeDetails = function(id) {
            const details = document.getElementById(`emp-details-${id}`);
            const icon = document.getElementById(`emp-icon-${id}`);
            
            if (details && icon) {
                if (details.style.display === 'none') {
                    details.style.display = 'block';
                    icon.textContent = '▲';
                } else {
                    details.style.display = 'none';
                    icon.textContent = '▼';
                }
            }
        };
        
        function toggleAddEmployee() {
            const form = document.getElementById('add-employee-form');
            const icon = document.getElementById('add-emp-icon');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                icon.textContent = '▲';
            } else {
                form.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        
        function toggleTimePunches() {
            const container = document.getElementById('timePunchHistoryContainer');
            const icon = document.getElementById('punch-icon');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '▲';
                updatePunchFilter();
                loadTimePunchHistory();
            } else {
                container.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        
        function updatePunchFilter() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const filter = document.getElementById('punchFilter');
            const currentValue = filter.value;
            
            filter.innerHTML = '<option value="all">All Employees</option>' + 
                employees.map(emp => `<option value="${emp.name}" ${currentValue === emp.name ? 'selected' : ''}>${emp.name}</option>`).join('');
        }
        
        function loadTimePunchHistory() {
            const punches = JSON.parse(localStorage.getItem('timePunches') || '[]');
            const history = document.getElementById('timePunchHistory');
            const filterValue = document.getElementById('punchFilter').value;
            const dateFilter = document.getElementById('punchDateFilter').value;
            
            // Filter punches by selected employee
            let filteredPunches = filterValue === 'all' ? punches : punches.filter(p => p.employeeName === filterValue);
            
            // Filter by date if selected
            if (dateFilter) {
                const filterDate = new Date(dateFilter + 'T00:00:00');
                filteredPunches = filteredPunches.filter(p => {
                    const punchDate = new Date(p.timestamp);
                    return punchDate.getFullYear() === filterDate.getFullYear() &&
                           punchDate.getMonth() === filterDate.getMonth() &&
                           punchDate.getDate() === filterDate.getDate();
                });
            }
            
            if (filteredPunches.length === 0) {
                history.innerHTML = '<div style="color: var(--gray); font-style: italic;">No time punches found.</div>';
                return;
            }
            
            const today = new Date().toDateString();
            const displayPunches = dateFilter ? filteredPunches.reverse() : filteredPunches.slice(-20).reverse();
            
            history.innerHTML = displayPunches.map(punch => {
                const date = new Date(punch.timestamp);
                const isToday = date.toDateString() === today;
                const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateStr = isToday ? 'Today' : date.toLocaleDateString();
                
                return `
                    <div style="display: flex; justify-content: space-between; padding: 8px; margin-bottom: 5px; background: var(--gray-light); border-radius: 6px;">
                        <div>
                            <div style="font-weight: bold;">${punch.employeeName}</div>
                            <div style="font-size: 0.8em; color: var(--gray);">${dateStr} at ${timeStr}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${(punch.action === 'punch-in' || punch.action === 'sign-in') ? 'var(--success)' : 'var(--danger)'}; font-weight: bold; font-size: 0.9em;">${punch.action.replace('sign-', 'punch-').toUpperCase()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Employee Management Functions
        

        
        function toggleEmployeeStatus() {
            const employeeId = document.getElementById('employeeSelect').value;
            if (!employeeId) {
                alert('Please select an employee');
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employee = employees.find(emp => emp.id == employeeId);
            if (!employee) return;
            
            const now = new Date();
            const punches = JSON.parse(localStorage.getItem('timePunches') || '[]');
            
            if (employee.status === 'signed-out') {
                employee.status = 'signed-in';
                employee.signInTime = now.toISOString();
                
                // Record sign-in punch
                punches.push({
                    employeeId: employee.id,
                    employeeName: employee.name,
                    action: 'punch-in',
                    timestamp: now.toISOString()
                });
            } else {
                employee.status = 'signed-out';
                
                // Record sign-out punch
                punches.push({
                    employeeId: employee.id,
                    employeeName: employee.name,
                    action: 'punch-out',
                    timestamp: now.toISOString()
                });
                
                if (employee.signInTime) {
                    const signInTime = new Date(employee.signInTime);
                    const hoursWorked = (now - signInTime) / (1000 * 60 * 60);
                    employee.totalHours += hoursWorked;
                }
                employee.signInTime = null;
            }
            
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('timePunches', JSON.stringify(punches));
            updateCurrentStatus();
            updateEmployeeStatusList();
        }
        
        function updateCurrentStatus() {
            const employeeId = document.getElementById('employeeSelect').value;
            const btn = document.getElementById('clockBtn');
            const status = document.getElementById('currentStatus');
            
            if (!employeeId) {
                btn.textContent = 'Punch In';
                btn.style.background = 'var(--orange)';
                status.innerHTML = '';
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employee = employees.find(emp => emp.id == employeeId);
            if (!employee) return;
            
            if (employee.status === 'signed-in') {
                btn.textContent = 'Punch Out';
                btn.style.background = 'var(--danger)';
                const signInTime = new Date(employee.signInTime);
                const currentTime = (new Date() - signInTime) / (1000 * 60 * 60);
                status.innerHTML = `<div style="color: var(--success); font-weight: bold;">Signed in since ${signInTime.toLocaleTimeString()}</div><div>Current shift: ${currentTime.toFixed(1)} hours</div>`;
            } else {
                btn.textContent = 'Punch In';
                btn.style.background = 'var(--success)';
                status.innerHTML = `<div style="color: var(--gray);">Signed out</div><div>Total hours: ${employee.totalHours.toFixed(1)}</div>`;
            }
        }
        
        function updateEmployeeStatusList() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const list = document.getElementById('employeeStatusList');
            
            if (employees.length === 0) {
                list.innerHTML = '<div style="color: var(--gray); font-style: italic;">No employees added yet</div>';
                return;
            }
            
            list.innerHTML = employees.map(emp => {
                const statusColor = emp.status === 'signed-in' ? 'var(--success)' : 'var(--gray)';
                const statusText = emp.status === 'signed-in' ? 'SIGNED IN' : 'Signed Out';
                let timeInfo = '';
                
                if (emp.status === 'signed-in' && emp.signInTime) {
                    const signInTime = new Date(emp.signInTime);
                    const currentHours = (new Date() - signInTime) / (1000 * 60 * 60);
                    timeInfo = `Current: ${currentHours.toFixed(1)}h`;
                } else {
                    timeInfo = `Total: ${emp.totalHours.toFixed(1)}h`;
                }
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 5px; background: var(--gray-light); border-radius: 6px;">
                        <div>
                            <div style="font-weight: bold;">${emp.name}</div>
                            <div style="font-size: 0.8em; color: var(--gray);">${emp.role}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${statusColor}; font-weight: bold; font-size: 0.8em;">${statusText}</div>
                            <div style="font-size: 0.8em; color: var(--gray);">${timeInfo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('employeeSelect')?.addEventListener('change', updateCurrentStatus);

        // Cost Calculator Functions
        function toggleCostSection(section) {
            const content = document.getElementById(`${section}-content`);
            const icon = document.getElementById(`${section}-icon`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▲';
            } else {
                content.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        
        function loadRecipeForCalculation() {
            const recipeId = document.getElementById('recipeSelect').value;
            if (!recipeId) {
                document.getElementById('recipeCalculation').innerHTML = '';
                return;
            }
            
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    const recipe = items.find(item => item.id == recipeId);
                    if (!recipe) return;
                    
                    const ingredients = JSON.parse(localStorage.getItem(`recipe-${recipeId}`) || '[]');
                    const totalCost = ingredients.reduce((sum, ing) => sum + (ing.calculatedCost || 0), 0);
                    const costPerPortion = totalCost / recipe.portions;
                    const margin = ((recipe.price - costPerPortion) / recipe.price) * 100;
                    
                    document.getElementById('recipeCalculation').innerHTML = `
                        <div style="font-size: 0.9em; line-height: 1.4;">
                            <div><strong>${recipe.name}</strong></div>
                            <div>Total Cost: $${totalCost.toFixed(2)}</div>
                            <div>Portions: ${recipe.portions}</div>
                            <div>Cost per Portion: $${costPerPortion.toFixed(2)}</div>
                            <div>Selling Price: $${recipe.price.toFixed(2)}</div>
                            <div style="color: ${margin >= 30 ? 'var(--success)' : margin >= 20 ? 'var(--warning)' : 'var(--danger)'}">Margin: ${margin.toFixed(1)}%</div>
                        </div>
                    `;
                });
        }
        
        function calculatePortionCost() {
            const baseCost = parseFloat(document.getElementById('baseCost').value);
            const basePortions = parseFloat(document.getElementById('basePortions').value);
            const newPortions = parseFloat(document.getElementById('newPortions').value);
            
            if (!baseCost || !basePortions || !newPortions) {
                alert('Please fill in all fields');
                return;
            }
            
            const costPerPortion = baseCost / basePortions;
            const newTotalCost = costPerPortion * newPortions;
            const scaleFactor = newPortions / basePortions;
            
            document.getElementById('portionResult').innerHTML = `
                <div style="font-size: 0.9em; line-height: 1.4;">
                    <div>Cost per Portion: $${costPerPortion.toFixed(2)}</div>
                    <div>New Total Cost: $${newTotalCost.toFixed(2)}</div>
                    <div>Scale Factor: ${scaleFactor.toFixed(2)}x</div>
                </div>
            `;
        }
        
        function calculateBreakEven() {
            const eventCosts = parseFloat(document.getElementById('eventCosts').value);
            const avgPrice = parseFloat(document.getElementById('avgItemPrice').value);
            const avgCost = parseFloat(document.getElementById('avgItemCost').value);
            
            if (!eventCosts || !avgPrice || !avgCost) {
                alert('Please fill in all fields');
                return;
            }
            
            const profitPerItem = avgPrice - avgCost;
            const breakEvenUnits = Math.ceil(eventCosts / profitPerItem);
            const breakEvenRevenue = breakEvenUnits * avgPrice;
            
            document.getElementById('breakEvenResult').innerHTML = `
                <div style="font-size: 0.9em; line-height: 1.4;">
                    <div>Profit per Item: $${profitPerItem.toFixed(2)}</div>
                    <div style="color: var(--orange);">Break-Even: ${breakEvenUnits} items</div>
                    <div>Break-Even Revenue: $${breakEvenRevenue.toFixed(2)}</div>
                    <div style="font-size: 0.8em; color: var(--gray); margin-top: 5px;">Need to sell ${breakEvenUnits} items to cover $${eventCosts.toFixed(2)} in costs</div>
                </div>
            `;
        }
        
        function loadRecipesForCalculator() {
            fetch('/api/menu')
                .then(r => r.json())
                .then(items => {
                    const select = document.getElementById('recipeSelect');
                    if (select) {
                        select.innerHTML = '<option value="">Select a recipe...</option>' +
                            items.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                    }
                });
        }

        // QR Code Functions
        function updateQRPlaceholder() {
            const type = document.getElementById('qrType').value;
            const input = document.getElementById('qrContent');
            const wifiFields = document.getElementById('wifiFields');
            
            wifiFields.style.display = type === 'wifi' ? 'block' : 'none';
            
            const placeholders = {
                url: 'https://your-menu-website.com',
                text: 'Welcome to Birria Fusion!',
                phone: '+1-555-123-4567',
                email: 'info@birriafusion.com',
                wifi: 'Leave blank for WiFi'
            };
            
            input.placeholder = placeholders[type];
            if (type === 'wifi') input.style.display = 'none';
            else input.style.display = 'block';
        }
        
        function generateQR() {
            const type = document.getElementById('qrType').value;
            let content = '';
            
            if (type === 'wifi') {
                const ssid = document.getElementById('wifiSSID').value;
                const password = document.getElementById('wifiPassword').value;
                if (!ssid) {
                    alert('Please enter network name');
                    return;
                }
                content = `WIFI:T:WPA;S:${ssid};P:${password};;`;
            } else {
                content = document.getElementById('qrContent').value;
                if (!content) {
                    alert('Please enter content for QR code');
                    return;
                }
                
                if (type === 'phone') content = `tel:${content}`;
                if (type === 'email') content = `mailto:${content}`;
            }
            
            // Generate QR code using Google Charts API
            const size = '200x200';
            const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=${size}&chl=${encodeURIComponent(content)}`;
            
            document.getElementById('qrResult').innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; display: inline-block; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <img src="${qrUrl}" alt="QR Code" style="display: block; margin-bottom: 10px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 10px; word-break: break-all;">${content}</div>
                    <button class="btn" onclick="downloadQR('${qrUrl}')" style="width: auto; padding: 8px 16px; font-size: 0.9em;">Download</button>
                </div>
            `;
        }
        
        function downloadQR(url) {
            const link = document.createElement('a');
            link.href = url;
            link.download = 'qr-code.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize
        initializeDefaultUsers();
        loadTheme();
        checkAuth();
        
        // Hide FAB on dashboard initially
        document.getElementById('fabBtn').style.display = 'none';

        // Enter key login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                attemptLogin();
            }
        });
        
        function editEmployee(id) {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Edit Employee';
            const roles = getAllEmployeeRoles();
            
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <input type="text" id="editEmployeeName" placeholder="Employee Name" value="${employee.name}">
                    </div>
                    <div class="form-group">
                        <select id="editEmployeeRole">
                            <option value="">Select role...</option>
                            ${roles.map(role => `<option value="${role}" ${employee.role === role ? 'selected' : ''}>${role}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="email" id="editEmployeeEmail" placeholder="Email" value="${employee.email || ''}">
                    </div>
                    <div class="form-group">
                        <input type="tel" id="editEmployeePhone" placeholder="Phone" value="${employee.phone || ''}">
                    </div>
                    <div class="form-group">
                        <input type="text" id="editEmployeeAddress" placeholder="Address" value="${employee.address || ''}">
                    </div>
                    <div class="form-group">
                        <textarea id="editEmployeeNotes" placeholder="Notes" rows="2">${employee.notes || ''}</textarea>
                    </div>
                    <button class="btn" onclick="updateEmployee(${id}); closeAddModal();">Update Employee</button>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function updateEmployee(id) {
            const name = document.getElementById('editEmployeeName').value.trim();
            const role = document.getElementById('editEmployeeRole').value;
            
            if (!name || !role) {
                alert('Please enter employee name and select a role');
                return;
            }
            
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const employeeIndex = employees.findIndex(emp => emp.id === id);
            
            const email = document.getElementById('editEmployeeEmail').value.trim();
            const phone = document.getElementById('editEmployeePhone').value.trim();
            const address = document.getElementById('editEmployeeAddress').value.trim();
            const notes = document.getElementById('editEmployeeNotes').value.trim();
            
            if (employeeIndex !== -1) {
                employees[employeeIndex].name = name;
                employees[employeeIndex].role = role;
                employees[employeeIndex].email = email;
                employees[employeeIndex].phone = phone;
                employees[employeeIndex].address = address;
                employees[employeeIndex].notes = notes;
                localStorage.setItem('employees', JSON.stringify(employees));
                loadEmployees();
            }
        }
        
        // Weekly Schedule Functions
        let currentWeekStart = new Date();
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
        
        function toggleAvailability() {
            const container = document.getElementById('availabilityContainer');
            const icon = document.getElementById('availability-icon');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '▲';
                loadAvailabilityEmployees();
            } else {
                container.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        
        async function loadAvailabilityEmployees() {
            const employees = await fetch('/api/employees').then(r => r.json());
            const select = document.getElementById('availabilityEmployee');
            select.innerHTML = '<option value="">Select employee...</option>' + employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }
        
        async function loadEmployeeAvailability() {
            const employeeId = document.getElementById('availabilityEmployee').value;
            if (!employeeId) {
                document.getElementById('availabilityGrid').innerHTML = '';
                return;
            }
            
            const availability = await fetch(`/api/availability/${employeeId}`).then(r => r.json());
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            let html = '';
            days.forEach((day, index) => {
                const avail = availability.find(a => a.day_of_week === index) || { available: false, start_time: '09:00', end_time: '17:00' };
                html += `<div style="background: var(--gray-light); padding: 12px; border-radius: 6px; margin-bottom: 8px;">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                html += `<span style="font-weight: 600;">${day}</span>`;
                html += `<label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="avail-${index}" ${avail.available ? 'checked' : ''} onchange="toggleDayAvailability(${employeeId}, ${index})"> Available</label>`;
                html += `</div>`;
                html += `<div id="times-${index}" style="${avail.available ? '' : 'display:none;'}display: flex; gap: 8px;">`;
                html += `<input type="time" id="start-${index}" value="${avail.start_time || '09:00'}" style="flex: 1; padding: 6px;" onchange="updateAvailability(${employeeId}, ${index})">`;
                html += `<input type="time" id="end-${index}" value="${avail.end_time || '17:00'}" style="flex: 1; padding: 6px;" onchange="updateAvailability(${employeeId}, ${index})">`;
                html += `</div></div>`;
            });
            
            document.getElementById('availabilityGrid').innerHTML = html;
        }
        
        async function toggleDayAvailability(employeeId, dayOfWeek) {
            const available = document.getElementById(`avail-${dayOfWeek}`).checked;
            const timesDiv = document.getElementById(`times-${dayOfWeek}`);
            timesDiv.style.display = available ? 'flex' : 'none';
            await updateAvailability(employeeId, dayOfWeek);
        }
        
        async function updateAvailability(employeeId, dayOfWeek) {
            const available = document.getElementById(`avail-${dayOfWeek}`).checked;
            const startTime = document.getElementById(`start-${dayOfWeek}`).value;
            const endTime = document.getElementById(`end-${dayOfWeek}`).value;
            
            await fetch('/api/availability', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employee_id: employeeId, day_of_week: dayOfWeek, available, start_time: startTime, end_time: endTime })
            });
        }

        function toggleWeeklySchedule() {
            const container = document.getElementById('weeklyScheduleContainer');
            const icon = document.getElementById('schedule-icon');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '▲';
                document.getElementById('scheduleWeekStart').valueAsDate = currentWeekStart;
                loadWeeklySchedule();
            } else {
                container.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            document.getElementById('scheduleWeekStart').valueAsDate = currentWeekStart;
            loadWeeklySchedule();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            document.getElementById('scheduleWeekStart').valueAsDate = currentWeekStart;
            loadWeeklySchedule();
        }

        async function loadWeeklySchedule() {
            const weekStart = new Date(document.getElementById('scheduleWeekStart').value);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            const [schedules, employees] = await Promise.all([
                fetch('/api/schedules').then(r => r.json()),
                fetch('/api/employees').then(r => r.json())
            ]);

            const weekSchedules = schedules.filter(s => {
                const shiftDate = new Date(s.shift_date);
                return shiftDate >= weekStart && shiftDate <= weekEnd;
            });

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const today = new Date().toISOString().split('T')[0];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const daySchedules = weekSchedules.filter(s => s.shift_date === dateStr);
                const isToday = dateStr === today;

                html += `<div style="background: var(--gray-light); border-left: 4px solid ${isToday ? 'var(--orange)' : 'transparent'}; padding: 12px; border-radius: 6px; margin-bottom: 10px;">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                html += `<div><span style="font-weight: 700; font-size: 1em; color: ${isToday ? 'var(--orange)' : 'var(--charcoal)'};">${days[i]}</span> <span style="font-size: 0.85em; color: var(--gray);">${date.getMonth() + 1}/${date.getDate()}</span></div>`;
                html += `</div>`;

                if (daySchedules.length === 0) {
                    html += `<div style="color: var(--gray); font-size: 0.85em; font-style: italic;">No shifts scheduled</div>`;
                } else {
                    html += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                    daySchedules.forEach(shift => {
                        html += `<div style="background: var(--orange); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; display: inline-block;">`;
                        html += `<div style="font-weight: 600;">${shift.employee_name}</div>`;
                        html += `<div style="opacity: 0.9;">${shift.start_time} - ${shift.end_time}</div>`;
                        if (shift.event_name) html += `<div style="font-size: 0.9em; margin-top: 2px; opacity: 0.8;">${shift.event_name}</div>`;
                        html += `<div style="display: flex; gap: 4px; margin-top: 4px;">`;
                        html += `<button onclick="editShift(${shift.id}); event.stopPropagation();" style="background: rgba(0,0,0,0.2); color: white; border: none; padding: 3px 8px; border-radius: 3px; font-size: 0.8em; cursor: pointer; flex: 1;">Edit</button>`;
                        html += `<button onclick="deleteShift(${shift.id}); event.stopPropagation();" style="background: rgba(0,0,0,0.2); color: white; border: none; padding: 3px 8px; border-radius: 3px; font-size: 0.8em; cursor: pointer; flex: 1;">Remove</button>`;
                        html += `</div></div>`;
                    });
                    html += `</div>`;
                }

                html += `</div>`;
            }

            document.getElementById('weeklySchedule').innerHTML = html;
            calculateOvertime(weekSchedules, employees);
        }

        function calculateOvertime(schedules, employees) {
            const employeeHours = {};
            schedules.forEach(s => {
                if (!employeeHours[s.employee_id]) {
                    employeeHours[s.employee_id] = { name: s.employee_name, hours: 0 };
                }
                employeeHours[s.employee_id].hours += s.hours || 0;
            });

            let html = '';
            Object.values(employeeHours).forEach(emp => {
                if (emp.hours > 40) {
                    html += `<div style="background: var(--warning); color: var(--charcoal); padding: 8px; border-radius: 4px; margin-bottom: 6px;">`;
                    html += `<strong>${emp.name}:</strong> ${emp.hours.toFixed(1)} hours (${(emp.hours - 40).toFixed(1)} overtime)`;
                    html += `</div>`;
                }
            });

            document.getElementById('overtimeAlerts').innerHTML = html || '<div style="color: var(--text-secondary); font-size: 0.9em;">No overtime this week</div>';
        }

        async function addShift() {
            const employees = await fetch('/api/employees').then(r => r.json());
            const events = await fetch('/api/events').then(r => r.json());

            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');

            modalTitle.textContent = 'Add Shift';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <label>Employee:</label>
                        <select id="shiftEmployee" style="width: 100%; padding: 8px;">
                            <option value="">Select employee...</option>
                            ${employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="shiftDate" style="width: 100%; padding: 8px;">
                    </div>
                    <div class="form-row">
                        <div style="flex: 1;">
                            <label>Start Time:</label>
                            <input type="time" id="shiftStart" style="width: 100%; padding: 8px;">
                        </div>
                        <div style="flex: 1;">
                            <label>End Time:</label>
                            <input type="time" id="shiftEnd" style="width: 100%; padding: 8px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Event (optional):</label>
                        <select id="shiftEvent" style="width: 100%; padding: 8px;">
                            <option value="">No event</option>
                            ${events.map(e => `<option value="${e.id}">${e.name} - ${e.date}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes:</label>
                        <textarea id="shiftNotes" style="width: 100%; padding: 8px;" rows="2"></textarea>
                    </div>
                    <button class="btn" onclick="saveShift()" style="background: var(--orange); color: white;">Save Shift</button>
                </div>
            `;
            modal.classList.add('show');
        }

        async function saveShift() {
            const employeeId = document.getElementById('shiftEmployee').value;
            const date = document.getElementById('shiftDate').value;
            const startTime = document.getElementById('shiftStart').value;
            const endTime = document.getElementById('shiftEnd').value;
            const eventId = document.getElementById('shiftEvent').value || null;
            const notes = document.getElementById('shiftNotes').value;

            if (!employeeId || !date || !startTime || !endTime) {
                alert('Please fill in employee, date, start time, and end time');
                return;
            }

            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            const hours = (end - start) / (1000 * 60 * 60);

            const response = await fetch('/api/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_id: employeeId,
                    event_id: eventId,
                    shift_date: date,
                    start_time: startTime,
                    end_time: endTime,
                    hours: hours,
                    notes: notes
                })
            });

            if (response.ok) {
                closeAddModal();
                const shiftDate = new Date(date);
                const weekStart = new Date(shiftDate);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                currentWeekStart = weekStart;
                document.getElementById('scheduleWeekStart').valueAsDate = weekStart;
                loadWeeklySchedule();
            } else {
                alert('Failed to save shift');
            }
        }

        async function editShift(id) {
            const schedules = await fetch('/api/schedules').then(r => r.json());
            const shift = schedules.find(s => s.id === id);
            if (!shift) return;
            
            const employees = await fetch('/api/employees').then(r => r.json());
            const events = await fetch('/api/events').then(r => r.json());
            
            const modal = document.getElementById('addModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalForm = document.getElementById('modalForm');
            
            modalTitle.textContent = 'Edit Shift';
            modalForm.innerHTML = `
                <div class="form">
                    <div class="form-group">
                        <label>Employee:</label>
                        <select id="shiftEmployee" style="width: 100%; padding: 8px;">
                            ${employees.map(e => `<option value="${e.id}" ${e.id == shift.employee_id ? 'selected' : ''}>${e.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="shiftDate" value="${shift.shift_date}" style="width: 100%; padding: 8px;">
                    </div>
                    <div class="form-row">
                        <div style="flex: 1;">
                            <label>Start Time:</label>
                            <input type="time" id="shiftStart" value="${shift.start_time}" style="width: 100%; padding: 8px;">
                        </div>
                        <div style="flex: 1;">
                            <label>End Time:</label>
                            <input type="time" id="shiftEnd" value="${shift.end_time}" style="width: 100%; padding: 8px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Event (optional):</label>
                        <select id="shiftEvent" style="width: 100%; padding: 8px;">
                            <option value="">No event</option>
                            ${events.map(e => `<option value="${e.id}" ${e.id == shift.event_id ? 'selected' : ''}>${e.name} - ${e.date}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes:</label>
                        <textarea id="shiftNotes" style="width: 100%; padding: 8px;" rows="2">${shift.notes || ''}</textarea>
                    </div>
                    <button class="btn" onclick="updateShift(${id})" style="background: var(--orange); color: white;">Update Shift</button>
                </div>
            `;
            modal.classList.add('show');
        }
        
        async function updateShift(id) {
            const employeeId = document.getElementById('shiftEmployee').value;
            const date = document.getElementById('shiftDate').value;
            const startTime = document.getElementById('shiftStart').value;
            const endTime = document.getElementById('shiftEnd').value;
            const eventId = document.getElementById('shiftEvent').value || null;
            const notes = document.getElementById('shiftNotes').value;
            
            if (!employeeId || !date || !startTime || !endTime) {
                alert('Please fill in employee, date, start time, and end time');
                return;
            }
            
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            const hours = (end - start) / (1000 * 60 * 60);
            
            await fetch(`/api/schedules/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_id: employeeId,
                    event_id: eventId,
                    shift_date: date,
                    start_time: startTime,
                    end_time: endTime,
                    hours: hours,
                    notes: notes
                })
            });
            
            closeAddModal();
            loadWeeklySchedule();
        }
        
        async function deleteShift(id) {
            if (!confirm('Delete this shift?')) return;
            await fetch(`/api/schedules/${id}`, { method: 'DELETE' });
            loadWeeklySchedule();
        }

        function printWeeklySchedule() {
            const printWindow = window.open('', '', 'width=800,height=600');
            const content = document.getElementById('weeklySchedule').innerHTML;
            const weekStart = document.getElementById('scheduleWeekStart').value;
            printWindow.document.write('<html><head><title>Weekly Staff Schedule</title>');
            printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}h1{text-align:center;}p{text-align:center;color:#666;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>Weekly Staff Schedule</h1>');
            printWindow.document.write('<p>Week of: ' + weekStart + '</p>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // Print Functions
        function printEvents() {
            fetch('/api/events')
                .then(r => r.json())
                .then(events => {
                    const printWindow = window.open('', '', 'width=800,height=600');
                    printWindow.document.write('<html><head><title>Event Schedule</title>');
                    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}.event{border:1px solid #ddd;padding:15px;margin-bottom:15px;page-break-inside:avoid;}.event-title{font-size:18px;font-weight:bold;color:#ff6b35;margin-bottom:10px;}.event-detail{margin:5px 0;}</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write('<h1>Event Schedule</h1>');
                    printWindow.document.write('<p>Printed: ' + new Date().toLocaleDateString() + '</p>');
                    events.forEach(e => {
                        printWindow.document.write(`<div class="event">`);
                        printWindow.document.write(`<div class="event-title">${e.name}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Type:</strong> ${e.type || 'N/A'}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Location:</strong> ${e.location || 'N/A'}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Date:</strong> ${e.date || 'N/A'}${e.end_date ? ' to ' + e.end_date : ''}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Time:</strong> ${e.time || 'N/A'}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Fee:</strong> $${e.fee || 0}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Status:</strong> ${e.status || 'N/A'}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Paid:</strong> ${e.paid ? 'Yes' : 'No'}</div>`);
                        if (e.notes) printWindow.document.write(`<div class="event-detail"><strong>Notes:</strong> ${e.notes}</div>`);
                        printWindow.document.write(`</div>`);
                    });
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.print();
                });
        }
        
        function printCatering() {
            fetch('/api/catering')
                .then(r => r.json())
                .then(orders => {
                    const printWindow = window.open('', '', 'width=800,height=600');
                    printWindow.document.write('<html><head><title>Catering Orders</title>');
                    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}.event{border:1px solid #ddd;padding:15px;margin-bottom:15px;page-break-inside:avoid;}.event-title{font-size:18px;font-weight:bold;color:#ff6b35;margin-bottom:10px;}.event-detail{margin:5px 0;}</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write('<h1>Catering Orders</h1>');
                    printWindow.document.write('<p>Printed: ' + new Date().toLocaleDateString() + '</p>');
                    orders.forEach(c => {
                        printWindow.document.write(`<div class="event">`);
                        printWindow.document.write(`<div class="event-title">${c.client}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Date:</strong> ${c.date || 'N/A'}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Location:</strong> ${c.location || 'N/A'}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Guests:</strong> ${c.guests || 0}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Price:</strong> $${c.price || 0}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Status:</strong> ${c.status || 'N/A'}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Deposit:</strong> $${c.deposit || 0}</div>`);
                        printWindow.document.write(`<div class="event-detail"><strong>Payment Status:</strong> ${c.payment_status || 'N/A'}</div>`);
                        if (c.setup_time) printWindow.document.write(`<div class="event-detail"><strong>Setup Time:</strong> ${c.setup_time} hours</div>`);
                        if (c.event_start_time) printWindow.document.write(`<div class="event-detail"><strong>Event Time:</strong> ${c.event_start_time} - ${c.event_end_time || ''}</div>`);
                        if (c.service_type) printWindow.document.write(`<div class="event-detail"><strong>Service:</strong> ${c.service_type}</div>`);
                        if (c.staff_count) printWindow.document.write(`<div class="event-detail"><strong>Staff:</strong> ${c.staff_count} ($${c.staff_cost || 0})</div>`);
                        if (c.equipment_provider) printWindow.document.write(`<div class="event-detail"><strong>Equipment:</strong> ${c.equipment_provider} ($${c.equipment_cost || 0})</div>`);
                        if (c.equipment_notes) printWindow.document.write(`<div class="event-detail"><strong>Equipment Details:</strong> ${c.equipment_notes}</div>`);
                        if (c.notes) printWindow.document.write(`<div class="event-detail"><strong>Notes:</strong> ${c.notes}</div>`);
                        if (c.personal_notes) printWindow.document.write(`<div class="event-detail"><strong>Internal Notes:</strong> ${c.personal_notes}</div>`);
                        printWindow.document.write(`</div>`);
                    });
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.print();
                });
        }

        function printSchedule() {
            const printWindow = window.open('', '', 'width=800,height=600');
            const content = document.getElementById('timePunchHistory').innerHTML;
            printWindow.document.write('<html><head><title>Time Punch History</title>');
            printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#ff6b35;color:white;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>Time Punch History</h1>');
            printWindow.document.write('<p>Printed: ' + new Date().toLocaleDateString() + '</p>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        async function printEventDetails(eventId) {
            const response = await fetch('/api/events');
            const events = await response.json();
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            let html = '<html><head><title>Event Details - ' + event.name + '</title>';
            html += '<style>body { font-family: Arial, sans-serif; padding: 40px; } h1 { color: #ff6b35; } .detail { margin: 10px 0; } .label { font-weight: bold; }</style>';
            html += '</head><body><h1>' + event.name + '</h1>';
            html += '<div class="detail"><span class="label">Type:</span> ' + event.type + '</div>';
            html += '<div class="detail"><span class="label">Location:</span> ' + event.location + '</div>';
            html += '<div class="detail"><span class="label">Date:</span> ' + event.date + (event.end_date ? ' - ' + event.end_date : '') + '</div>';
            if (event.time) html += '<div class="detail"><span class="label">Time:</span> ' + event.time + '</div>';
            if (event.fee > 0) html += '<div class="detail"><span class="label">Fee:</span> $' + event.fee.toFixed(2) + '</div>';
            html += '<div class="detail"><span class="label">Status:</span> ' + event.status + '</div>';
            if (event.notes) html += '<div class="detail"><span class="label">Notes:</span> ' + event.notes + '</div>';
            html += '<script>window.print(); window.close();<\/script></body></html>';
            printWindow.document.write(html);
            printWindow.document.close();
        }

        async function printCateringDetails(orderId) {
            const response = await fetch('/api/catering');
            const orders = await response.json();
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            let html = '<html><head><title>Catering Order - ' + order.client + '</title>';
            html += '<style>body { font-family: Arial, sans-serif; padding: 40px; } h1 { color: #ff6b35; } .detail { margin: 10px 0; } .label { font-weight: bold; } ul { margin: 5px 0 0 20px; }</style>';
            html += '</head><body><h1>Catering Order - ' + order.client + '</h1>';
            html += '<div class="detail"><span class="label">Date:</span> ' + order.date + '</div>';
            html += '<div class="detail"><span class="label">Guests:</span> ' + order.guests + '</div>';
            if (order.location) html += '<div class="detail"><span class="label">Location:</span> ' + order.location + '</div>';
            if (order.event_start_time || order.event_end_time) html += '<div class="detail"><span class="label">Event Time:</span> ' + (order.event_start_time || 'TBD') + ' - ' + (order.event_end_time || 'TBD') + '</div>';
            if (order.setup_time) html += '<div class="detail"><span class="label">Setup Time:</span> ' + order.setup_time + ' hours</div>';
            if (order.service_type) html += '<div class="detail"><span class="label">Service Type:</span> ' + order.service_type + '</div>';
            if (order.staff_count > 0) html += '<div class="detail"><span class="label">Staff:</span> ' + order.staff_count + ' staff - $' + order.staff_cost.toFixed(2) + '</div>';
            if (order.equipment_provider) html += '<div class="detail"><span class="label">Equipment:</span> ' + order.equipment_provider + (order.equipment_cost > 0 ? ' - $' + order.equipment_cost.toFixed(2) : '') + '</div>';
            if (order.equipment_notes) html += '<div class="detail"><span class="label">Equipment Notes:</span> ' + order.equipment_notes + '</div>';
            if (order.price > 0) html += '<div class="detail"><span class="label">Price:</span> $' + order.price.toFixed(2) + '</div>';
            if (order.deposit > 0) html += '<div class="detail"><span class="label">Deposit:</span> $' + order.deposit.toFixed(2) + '</div>';
            if (order.payment_status) html += '<div class="detail"><span class="label">Payment Status:</span> ' + order.payment_status + '</div>';
            html += '<div class="detail"><span class="label">Status:</span> ' + order.status + '</div>';
            if (order.selected_menu) {
                try {
                    const menu = typeof order.selected_menu === 'string' ? JSON.parse(order.selected_menu) : order.selected_menu;
                    if (menu && menu.length > 0) {
                        html += '<div class="detail"><span class="label">Menu Items:</span><ul>';
                        menu.forEach(item => {
                            html += '<li>' + item.name + ' (' + item.quantity + ' servings) - $' + (item.total || item.totalPrice).toFixed(2) + '</li>';
                        });
                        html += '</ul></div>';
                    }
                } catch(e) {}
            }
            if (order.notes) html += '<div class="detail"><span class="label">Event Notes:</span> ' + order.notes + '</div>';
            if (order.personal_notes) html += '<div class="detail"><span class="label">Personal Notes:</span> ' + order.personal_notes + '</div>';
            html += '<script>window.print(); window.close();<\/script></body></html>';
            printWindow.document.write(html);
            printWindow.document.close();
        }

        // Notes Functions
        let currentNotesItem = { type: '', id: 0, name: '' };

        async function openNotesModal(itemType, itemId, itemName) {
            currentNotesItem = { type: itemType, id: itemId, name: itemName };
            document.getElementById('notesModalTitle').textContent = `Notes - ${itemName}`;
            document.getElementById('newNoteText').value = '';
            await loadNotes();
            document.getElementById('notesModal').style.display = 'flex';
        }

        function closeNotesModal() {
            document.getElementById('notesModal').style.display = 'none';
        }

        async function loadNotes() {
            const response = await fetch(`/api/notes/${currentNotesItem.type}/${currentNotesItem.id}`);
            const notes = await response.json();
            
            const notesList = document.getElementById('notesList');
            if (notes.length === 0) {
                notesList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No notes yet</p>';
                return;
            }
            
            notesList.innerHTML = notes.map(note => {
                const date = new Date(note.created_at);
                const dateStr = date.toLocaleString();
                return `
                    <div style="background: var(--card-bg); padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid var(--orange);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <strong style="color: var(--orange);">${note.created_by || 'User'}</strong>
                                <span style="color: var(--text-secondary); font-size: 0.85em; margin-left: 10px;">${dateStr}</span>
                            </div>
                            <button onclick="deleteNote(${note.id})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2em;">&times;</button>
                        </div>
                        <div style="white-space: pre-wrap;">${note.note_text}</div>
                    </div>
                `;
            }).join('');
        }

        async function addNote() {
            const noteText = document.getElementById('newNoteText').value.trim();
            if (!noteText) return;
            
            const response = await fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    item_type: currentNotesItem.type,
                    item_id: currentNotesItem.id,
                    note_text: noteText,
                    created_by: currentUser?.name || currentUser?.username || 'User'
                })
            });
            
            if (response.ok) {
                document.getElementById('newNoteText').value = '';
                await loadNotes();
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            const response = await fetch(`/api/notes/${noteId}`, { method: 'DELETE' });
            if (response.ok) {
                await loadNotes();
            }
        }

    </script>
</body>
</html>